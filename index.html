<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Kasir Rafa Medica (V25.13 - Buku Kas Multi Expense)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 900: '#14532d' },
                        gold: { 100: '#fef9c3', 200: '#fef08a', 300: '#fde047', 400: '#facc15', 500: '#eab308', 600: '#ca8a04', 700: '#a16207' },
                        husna: { light: '#0ea5e9', dark: '#0284c7', bg: '#f0f9ff' },
                        night: { 800: '#1e293b', 900: '#0f172a' },
                        ketupat: { light: '#86efac', dark: '#15803d' }
                    },
                    fontFamily: { sans: ['Inter', 'Plus Jakarta Sans', 'sans-serif'], mono: ['Courier Prime', 'Courier New', 'monospace'] },
                    boxShadow: { 'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)', 'glow': '0 0 20px rgba(250, 204, 21, 0.4)' },
                    animation: {
                        'sway': 'sway 3s ease-in-out infinite alternate',
                        'sway-slow': 'sway 5s ease-in-out infinite alternate-reverse',
                        'swing': 'swing 3s ease-in-out infinite alternate',
                        'swing-slow': 'swing 4.5s ease-in-out infinite alternate',
                        'twinkle': 'twinkle 4s ease-in-out infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'float-up': 'floatUp 10s linear infinite',
                        'type-reveal': 'typeReveal 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'pop-in': 'popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'falling-star': 'fallingStar 4s linear infinite',
                    },
                    keyframes: {
                        sway: { from: { transform: 'rotate(-5deg)' }, to: { transform: 'rotate(5deg)' } },
                        swing: { '0%': { transform: 'rotate(-10deg)' }, '100%': { transform: 'rotate(10deg)' } },
                        typeReveal: { '0%': { width: '0%', opacity: '0' }, '100%': { width: '100%', opacity: '1' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.5)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        fallingStar: { '0%': { transform: 'translate(0, 0) rotate(35deg)', opacity: 0 }, '20%': { opacity: 1 }, '100%': { transform: 'translate(-200px, 200px) rotate(35deg)', opacity: 0 } },
                        floatUp: { '0%': { transform: 'translateY(100vh) scale(0.5)', opacity: 0 }, '20%': { opacity: 0.6 }, '80%': { opacity: 0.6 }, '100%': { transform: 'translateY(-10vh) scale(1)', opacity: 0 } }
                    }
                }
            }
        }
    </script>
    
    <!-- React & Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- HTML2Canvas (Untuk Generate JPG) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Amiri:wght@400;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <!-- Fuse.js -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>

    <!-- Firebase SDK (Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, writeBatch, query, orderBy, increment, limit, setDoc, getDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Baru: Rafa Medica (stok-barang-49c8e)
        const userConfig = {
            apiKey: "AIzaSyC8jXOyogDu_HIXVfjaVX7RhIc6kXiHdLk",
            authDomain: "stok-barang-49c8e.firebaseapp.com",
            projectId: "stok-barang-49c8e",
            storageBucket: "stok-barang-49c8e.firebasestorage.app",
            messagingSenderId: "1029640155610",
            appId: "1:1029640155610:web:d7db44abf2c3843cd110e3",
            measurementId: "G-12KTXQNRPP"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userConfig;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Expose ke window
        window.db = db;
        window.auth = auth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.collection = collection;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.serverTimestamp = serverTimestamp;
        window.writeBatch = writeBatch;
        window.query = query;
        window.orderBy = orderBy;
        window.increment = increment; 
        window.limit = limit;
        window.where = where;
        window.appId = appId;
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f9ff; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        
        /* Enhanced scrollbar for button row */
        .scrollbar-thin::-webkit-scrollbar { height: 4px; }
        .scrollbar-thumb-slate-300::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .scrollbar-thumb-slate-400:hover::-webkit-scrollbar-thumb { background: #94a3b8; }
        .scrollbar-track-transparent::-webkit-scrollbar-track { background: transparent; }
        
        /* Smooth scrolling behavior */
        .overflow-x-auto { scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-left { animation: slideLeft 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideLeft { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        .typing-dot { height: 6px; width: 6px; background-color: #0ea5e9; border-radius: 50%; display: inline-block; animation: typing 1.4s infinite ease-in-out both; margin: 0 2px; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.05); }
        
        /* Ramadhan Decorations Animations */
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .islamic-pattern {
            background-color: #f0f9ff;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%230ea5e9' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .font-arab { font-family: 'Amiri', serif; }

        /* Ketupat Style */
        .ketupat { width: 30px; height: 30px; background-color: #86efac; border: 2px solid #15803d; transform: rotate(45deg); position: relative; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .ketupat::before, .ketupat::after { content: ''; position: absolute; background-color: #22c55e; opacity: 0.3; }
        .ketupat::before { width: 100%; height: 50%; top: 0; left: 0; border-bottom: 1px solid #15803d; }
        .ketupat::after { width: 50%; height: 100%; top: 0; left: 0; border-right: 1px solid #15803d; }

        /* FIREWORKS STYLE */
        .firework-particle { position: fixed; pointer-events: none; border-radius: 50%; z-index: 9999; animation: firework-fade 0.8s ease-out forwards; }
        @keyframes firework-fade { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(0); opacity: 0; } }
        .type-effect-wrapper { display: inline-block; overflow: hidden; white-space: nowrap; vertical-align: bottom; max-width: 0; animation: revealText 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        @keyframes revealText { 0% { max-width: 0; opacity: 0; } 100% { max-width: 100%; opacity: 1; } }
        
        /* Checkmark Animation */
        .checkmark-circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 2; stroke-miterlimit: 10; stroke: #22c55e; fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .checkmark { width: 56px; height: 56px; border-radius: 50%; display: block; stroke-width: 2; stroke: #fff; stroke-miterlimit: 10; margin: 10% auto; box-shadow: inset 0px 0px 0px #22c55e; animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both; }
        .checkmark__check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
        @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 30px #22c55e; } }
    </style>
</head>
<body class="islamic-pattern relative">
    <div id="root" class="relative z-10"></div>

    <!-- React App (Babel) -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const APP_NAME = "Rafa Medica";
        
        // --- GLOBAL LOGGING UTILITY ---
        const logToDB = async (type, message, storeId, userEmail) => {
            try {
                await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'activity_logs'), {
                    type: type, // 'TRANSAKSI', 'STOK', 'TRANSFER', 'SYSTEM', 'RETUR', 'KEUANGAN'
                    message: message,
                    storeId: storeId || 'unknown',
                    user: userEmail || 'Anonim',
                    createdAt: window.serverTimestamp()
                });
            } catch (error) {
                console.error("Gagal mencatat log:", error);
            }
        };

        // --- DEFAULT SETTINGS ---
        const DEFAULT_SETTINGS = {
            lowStockThreshold: 5,
            showExtraFeatures: false, // DEFAULT HIDDEN (False)
            storeName: APP_NAME, 
            storeAddress: "Indonesia", 
            receiptFooter: "Terima Kasih\nBarang tidak dapat ditukar", 
            storeProfiles: [
                { 
                    id: 'default', 
                    name: APP_NAME, 
                    address: "Indonesia",
                    footer: "Terima Kasih\nBarang tidak dapat ditukar",
                    additionalHeaders: []
                }
            ]
        };

        // --- BLUETOOTH PRINTER HELPERS ---
        const ESC = "\u001B";
        const GS = "\u001D";
        const INIT = ESC + "@";
        const CODE_PAGE = ESC + "t" + "\u0000"; 
        const ALIGN_CENTER = ESC + "a" + "\u0001";
        const ALIGN_LEFT = ESC + "a" + "\u0000";
        const ALIGN_RIGHT = ESC + "a" + "\u0002";
        const BOLD_ON = ESC + "E" + "\u0001";
        const BOLD_OFF = ESC + "E" + "\u0000";
        const CUT = GS + "V" + "\u0042" + "\u0000";
        
        class ThermalPrinterEncoder {
            constructor() { this.buffer = []; }
            init() { this.buffer.push(INIT); this.buffer.push(CODE_PAGE); return this; }
            alignCenter() { this.buffer.push(ALIGN_CENTER); return this; }
            alignLeft() { this.buffer.push(ALIGN_LEFT); return this; }
            alignRight() { this.buffer.push(ALIGN_RIGHT); return this; }
            bold(on = true) { this.buffer.push(on ? BOLD_ON : BOLD_OFF); return this; }
            text(str) { 
                if(!str) return this;
                let clean = str.replace(/[^\x20-\x7E\n]/g, "");
                this.buffer.push(clean); 
                return this; 
            }
            newline() { this.buffer.push("\n"); return this; }
            line(char = "-") { this.buffer.push(char.repeat(32)); this.buffer.push("\n"); return this; }
            feed(n = 2) { for(let i=0; i<n; i++) this.buffer.push("\n"); return this; }
            encode() { const combined = this.buffer.join(""); const encoder = new TextEncoder(); return encoder.encode(combined); }
        }

        // --- FIREWORKS UTILITY ---
        const triggerFireworks = (x, y) => {
            const colors = ['#0ea5e9', '#eab308', '#3b82f6', '#0284c7', '#22c55e', '#facc15'];
            const particleCount = 12; 
            for (let i = 0; i < particleCount; i++) {
                const el = document.createElement('div');
                el.classList.add('firework-particle');
                const color = colors[Math.floor(Math.random() * colors.length)];
                const size = Math.random() * 5 + 3; 
                el.style.backgroundColor = color;
                el.style.width = `${size}px`;
                el.style.height = `${size}px`;
                el.style.left = `${x}px`;
                el.style.top = `${y}px`;
                document.body.appendChild(el);
                let posX = x, posY = y, velX = Math.cos(Math.random() * Math.PI * 2) * (Math.random() * 3 + 1.5), velY = Math.sin(Math.random() * Math.PI * 2) * (Math.random() * 3 + 1.5), gravity = 0.1, opacity = 1;
                const animate = () => {
                    velY += gravity; posX += velX; posY += velY; opacity -= 0.03; 
                    el.style.left = `${posX}px`; el.style.top = `${posY}px`; el.style.opacity = opacity;
                    if (opacity > 0) requestAnimationFrame(animate); else el.remove();
                };
                requestAnimationFrame(animate);
            }
        };

        const Icon = React.memo(({ name, type = "solid", className = "" }) => <i className={`fa-${type} fa-${name} ${className}`}></i>);

        // --- DEKORASI RAMADHAN ---
        const RamadhanDecor = () => (
            <div className="fixed inset-0 pointer-events-none z-0 overflow-hidden">
                <div className="absolute inset-0 z-0">
                    {[...Array(10)].map((_, i) => (
                        <div key={i} className="absolute rounded-full bg-gold-300 opacity-0 animate-float-up" 
                             style={{
                                 width: Math.random() * 4 + 2 + 'px',
                                 height: Math.random() * 4 + 2 + 'px',
                                 left: Math.random() * 100 + '%',
                                 animationDelay: Math.random() * 10 + 's',
                                 animationDuration: Math.random() * 10 + 10 + 's'
                             }}></div>
                    ))}
                </div>
                <div className="absolute top-10 left-[10%] text-gold-400 text-[10px] animate-twinkle delay-100 opacity-60"><Icon name="star" /></div>
                <div className="absolute top-32 left-[40%] text-gold-300 text-[8px] animate-twinkle delay-700 opacity-40"><Icon name="star" /></div>
                <div className="absolute top-5 right-[15%] text-gold-500 text-[12px] animate-twinkle delay-300 opacity-70"><Icon name="star" /></div>
                <div className="absolute -top-10 right-10 w-20 h-0.5 bg-gradient-to-l from-transparent to-white opacity-40 animate-falling-star"></div>
                
                <div className="absolute -top-6 left-2 md:left-8 z-0 animate-swing origin-top duration-[3500ms]">
                    <div className="h-24 md:h-40 w-[1px] bg-gold-400/60 mx-auto"></div>
                    <div className="text-gold-500 text-4xl md:text-6xl drop-shadow-glow relative z-10"><Icon name="mosque" /></div>
                </div>

                <div className="absolute -top-10 left-20 md:left-32 z-0 animate-sway-slow origin-top duration-[5000ms]">
                    <div className="h-32 md:h-48 w-[1px] bg-gold-400/40 mx-auto"></div>
                    <div className="ketupat mx-auto shadow-lg"></div>
                    <div className="h-4 w-[1px] bg-gold-400/40 mx-auto"></div>
                    <div className="text-green-600 text-[10px] text-center"><Icon name="leaf" /></div>
                </div>

                <div className="absolute -top-12 left-[30%] hidden md:block z-0 animate-swing-slow origin-top duration-[4500ms]">
                    <div className="h-20 w-[1px] bg-gold-400/40 mx-auto"></div>
                    <div className="text-red-500 text-2xl drop-shadow-md"><Icon name="lightbulb" /></div>
                </div>

                <div className="absolute -top-8 right-4 md:right-12 z-0 animate-swing origin-top duration-[4000ms]">
                    <div className="h-20 md:h-32 w-[1px] bg-gold-400/60 mx-auto"></div>
                    <div className="text-gold-500 text-4xl md:text-6xl drop-shadow-glow relative z-10"><Icon name="star-and-crescent" /></div>
                </div>

                <div className="absolute -top-14 right-20 md:right-40 z-0 animate-sway origin-top duration-[5500ms]">
                    <div className="h-28 md:h-44 w-[1px] bg-gold-400/40 mx-auto"></div>
                    <div className="ketupat mx-auto shadow-lg bg-green-200 border-green-600"></div>
                </div>

                <div className="absolute bottom-0 left-0 right-0 h-32 opacity-10 pointer-events-none flex items-end justify-center overflow-hidden">
                    <div className="text-slate-800 text-[150px] md:text-[200px] leading-none -mb-10"><Icon name="mosque" /></div>
                    <div className="text-slate-800 text-[100px] md:text-[140px] leading-none -mb-8 -ml-10"><Icon name="mosque" /></div>
                    <div className="text-slate-800 text-[100px] md:text-[140px] leading-none -mb-8 -mr-10 order-first"><Icon name="mosque" /></div>
                </div>
            </div>
        );

        // --- UTILS ---
        const safeNumber = (val) => { if (!val) return 0; const num = parseFloat(val); return isNaN(num) ? 0 : num; };
        const formatRupiah = (angka) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(safeNumber(angka)).replace(/,00$/, '');
        const isNewItem = (createdAt) => {
            if (!createdAt) return false;
            const date = createdAt.toDate ? createdAt.toDate() : new Date(createdAt);
            return (new Date() - date) < (24 * 60 * 60 * 1000);
        };
        const formatDateIndo = (dateStr) => { if (!dateStr) return "-"; return new Date(dateStr).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: '2-digit' }); };
        
        // UTILS DATE FULL (Hari, Tanggal) - DITAMBAHKAN
        const formatDateFull = (dateStr) => {
            if (!dateStr) return "-";
            const d = new Date(dateStr);
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];
            return `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
        };

        const getDaysRemaining = (dateStr) => { if (!dateStr) return null; const today = new Date(); today.setHours(0,0,0,0); const exp = new Date(dateStr); exp.setHours(0,0,0,0); return Math.ceil((exp - today) / (1000 * 60 * 60 * 24)); };

        const Toast = ({ message, show, onClose, type = "success" }) => {
            if (!show) return null;
            const bgClass = type === "error" ? "bg-red-500" : "bg-slate-800";
            const iconName = type === "error" ? "circle-xmark" : "circle-check";
            return (
                <div className={`fixed bottom-10 left-1/2 -translate-x-1/2 z-[110] ${bgClass} text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 fade-in animate-bounce border-2 border-white/10`}>
                    <Icon name={iconName} className={type === "error" ? "text-white" : "text-brand-400"} />
                    <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "Ya, Hapus", confirmColor = "red", children }) => {
            if (!isOpen) return null;
            const btnColorClass = confirmColor === "red" ? "bg-red-500 hover:bg-red-600 shadow-red-200" : "bg-blue-600 hover:bg-blue-700 shadow-blue-200";
            const iconBg = confirmColor === "red" ? "bg-red-50 text-red-500" : "bg-blue-50 text-blue-500";
            const iconName = confirmColor === "red" ? "trash-can" : "check";
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm fade-in">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100 border border-gold-100">
                        <div className={`w-14 h-14 ${iconBg} rounded-full flex items-center justify-center mb-5 mx-auto`}><Icon name={iconName} className="text-2xl" /></div>
                        <h3 className="text-xl font-bold text-center text-slate-800 mb-2">{title}</h3>
                        <p className="text-slate-500 text-center text-sm mb-4 leading-relaxed">{message}</p>
                        {children && <div className="mb-6">{children}</div>}
                        <div className="flex gap-3 mt-4">
                            <button onClick={onCancel} className="flex-1 py-3 rounded-xl border border-slate-200 text-slate-600 font-semibold text-sm hover:bg-slate-50 transition-colors">Batal</button>
                            <button onClick={onConfirm} className={`flex-1 py-3 rounded-xl ${btnColorClass} text-white font-semibold text-sm shadow-lg active:scale-95 transition-all`}>{confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- NOTIFICATION CENTER COMPONENT (DIPISAH PER TOKO) ---
        const NotificationCenter = ({ isOpen, onClose, user, currentProfile }) => {
            const [logs, setLogs] = useState([]);
            const [filterDate, setFilterDate] = useState('');
            const [filterType, setFilterType] = useState('ALL'); // ALL, TRANSAKSI, STOK, TRANSFER, RETUR
            
            useEffect(() => {
                if (!user || !isOpen) return;

                // Query last 200 logs globally to ensure we have enough data to filter
                // Filtering client-side to avoid "missing index" errors for end users
                const q = window.query(
                    window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'activity_logs'),
                    window.orderBy('createdAt', 'desc'),
                    window.limit(200)
                );
                
                const unsub = window.onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // FILTER PER TOKO (CLIENT SIDE)
                    let storeLogs = data;
                    if (currentProfile && currentProfile.id !== 'all_stores') {
                        storeLogs = data.filter(log => log.storeId === currentProfile.id);
                    }

                    setLogs(storeLogs);
                });
                
                return () => unsub();
            }, [user, isOpen, currentProfile]); // Re-run when profile changes

            const filteredLogs = useMemo(() => {
                return logs.filter(log => {
                    let matchesDate = true;
                    if (filterDate) {
                        const logDate = log.createdAt?.toDate ? log.createdAt.toDate() : new Date(log.createdAt);
                        const filterD = new Date(filterDate);
                        matchesDate = logDate.getDate() === filterD.getDate() && 
                                      logDate.getMonth() === filterD.getMonth() && 
                                      logDate.getFullYear() === filterD.getFullYear();
                    }
                    
                    let matchesType = true;
                    if (filterType !== 'ALL') {
                        matchesType = log.type === filterType;
                    }
                    
                    return matchesDate && matchesType;
                });
            }, [logs, filterDate, filterType]);

            const getIconForType = (type) => {
                switch(type) {
                    case 'TRANSAKSI': return 'cart-shopping text-green-500 bg-green-50';
                    case 'STOK': return 'box-open text-sky-500 bg-sky-50';
                    case 'TRANSFER': return 'arrow-right-arrow-left text-indigo-500 bg-indigo-50';
                    case 'RETUR': return 'rotate-left text-amber-500 bg-amber-50';
                    case 'HAPUS': return 'trash text-red-500 bg-red-50';
                    case 'KEUANGAN': return 'wallet text-purple-500 bg-purple-50';
                    default: return 'bell text-slate-500 bg-slate-50';
                }
            };

            return (
                <div className={`fixed inset-y-0 right-0 z-[150] w-full md:w-96 bg-white shadow-2xl transform transition-transform duration-300 ease-in-out ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                    <div className="flex flex-col h-full">
                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <div>
                                <h3 className="font-bold text-slate-800 text-lg flex items-center gap-2">
                                    <Icon name="bell" className="text-sky-600" /> Aktivitas
                                </h3>
                                <p className="text-[10px] text-slate-400 font-bold uppercase mt-1">
                                    {currentProfile?.id === 'all_stores' ? 'Semua Cabang' : currentProfile?.name}
                                </p>
                            </div>
                            <button onClick={onClose} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 text-slate-500">
                                <Icon name="xmark" />
                            </button>
                        </div>
                        
                        <div className="p-4 bg-white border-b border-slate-100 space-y-2">
                            <div className="flex gap-2">
                                <input type="date" className="flex-1 p-2 border border-slate-200 rounded-lg text-xs font-bold" value={filterDate} onChange={e => setFilterDate(e.target.value)} />
                                <button onClick={() => { setFilterDate(''); setFilterType('ALL'); }} className="px-3 py-2 bg-slate-100 text-slate-500 rounded-lg text-xs font-bold hover:bg-slate-200">Reset</button>
                            </div>
                            <div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                                {['ALL', 'TRANSAKSI', 'STOK', 'KEUANGAN', 'TRANSFER', 'RETUR'].map(type => (
                                    <button 
                                        key={type} 
                                        onClick={() => setFilterType(type)}
                                        className={`px-3 py-1.5 rounded-full text-[10px] font-bold whitespace-nowrap border transition-all ${filterType === type ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200'}`}
                                    >
                                        {type === 'ALL' ? 'Semua' : type}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto custom-scrollbar p-2">
                            {filteredLogs.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-slate-400 opacity-60">
                                    <Icon name="clipboard-list" className="text-4xl mb-2" />
                                    <p className="text-xs">Tidak ada aktivitas tercatat.</p>
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    {filteredLogs.map(log => {
                                        const iconClass = getIconForType(log.type);
                                        const date = log.createdAt?.toDate ? log.createdAt.toDate() : new Date(log.createdAt);
                                        return (
                                            <div key={log.id} className="p-3 bg-white border border-slate-100 rounded-xl hover:shadow-sm transition-all flex gap-3">
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${iconClass}`}>
                                                    <Icon name={iconClass.split(' ')[0]} />
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <p className="text-xs font-bold text-slate-800 line-clamp-2">{log.message}</p>
                                                    <div className="flex justify-between items-center mt-1">
                                                        <span className="text-[10px] text-slate-400">{date.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})} • {date.toLocaleDateString('id-ID')}</span>
                                                        <span className="text-[9px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 font-medium truncate max-w-[80px]">{log.user.split('@')[0]}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- HELPERS FOR PRINTER (GLOBAL) ---
        const connectBluetooth = async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }] });
                const server = await device.gatt.connect();
                return device;
            } catch (error) { console.error(error); return null; }
        };

        const printReceipt = async (receipt, device, settings = DEFAULT_SETTINGS) => {
            if (!device || !device.gatt.connected) { device = await connectBluetooth(); if (!device) return false; }
            try {
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
                const encoder = new ThermalPrinterEncoder();
                
                const storeName = settings.storeName || APP_NAME;
                const storeAddr = settings.storeAddress || "Indonesia";
                const footerText = settings.receiptFooter || "Terima Kasih\nBarang tidak dapat ditukar";
                const headers = settings.additionalHeaders || [];

                encoder.init().alignCenter().bold(true).text(storeName).newline().bold(false).text(storeAddr).newline();
                
                if (settings.storeHeader3 && (!headers.length)) { encoder.text(settings.storeHeader3).newline(); }
                headers.forEach(h => { if(h && h.trim()) encoder.text(h).newline(); });
                
                encoder.line().alignLeft().text(`Tgl: ${new Date(receipt.date.seconds ? receipt.date.toDate() : receipt.date).toLocaleString('id-ID')}`).newline();
                if (receipt.cashierName) {
                    encoder.text(`Kasir: ${receipt.cashierName}`).newline();
                }
                encoder.line();
                receipt.items.forEach(item => {
                    const validQty = item.cartQty - (item.returnedQty || 0);
                    if (validQty > 0) {
                        encoder.text(item.name).newline();
                        const qtyPrice = `${validQty} x ${formatRupiah(item.price).replace('Rp', '')}`;
                        const subTotal = formatRupiah(item.price * validQty).replace('Rp', '');
                        const spaces = 32 - qtyPrice.length - subTotal.length;
                        encoder.text(qtyPrice + " ".repeat(Math.max(1, spaces)) + subTotal).newline();
                    }
                });
                const validTotal = receipt.items.reduce((acc, item) => acc + (item.price * (item.cartQty - (item.returnedQty || 0))), 0);
                encoder.line();
                const printRow = (label, value) => { const valStr = formatRupiah(value).replace('Rp', ''); const spaces = 32 - label.length - valStr.length; encoder.text(label + " ".repeat(Math.max(1, spaces)) + valStr).newline(); };
                encoder.bold(true); printRow("TOTAL", validTotal); encoder.bold(false);
                if (receipt.pay !== undefined && receipt.change !== undefined) { printRow("TUNAI", receipt.pay); printRow("KEMBALI", receipt.change); }
                encoder.feed(2).alignCenter().bold(false);
                
                const footerLines = footerText.split('\n');
                footerLines.forEach(line => { if(line && line.trim() !== "") { encoder.text(line.trim()).newline(); } });
                
                if (receipt.status === 'returned' || receipt.status === 'partial') { encoder.text(receipt.status === 'returned' ? "RETUR FULL" : "ADA RETUR SEBAGIAN").newline(); }
                encoder.feed(3);
                const encodedData = encoder.encode();
                const MAX_CHUNK_SIZE = 50; 
                for (let i = 0; i < encodedData.length; i += MAX_CHUNK_SIZE) { const chunk = encodedData.slice(i, i + MAX_CHUNK_SIZE); await characteristic.writeValue(chunk); await new Promise(r => setTimeout(r, 40)); }
                return true;
            } catch (error) { console.error("Print Error", error); return false; }
        };

        const SettingsView = ({ settings, onSave, loading }) => {
            const [localSettings, setLocalSettings] = useState(settings);
            const [profiles, setProfiles] = useState(() => settings.storeProfiles || [{ id: 'default', name: settings.storeName || APP_NAME, address: settings.storeAddress || '', footer: settings.receiptFooter, additionalHeaders: settings.additionalHeaders || [] }]);
            const [selectedProfileId, setSelectedProfileId] = useState(profiles[0]?.id || 'default');
            const activeProfile = profiles.find(p => p.id === selectedProfileId) || profiles[0];
            const [isAddingStore, setIsAddingStore] = useState(false);
            const [newStoreName, setNewStoreName] = useState("");
            const [showResetModal, setShowResetModal] = useState(false);
            const [resetInput, setResetInput] = useState("");
            const [isResetting, setIsResetting] = useState(false);
            const [showResetStockModal, setShowResetStockModal] = useState(false);
            const [selectedStoreForReset, setSelectedStoreForReset] = useState('');
            const [isResettingStock, setIsResettingStock] = useState(false);

            useEffect(() => { 
                setLocalSettings(settings); 
                if(settings.storeProfiles) {
                    const enhancedProfiles = settings.storeProfiles.map(p => ({
                        ...p,
                        footer: p.footer || settings.receiptFooter || "Terima Kasih\nBarang tidak dapat ditukar",
                        additionalHeaders: p.additionalHeaders || []
                    }));
                    setProfiles(enhancedProfiles);
                }
            }, [settings]);
            
            const updateProfile = (id, field, value) => { const updatedProfiles = profiles.map(p => { if (p.id === id) return { ...p, [field]: value }; return p; }); setProfiles(updatedProfiles); };
            const handleHeaderChange = (profileId, idx, val) => { const profile = profiles.find(p => p.id === profileId); const newHeaders = [...(profile.additionalHeaders || [])]; newHeaders[idx] = val; updateProfile(profileId, 'additionalHeaders', newHeaders); };
            const addHeader = (profileId) => { const profile = profiles.find(p => p.id === profileId); const newHeaders = [...(profile.additionalHeaders || []), ""]; updateProfile(profileId, 'additionalHeaders', newHeaders); };
            const removeHeader = (profileId, idx) => { const profile = profiles.find(p => p.id === profileId); const newHeaders = (profile.additionalHeaders || []).filter((_, i) => i !== idx); updateProfile(profileId, 'additionalHeaders', newHeaders); };
            const handleAddNewStore = () => { if (!newStoreName.trim()) return; const newId = 'store_' + Date.now(); const newProfile = { id: newId, name: newStoreName, address: "Indonesia", footer: "Terima Kasih", additionalHeaders: [] }; setProfiles([...profiles, newProfile]); setNewStoreName(""); setIsAddingStore(false); setSelectedProfileId(newId); };
            const removeProfile = (id) => { if (profiles.length <= 1) { alert("Minimal harus ada 1 profil toko."); return; } if (!confirm("Hapus toko ini? Data stok mungkin masih tersimpan tapi tidak bisa diakses.")) return; const newProfiles = profiles.filter(p => p.id !== id); setProfiles(newProfiles); if (selectedProfileId === id) setSelectedProfileId(newProfiles[0].id); };
            const handleSave = () => { const mainProfile = profiles[0]; onSave({ ...localSettings, storeName: mainProfile.name, storeAddress: mainProfile.address, receiptFooter: mainProfile.footer, additionalHeaders: mainProfile.additionalHeaders, storeProfiles: profiles }); };
            
            const handleResetStock = async () => {
                if (!selectedStoreForReset) {
                    alert("Pilih toko yang akan direset stoknya!");
                    return;
                }
                
                if (!confirm(`PERINGATAN: Semua stok di "${profiles.find(p => p.id === selectedStoreForReset)?.name}" akan diubah menjadi 0. Lanjutkan?`)) {
                    return;
                }
                
                setIsResettingStock(true);
                try {
                    const batch = window.writeBatch(window.db);
                    const inventoryRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory');
                    const snapshot = await window.getDocs(inventoryRef);
                    
                    snapshot.docs.forEach(doc => {
                        const stockUpdate = {
                            [`stocks.${selectedStoreForReset}`]: 0,
                            updatedAt: window.serverTimestamp()
                        };
                        
                        if (selectedStoreForReset === 'default') {
                            stockUpdate.qty = 0;
                        }
                        
                        batch.update(doc.ref, stockUpdate);
                    });
                    
                    await batch.commit();
                    
                    const storeName = profiles.find(p => p.id === selectedStoreForReset)?.name;
                    await logToDB('STOK', `Reset semua stok menjadi 0 untuk ${storeName} (${snapshot.docs.length} item)`, selectedStoreForReset, 'admin');
                    
                    alert(`Berhasil! ${snapshot.docs.length} item direset menjadi stok 0.`);
                    setShowResetStockModal(false);
                    setSelectedStoreForReset('');
                } catch (error) {
                    console.error("Reset stock error:", error);
                    alert("Gagal mereset stok. Silakan coba lagi.");
                } finally {
                    setIsResettingStock(false);
                }
            };
            
            const handleResetDatabase = async () => { if (resetInput !== 'RESET') { alert("Mohon ketik kata RESET dengan benar."); return; } if(!confirm("PERINGATAN TERAKHIR: Apakah Anda yakin? Semua data stok dan transaksi akan HILANG SELAMANYA.")) return; setIsResetting(true); const collectionsToClear = ['inventory', 'transactions', 'purchases', 'suppliers', 'pending_carts', 'activity_logs', 'cashflow']; try { let totalDeleted = 0; for (const colName of collectionsToClear) { const colRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', colName); const snapshot = await window.getDocs(colRef); const batch = window.writeBatch(window.db); snapshot.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit(); totalDeleted += snapshot.docs.length; } alert(`Database Berhasil Direset! ${totalDeleted} dokumen dihapus.`); setShowResetModal(false); setResetInput(""); window.location.reload(); } catch (error) { console.error("Reset Error:", error); alert("Gagal mereset database."); } finally { setIsResetting(false); } };

            return (
                 <div className="fade-in max-w-4xl mx-auto w-full pt-4 md:pt-10 pb-20">
                    <div className="bg-white/90 backdrop-blur-sm p-6 rounded-[30px] shadow-soft border border-white">
                        <header className="mb-6 flex items-center gap-4 border-b border-slate-100 pb-4">
                            <div className="w-12 h-12 bg-slate-800 text-white rounded-2xl flex items-center justify-center text-xl shadow-sm"><Icon name="gears" /></div>
                            <div><h2 className="text-xl font-bold text-slate-800">Pengaturan Toko & Struk</h2><p className="text-xs text-slate-400">Atur profil cabang dan format cetak masing-masing</p></div>
                        </header>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="md:col-span-1 space-y-3">
                                {/* TOGGLE FITUR TAMBAHAN */}
                                <div className="bg-white p-4 rounded-xl border border-slate-200 mb-4 shadow-sm">
                                    <h3 className="font-bold text-slate-700 text-sm mb-2">Tampilan Menu</h3>
                                    <div className="flex items-center justify-between">
                                        <div className="pr-2">
                                            <p className="text-xs font-bold text-slate-800">Mode Kasir & Keuangan</p>
                                            <p className="text-[10px] text-slate-500">Munculkan menu Kasir, Riwayat & Faktur</p>
                                        </div>
                                        <label className="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" checked={localSettings.showExtraFeatures || false} onChange={e => setLocalSettings({...localSettings, showExtraFeatures: e.target.checked})} className="sr-only peer" />
                                            <div className="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-600"></div>
                                        </label>
                                    </div>
                                </div>

                                <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-slate-700 text-sm">Daftar Toko</h3><button onClick={() => setIsAddingStore(true)} className="text-[10px] bg-sky-50 text-sky-600 px-2 py-1 rounded-lg font-bold border border-sky-100 hover:bg-sky-100">+ Tambah</button></div>
                                {isAddingStore && (<div className="p-3 bg-sky-50 rounded-xl border border-sky-200 mb-2 animate-slide-up"><label className="text-[10px] font-bold text-sky-700 block mb-1">Nama Toko Baru</label><input autoFocus type="text" value={newStoreName} onChange={e => setNewStoreName(e.target.value)} className="w-full p-2 text-xs border border-sky-200 rounded-lg mb-2 focus:ring-2 focus:ring-sky-400 outline-none" placeholder="Cabang Baru..." /><div className="flex gap-2"><button onClick={() => setIsAddingStore(false)} className="flex-1 py-1.5 bg-white border border-slate-200 text-slate-500 text-[10px] font-bold rounded-lg">Batal</button><button onClick={handleAddNewStore} disabled={!newStoreName} className="flex-1 py-1.5 bg-sky-600 text-white text-[10px] font-bold rounded-lg shadow-sm disabled:opacity-50">Simpan</button></div></div>)}
                                <div className="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar pr-1">{profiles.map(p => (<button key={p.id} onClick={() => setSelectedProfileId(p.id)} className={`w-full text-left p-3 rounded-xl border transition-all relative group ${selectedProfileId === p.id ? 'bg-slate-800 text-white border-slate-800 shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300'}`}><div className="font-bold text-sm truncate pr-6">{p.name}</div><div className={`text-[10px] truncate ${selectedProfileId === p.id ? 'text-slate-400' : 'text-slate-400'}`}>{p.address || 'Belum ada alamat'}</div>{selectedProfileId === p.id && <div className="absolute top-1/2 -translate-y-1/2 right-3 w-2 h-2 rounded-full bg-brand-500 shadow-[0_0_10px_rgba(34,197,94,0.6)]"></div>}</button>))}</div>
                                <div className="pt-4 border-t border-slate-100 mt-4"><h3 className="font-bold text-slate-700 text-xs mb-2">Global Settings</h3><div className="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-200"><span className="text-xs font-bold text-slate-500">Low Stock Limit</span><input type="number" value={localSettings.lowStockThreshold} onChange={(e) => setLocalSettings({ ...localSettings, lowStockThreshold: parseInt(e.target.value) || 0 })} className="w-16 p-1 text-center text-xs font-bold border border-slate-300 rounded focus:border-sky-500 outline-none" /></div></div>
                                <div className="pt-4 border-t border-slate-100"><h3 className="font-bold text-red-700 text-xs mb-2 uppercase tracking-wide">⚠️ Danger Zone</h3><button onClick={() => setShowResetStockModal(true)} className="w-full py-2 bg-amber-50 text-amber-700 border border-amber-200 rounded-lg text-xs font-bold hover:bg-amber-100 flex items-center justify-center gap-2 mb-2"><Icon name="rotate-left" /> Reset Stok Toko</button><button onClick={() => setShowResetModal(true)} className="w-full py-2 bg-red-50 text-red-600 border border-red-100 rounded-lg text-xs font-bold hover:bg-red-100 flex items-center justify-center gap-2"><Icon name="trash" /> Reset Database Total</button></div>
                            </div>
                            <div className="md:col-span-2">
                                {activeProfile ? (<div className="bg-slate-50 border border-slate-200 rounded-2xl p-5 h-full relative"><div className="flex justify-between items-start mb-4"><h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="store" className="text-sky-600" /> Edit Profil: {activeProfile.name}</h3>{profiles.length > 1 && (<button onClick={() => removeProfile(activeProfile.id)} className="text-[10px] text-red-500 font-bold hover:underline flex items-center gap-1"><Icon name="trash" /> Hapus Toko Ini</button>)}</div><div className="space-y-4"><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Nama Toko (Judul Struk)</label><input type="text" value={activeProfile.name} onChange={(e) => updateProfile(activeProfile.id, 'name', e.target.value)} className="w-full p-2.5 rounded-lg border border-slate-300 focus:border-sky-500 outline-none text-sm font-bold" /></div><div><label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Alamat / Sub-judul</label><input type="text" value={activeProfile.address} onChange={(e) => updateProfile(activeProfile.id, 'address', e.target.value)} className="w-full p-2.5 rounded-lg border border-slate-300 focus:border-sky-500 outline-none text-sm" /></div></div><div className="bg-white p-3 rounded-xl border border-slate-200"><div className="flex justify-between items-center mb-2"><label className="text-[10px] font-bold text-slate-500 uppercase">Header Tambahan (Opsional)</label><button onClick={() => addHeader(activeProfile.id)} className="text-[10px] font-bold text-sky-600 bg-sky-50 px-2 py-1 rounded border border-sky-100 hover:bg-sky-100">+ Baris</button></div><div className="space-y-2">{(!activeProfile.additionalHeaders || activeProfile.additionalHeaders.length === 0) && <p className="text-[10px] text-slate-400 italic">Tidak ada header tambahan (No. Telp, IG, dll).</p>}{(activeProfile.additionalHeaders || []).map((h, idx) => (<div key={idx} className="flex gap-2"><input type="text" value={h} onChange={(e) => handleHeaderChange(activeProfile.id, idx, e.target.value)} className="flex-1 p-2 rounded-lg border border-slate-300 focus:border-sky-500 outline-none text-xs" placeholder={`Info Tambahan ${idx + 1}`} /><button onClick={() => removeHeader(activeProfile.id, idx)} className="w-8 bg-red-50 text-red-500 rounded-lg border border-red-100 hover:bg-red-100 flex items-center justify-center"><Icon name="xmark" /></button></div>))}</div></div><div><label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Footer Struk (Pesan Bawah)</label><textarea value={activeProfile.footer || ''} onChange={(e) => updateProfile(activeProfile.id, 'footer', e.target.value)} className="w-full p-2.5 rounded-lg border border-slate-300 focus:border-sky-500 outline-none text-sm h-20 resize-none font-mono text-xs" placeholder="Terima Kasih..."></textarea></div></div></div>) : (<div className="h-full flex items-center justify-center text-slate-400 text-sm italic border border-dashed border-slate-300 rounded-2xl bg-slate-50">Pilih toko di sebelah kiri untuk mengedit.</div>)}
                            </div>
                        </div>
                        <div className="mt-6 pt-6 border-t border-slate-100"><button onClick={handleSave} disabled={loading} className="w-full py-4 bg-slate-800 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 hover:bg-slate-900">{loading ? <div className="typing-dot bg-white"></div> : <Icon name="floppy-disk" />} Simpan Semua Pengaturan</button></div>
                    </div>
                    
                    {/* Reset Stock Modal */}
                    {showResetStockModal && (
                        <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-amber-900/60 backdrop-blur-sm fade-in">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100 border-2 border-amber-400">
                                <div className="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4 text-amber-600 text-3xl">
                                    <Icon name="rotate-left" />
                                </div>
                                <h3 className="text-xl font-black text-center text-amber-800 mb-2 uppercase tracking-tight">Reset Stok Toko</h3>
                                <p className="text-center text-sm text-slate-600 mb-4">Semua stok di toko yang dipilih akan menjadi 0.</p>
                                <div className="bg-amber-50 p-3 rounded-lg border border-amber-200 mb-4">
                                    <label className="text-[10px] font-bold text-amber-700 uppercase block mb-2">Pilih Toko</label>
                                    <select 
                                        value={selectedStoreForReset} 
                                        onChange={e => setSelectedStoreForReset(e.target.value)}
                                        className="w-full p-2.5 text-sm font-bold border-2 border-amber-300 rounded focus:border-amber-600 outline-none"
                                    >
                                        <option value="">-- Pilih Toko --</option>
                                        {profiles.map(p => (
                                            <option key={p.id} value={p.id}>{p.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => { setShowResetStockModal(false); setSelectedStoreForReset(''); }} className="flex-1 py-3 rounded-xl border border-slate-300 text-slate-600 font-bold text-sm hover:bg-slate-50">
                                        Batal
                                    </button>
                                    <button onClick={handleResetStock} disabled={isResettingStock || !selectedStoreForReset} className="flex-1 py-3 rounded-xl bg-amber-600 text-white font-bold text-sm shadow-lg hover:bg-amber-700 disabled:opacity-50 flex justify-center items-center gap-2">
                                        {isResettingStock ? <div className="typing-dot bg-white"></div> : 'RESET'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showResetModal && (<div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-red-900/80 backdrop-blur-sm fade-in"><div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100 border-2 border-red-500"><div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 text-3xl"><Icon name="skull" /></div><h3 className="text-xl font-black text-center text-red-700 mb-2 uppercase tracking-tight">Hapus Total Database?</h3><p className="text-center text-sm text-slate-600 mb-4">Semua stok dan transaksi akan dihapus.</p><div className="bg-red-50 p-3 rounded-lg border border-red-200 mb-4"><label className="text-[10px] font-bold text-red-500 uppercase block mb-1">Ketik "RESET"</label><input autoFocus type="text" className="w-full p-2 text-center font-black tracking-widest border-2 border-red-300 rounded focus:border-red-600 outline-none uppercase" placeholder="RESET" value={resetInput} onChange={e => setResetInput(e.target.value.toUpperCase())} /></div><div className="flex gap-3"><button onClick={() => { setShowResetModal(false); setResetInput(""); }} className="flex-1 py-3 rounded-xl border border-slate-300 text-slate-600 font-bold text-sm hover:bg-slate-50">Batal</button><button onClick={handleResetDatabase} disabled={isResetting || resetInput !== 'RESET'} className="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold text-sm shadow-lg hover:bg-red-700 disabled:opacity-50 flex justify-center items-center gap-2">{isResetting ? <div className="typing-dot bg-white"></div> : 'HAPUS'}</button></div></div></div>)}
                 </div>
            );
        };

        const PurchaseView = ({ user, showToast }) => {
            const [purchases, setPurchases] = useState([]);
            const [suppliers, setSuppliers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [supplierModalOpen, setSupplierModalOpen] = useState(false);
            const [invoiceModalOpen, setInvoiceModalOpen] = useState(false);
            const [addSupplierMode, setAddSupplierMode] = useState(false);
            const [submitting, setSubmitting] = useState(false);
            const [supplierSearch, setSupplierSearch] = useState('');
            const [invoiceData, setInvoiceData] = useState({ supplier: '', date: '', dueDate: '', total: '', ppn: '', paymentMethod: 'Tunai', isPaid: true, isConsignment: false });
            const [supplierData, setSupplierData] = useState({ name: '', address: '', phone: '' });
            const [editingSupplier, setEditingSupplier] = useState(null);

            useEffect(() => { if (!user) return; const q = window.query(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'purchases'), window.orderBy('date', 'desc'), window.limit(200)); const unsub = window.onSnapshot(q, (snapshot) => { setPurchases(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); }); return () => unsub(); }, [user]);
            useEffect(() => { if (!user) return; const q = window.query(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'suppliers'), window.orderBy('name', 'asc')); const unsub = window.onSnapshot(q, (snapshot) => { setSuppliers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); }); return () => unsub(); }, [user]);
            useEffect(() => { if (invoiceData.paymentMethod === 'Kredit') { setInvoiceData(prev => ({ ...prev, isPaid: false })); } else { setInvoiceData(prev => ({ ...prev, isPaid: true })); } }, [invoiceData.paymentMethod]);

            const stats = useMemo(() => { const today = new Date(); today.setHours(0,0,0,0); const next7Days = new Date(today); next7Days.setDate(today.getDate() + 7); let totalPurchase = 0, dueSoon = 0, overdue = 0, unpaid = 0, countTotal = 0, countDue = 0, countOverdue = 0, countUnpaid = 0, consignmentTotal = 0, consignmentUnpaid = 0; purchases.forEach(p => { const amount = safeNumber(p.total); const dueDate = p.dueDate ? new Date(p.dueDate) : null; if(dueDate) dueDate.setHours(0,0,0,0); if (p.isConsignment) { consignmentTotal += amount; if (!p.isPaid) { consignmentUnpaid += amount; } } totalPurchase += amount; countTotal++; if (!p.isPaid) { unpaid += amount; countUnpaid++; if (dueDate) { if (dueDate < today) { overdue += amount; countOverdue++; } else if (dueDate <= next7Days) { dueSoon += amount; countDue++; } } } }); return { totalPurchase, dueSoon, overdue, unpaid, countTotal, countDue, countOverdue, countUnpaid, consignmentTotal, consignmentUnpaid }; }, [purchases]);
            const handleSelectSupplier = (supplier) => { setInvoiceData({ ...invoiceData, supplier: supplier.name }); setSupplierModalOpen(false); setInvoiceModalOpen(true); };
            const handleSubmitInvoice = async (e) => { e.preventDefault(); if(!invoiceData.supplier || !invoiceData.total) return; setSubmitting(true); const subtotal = safeNumber(invoiceData.total); const ppn = safeNumber(invoiceData.ppn); const grandTotal = subtotal + ppn; try { await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'purchases'), { supplier: invoiceData.supplier, total: grandTotal, subtotal: subtotal, ppn: ppn, paymentMethod: invoiceData.paymentMethod, date: invoiceData.date ? new Date(invoiceData.date).toISOString() : new Date().toISOString(), dueDate: invoiceData.dueDate ? new Date(invoiceData.dueDate).toISOString() : null, isPaid: invoiceData.isPaid, isConsignment: invoiceData.isConsignment || false, createdAt: window.serverTimestamp() }); showToast("Faktur berhasil dicatat"); setInvoiceModalOpen(false); setInvoiceData({ supplier: '', date: '', dueDate: '', total: '', ppn: '', paymentMethod: 'Tunai', isPaid: true, isConsignment: false }); } catch(err) { console.error(err); showToast("Gagal menyimpan faktur", "error"); } finally { setSubmitting(false); } };
            const deletePurchase = async (id) => { if(!confirm("Hapus faktur ini?")) return; try { await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'purchases', id)); showToast("Faktur dihapus"); } catch(err) { showToast("Gagal hapus", "error"); } };
            const togglePaid = async (purchase) => { try { await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'purchases', purchase.id), { isPaid: !purchase.isPaid }); showToast("Status pembayaran diperbarui"); } catch(err) { showToast("Gagal update status", "error"); } };
            const handleSaveSupplier = async (e) => { e.preventDefault(); if(!supplierData.name) return; setSubmitting(true); try { const collectionRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'suppliers'); if(editingSupplier) { await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'suppliers', editingSupplier.id), supplierData); showToast("Supplier diupdate"); } else { await window.addDoc(collectionRef, { ...supplierData, createdAt: window.serverTimestamp() }); showToast("Supplier ditambahkan"); } setAddSupplierMode(false); setEditingSupplier(null); setSupplierData({ name: '', address: '', phone: '' }); } catch(err) { console.error(err); showToast("Gagal simpan supplier", "error"); } finally { setSubmitting(false); } };
            const handleEditSupplier = (supplier) => { setEditingSupplier(supplier); setSupplierData({ name: supplier.name, address: supplier.address || '', phone: supplier.phone || '' }); setAddSupplierMode(true); };
            const filteredSuppliers = suppliers.filter(s => s.name.toLowerCase().includes(supplierSearch.toLowerCase()));

            return (
                <div className="fade-in pb-20 md:pb-0 h-full flex flex-col relative z-10">
                     <header className="mb-6 flex items-center justify-between"><div><h2 className="text-2xl font-extrabold text-slate-800 tracking-tight">Faktur Pembelian</h2><p className="text-slate-500 text-xs mt-1">Kelola tagihan supplier</p></div><div className="flex gap-2"><button className="hidden md:flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-xl text-slate-600 font-bold text-xs hover:bg-slate-50 transition-all shadow-sm"><Icon name="download" /> Unduh Laporan</button><button onClick={() => setSupplierModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-teal-600 text-white rounded-xl font-bold text-xs hover:bg-teal-700 transition-all shadow-lg shadow-teal-200 active:scale-95"><Icon name="plus" /> Catat Faktur</button></div></header>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                         <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm relative overflow-hidden"><h4 className="font-bold text-slate-800 text-xs mb-1">Total Pembelian</h4><div className="text-xl font-black text-slate-800 mb-1">{formatRupiah(stats.totalPurchase)}</div><p className="text-[10px] text-slate-400">{stats.countTotal} faktur tercatat</p></div>
                         <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm relative overflow-hidden"><div className="absolute top-0 right-0 w-16 h-16 bg-amber-50 rounded-bl-full -mr-2 -mt-2"></div><h4 className="font-bold text-slate-800 text-xs mb-1 relative z-10">Jatuh Tempo (7 Hari)</h4><div className="text-xl font-black text-amber-600 mb-1 relative z-10">{formatRupiah(stats.dueSoon)}</div><p className="text-[10px] text-slate-400 relative z-10">{stats.countDue} faktur dari supplier</p></div>
                         <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm relative overflow-hidden"><div className="absolute top-0 right-0 w-16 h-16 bg-red-50 rounded-bl-full -mr-2 -mt-2"></div><h4 className="font-bold text-slate-800 text-xs mb-1 relative z-10">Telat Bayar</h4><div className="text-xl font-black text-red-600 mb-1 relative z-10">{formatRupiah(stats.overdue)}</div><p className="text-[10px] text-slate-400 relative z-10">{stats.countOverdue} faktur outstanding</p></div>
                         <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm relative overflow-hidden"><div className="absolute top-0 right-0 w-16 h-16 bg-slate-50 rounded-bl-full -mr-2 -mt-2"></div><h4 className="font-bold text-slate-800 text-xs mb-1 relative z-10">Total Belum Dibayar</h4><div className="text-xl font-black text-slate-700 mb-1 relative z-10">{formatRupiah(stats.unpaid)}</div><p className="text-[10px] text-slate-400 relative z-10">{stats.countUnpaid} faktur aktif</p></div>
                    </div>
                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div className="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-xl border border-indigo-100 shadow-sm flex items-center justify-between"><div><div className="flex items-center gap-2 mb-1"><Icon name="handshake" className="text-indigo-500" /><h4 className="font-bold text-indigo-800 text-xs">Total Konsinyasi Masuk</h4></div><div className="text-lg font-black text-indigo-900">{formatRupiah(stats.consignmentTotal)}</div></div></div>
                        <div className="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-xl border border-indigo-100 shadow-sm flex items-center justify-between"><div><div className="flex items-center gap-2 mb-1"><Icon name="file-invoice-dollar" className="text-purple-500" /><h4 className="font-bold text-purple-800 text-xs">Konsinyasi Belum Bayar</h4></div><div className="text-lg font-black text-purple-900">{formatRupiah(stats.consignmentUnpaid)}</div></div></div>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-3 pr-1">{loading ? <div className="text-center py-10"><div className="typing-dot bg-teal-600"></div></div> : purchases.length === 0 ? <div className="text-center py-12 text-slate-400 text-xs">Belum ada faktur pembelian.</div> : purchases.map(p => { const dueDate = p.dueDate ? new Date(p.dueDate) : null; const isOverdue = !p.isPaid && dueDate && dueDate < new Date(); return (<div key={p.id} className={`p-4 rounded-xl border transition-all hover:shadow-md bg-white ${isOverdue ? 'border-l-4 border-l-red-500 border-y-slate-100 border-r-slate-100' : 'border-slate-100'}`}><div className="flex justify-between items-start mb-2"><div><div className="flex items-center gap-2"><h4 className="font-bold text-slate-800 text-sm">{p.supplier}</h4>{p.isConsignment && <span className="bg-indigo-100 text-indigo-600 text-[9px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wider">Konsinyasi</span>}</div><div className="flex items-center gap-2 mt-1"><span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border ${p.paymentMethod === 'Kredit' ? 'bg-amber-50 text-amber-600 border-amber-200' : 'bg-slate-50 text-slate-600 border-slate-200'}`}>{p.paymentMethod || 'Tunai'}</span>{p.ppn > 0 && <span className="text-[9px] text-slate-400">+ PPN {formatRupiah(p.ppn)}</span>}</div><p className="text-[10px] text-slate-500 mt-1">{new Date(p.date).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'})}{p.dueDate && ` • Tempo: ${new Date(p.dueDate).toLocaleDateString('id-ID', {day: 'numeric', month: 'short'})}`}</p></div><div className="text-right"><div className="font-black text-slate-800">{formatRupiah(p.total)}</div><button onClick={() => togglePaid(p)} className={`mt-1 px-2 py-0.5 rounded text-[10px] font-bold border ${p.isPaid ? 'bg-green-50 text-green-600 border-green-200' : 'bg-slate-50 text-slate-500 border-slate-200'}`}>{p.isPaid ? 'LUNAS' : 'BELUM LUNAS'}</button></div></div><div className="flex justify-end pt-2 border-t border-dashed border-slate-100 mt-2"><button onClick={() => deletePurchase(p.id)} className="text-[10px] text-red-400 hover:text-red-600 font-bold flex items-center gap-1"><Icon name="trash" /> Hapus</button></div></div>) })}</div>

                    {supplierModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm fade-in">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm h-[80vh] flex flex-col relative overflow-hidden">
                                <div className="flex items-center justify-between p-4 border-b border-slate-100 bg-white z-10">{addSupplierMode ? (<button onClick={() => { setAddSupplierMode(false); setEditingSupplier(null); setSupplierData({name:'', address:'', phone:''}); }} className="flex items-center gap-1 text-slate-500 text-sm font-bold"><Icon name="chevron-left" /> Kembali</button>) : (<button onClick={() => setSupplierModalOpen(false)} className="text-slate-400 hover:text-slate-600"><Icon name="xmark" /></button>)}<h3 className="text-lg font-bold text-slate-800">{addSupplierMode ? (editingSupplier ? 'Edit Supplier' : 'Tambah Supplier') : 'Pilih Supplier'}</h3><div className="w-6"></div></div>
                                {!addSupplierMode ? (<><div className="p-4 bg-white border-b border-slate-100 flex gap-2"><div className="relative flex-1"><input autoFocus type="text" className="w-full pl-9 pr-3 py-2.5 rounded-lg border border-slate-200 text-sm font-bold outline-none focus:ring-2 focus:ring-teal-500" placeholder="Cari..." value={supplierSearch} onChange={e => setSupplierSearch(e.target.value)} /><Icon name="magnifying-glass" className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" /></div><button onClick={() => setAddSupplierMode(true)} className="px-3 py-2 rounded-lg bg-teal-50 text-teal-700 border border-teal-200 font-bold text-xs flex items-center gap-1 whitespace-nowrap active:scale-95 transition-all"><Icon name="plus" /> Pengirim</button></div><div className="px-4 py-2 bg-slate-50 text-[10px] font-bold text-slate-500">{filteredSuppliers.length} ditemukan</div><div className="flex-1 overflow-y-auto custom-scrollbar">{filteredSuppliers.length === 0 ? (<div className="flex flex-col items-center justify-center py-10 opacity-60"><Icon name="box-open" className="text-3xl text-slate-300 mb-2" /><p className="text-xs text-slate-400">Belum ada supplier.</p><button onClick={() => setAddSupplierMode(true)} className="mt-2 text-teal-600 text-xs font-bold hover:underline">Tambah Baru</button></div>) : (<div className="divide-y divide-slate-100">{filteredSuppliers.map(s => (<div key={s.id} className="p-4 bg-white hover:bg-slate-50 transition-colors flex items-center justify-between"><div className="flex-1 min-w-0 pr-3"><h4 className="font-bold text-slate-800 text-sm truncate">{s.name}</h4><p className="text-[10px] text-slate-500 truncate">{s.address || 'Tidak ada alamat'}</p></div><div className="flex gap-2"><button onClick={() => handleEditSupplier(s)} className="text-teal-600 text-xs font-bold px-2 py-1 hover:bg-teal-50 rounded">Edit</button><button onClick={() => handleSelectSupplier(s)} className="bg-white border border-teal-600 text-teal-700 text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-teal-50 shadow-sm">Pilih</button></div></div>))}</div>)}</div></>) : (<div className="p-6 flex-1 overflow-y-auto"><form onSubmit={handleSaveSupplier} className="space-y-4"><div><label className="text-[10px] font-bold text-slate-500 uppercase">Nama Supplier / Pengirim</label><input autoFocus type="text" className="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm font-bold outline-none focus:border-teal-500" placeholder="Contoh: PT. Maju Jaya" value={supplierData.name} onChange={e => setSupplierData({...supplierData, name: e.target.value})} required /></div><div><label className="text-[10px] font-bold text-slate-500 uppercase">Alamat (Kota/Kab)</label><input type="text" className="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm font-medium outline-none focus:border-teal-500" placeholder="Contoh: Kota Cirebon, Jawa Barat" value={supplierData.address} onChange={e => setSupplierData({...supplierData, address: e.target.value})} /></div><div><label className="text-[10px] font-bold text-slate-500 uppercase">No. Telepon (Opsional)</label><input type="tel" className="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm font-medium outline-none focus:border-teal-500" placeholder="08..." value={supplierData.phone} onChange={e => setSupplierData({...supplierData, phone: e.target.value})} /></div><button type="submit" disabled={submitting} className="w-full py-3.5 bg-teal-600 text-white rounded-xl font-bold shadow-lg shadow-teal-100 flex items-center justify-center gap-2 mt-4 active:scale-95 transition-all">{submitting ? <div className="typing-dot bg-white"></div> : <><Icon name="save" /> {editingSupplier ? 'UPDATE DATA' : 'SIMPAN SUPPLIER'}</>}</button></form></div>)}</div></div>)}
                    {invoiceModalOpen && (<div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm fade-in"><div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 relative"><button onClick={() => setInvoiceModalOpen(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="xmark" /></button><h3 className="text-lg font-bold text-slate-800 mb-4">Detail Faktur</h3><div className="bg-teal-50 p-3 rounded-xl border border-teal-100 mb-4 flex items-center gap-2"><div className="w-8 h-8 bg-teal-100 text-teal-600 rounded-lg flex items-center justify-center"><Icon name="truck-fast" /></div><div><p className="text-[10px] text-teal-600 font-bold uppercase">Pengirim</p><p className="text-sm font-bold text-teal-800">{invoiceData.supplier}</p></div></div><form onSubmit={handleSubmitInvoice} className="space-y-3"><div><label className="text-[10px] font-bold text-slate-500 uppercase">Subtotal (Tanpa PPN)</label><input autoFocus type="number" className="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm font-bold outline-none focus:border-teal-500" placeholder="0" value={invoiceData.total} onChange={e => setInvoiceData({...invoiceData, total: e.target.value})} required /></div><div className="grid grid-cols-2 gap-3"><div><label className="text-[10px] font-bold text-slate-500 uppercase">PPN (Rp)</label><input type="number" className="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm font-bold outline-none focus:border-teal-500" placeholder="0" value={invoiceData.ppn} onChange={e => setInvoiceData({...invoiceData, ppn: e.target.value})} /></div><div><label className="text-[10px] font-bold text-slate-500 uppercase">Pembayaran</label><select className="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm font-bold outline-none focus:border-teal-500" value={invoiceData.paymentMethod} onChange={e => setInvoiceData({...invoiceData, paymentMethod: e.target.value})}><option value="Tunai">Tunai</option><option value="Kredit">Kredit (Tempo)</option><option value="Transfer">Transfer</option></select></div></div><div className="p-3 bg-slate-100 rounded-xl flex justify-between items-center border border-slate-200"><span className="text-xs font-bold text-slate-500">Total Akhir:</span><span className="text-lg font-black text-slate-800">{formatRupiah(safeNumber(invoiceData.total) + safeNumber(invoiceData.ppn))}</span></div><div className="grid grid-cols-2 gap-3"><div><label className="text-[10px] font-bold text-slate-500 uppercase">Tgl Faktur</label><input type="date" className="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 text-xs font-bold outline-none" value={invoiceData.date} onChange={e => setInvoiceData({...invoiceData, date: e.target.value})} required /></div><div><label className="text-[10px] font-bold text-slate-500 uppercase">Jatuh Tempo</label><input type="date" className="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 text-xs font-bold outline-none" value={invoiceData.dueDate} onChange={e => setInvoiceData({...invoiceData, dueDate: e.target.value})} /></div></div><div className="bg-slate-50 p-3 rounded-xl border border-slate-100"><div className="flex items-center gap-2 py-1"><input type="checkbox" id="consignmentCheckInv" checked={invoiceData.isConsignment} onChange={e => setInvoiceData({...invoiceData, isConsignment: e.target.checked})} className="w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500" /><label htmlFor="consignmentCheckInv" className="text-sm font-bold text-slate-700">Barang Konsinyasi (Titipan)?</label></div><div className="flex items-center gap-2 py-1 border-t border-dashed border-slate-200 mt-1 pt-1"><input type="checkbox" id="paidCheckInv" checked={invoiceData.isPaid} onChange={e => setInvoiceData({...invoiceData, isPaid: e.target.checked})} className="w-4 h-4 rounded text-teal-600 focus:ring-teal-500" /><label htmlFor="paidCheckInv" className="text-sm font-bold text-slate-700">Sudah Lunas?</label></div></div><button type="submit" disabled={submitting} className="w-full py-3.5 bg-teal-600 text-white rounded-xl font-bold shadow-lg shadow-teal-100 flex items-center justify-center gap-2 mt-2 active:scale-95 transition-all">{submitting ? <div className="typing-dot bg-white"></div> : <><Icon name="save" /> SIMPAN FAKTUR</>}</button></form></div></div>)}
                </div>
            );
        };

        // --- NEW CASH BOOK COMPONENT (WITH MULTI-EXPENSE & WHATSAPP) ---
        const CashBookView = ({ user, currentProfile, showToast }) => {
            const [viewMode, setViewMode] = useState('operational'); // 'operational' | 'revenue'
            const [entries, setEntries] = useState([]);
            const [revenueLogs, setRevenueLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            
            // Operational Form State
            const [showModal, setShowModal] = useState(false);
            const [submitting, setSubmitting] = useState(false);
            const [formType, setFormType] = useState('in');
            const [formAmount, setFormAmount] = useState('');
            const [formDesc, setFormDesc] = useState('');
            const [formDate, setFormDate] = useState(new Date().toISOString().slice(0, 10));

            // Revenue Form State (UPDATED: expenses array)
            const [revForm, setRevForm] = useState({ 
                date: new Date().toISOString().slice(0, 10), 
                total: '', 
                deposited: '', 
                prevBalance: 0, 
                expenses: [] // Array of { name: '', amount: 0 }
            });
            const [tempExpName, setTempExpName] = useState('');
            const [tempExpAmount, setTempExpAmount] = useState('');
            const [isRevSubmitting, setIsRevSubmitting] = useState(false);

            useEffect(() => {
                if (!user) return;
                
                // Operational Data
                const qOp = window.query(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'cashflow'), window.orderBy('date', 'desc'), window.limit(100));
                const unsubOp = window.onSnapshot(qOp, (snapshot) => {
                    const allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const storeData = currentProfile.id === 'all_stores' ? allData : allData.filter(d => d.storeId === currentProfile.id);
                    setEntries(storeData);
                    setLoading(false);
                });

                // Revenue Data
                const qRev = window.query(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'daily_revenue'), window.orderBy('date', 'desc'), window.limit(50));
                const unsubRev = window.onSnapshot(qRev, (snapshot) => {
                    const allLogs = snapshot.docs.map(doc => {
                        const data = doc.data();
                        // Backward compatibility
                        let loadedExpenses = data.expenses || [];
                        if (loadedExpenses.length === 0 && safeNumber(data.expenseAmount) > 0) {
                            loadedExpenses = [{ name: data.expenseNote || 'Pengeluaran', amount: data.expenseAmount }];
                        }
                        return { id: doc.id, ...data, expenses: loadedExpenses };
                    });
                    
                    const storeLogs = currentProfile.id === 'all_stores' ? allLogs : allLogs.filter(d => d.storeId === currentProfile.id);
                    setRevenueLogs(storeLogs);

                    if (storeLogs.length > 0) {
                        const today = new Date().toISOString().slice(0, 10);
                        const lastEntry = storeLogs.find(l => l.date < today);
                        if (lastEntry) {
                            setRevForm(prev => ({ ...prev, prevBalance: lastEntry.remaining || 0 }));
                        }
                    }
                });

                return () => { unsubOp(); unsubRev(); };
            }, [user, currentProfile]);

            const opStats = useMemo(() => {
                let totalIn = 0, totalOut = 0;
                entries.forEach(e => {
                    if (e.type === 'in') totalIn += safeNumber(e.amount); else totalOut += safeNumber(e.amount);
                });
                return { totalIn, totalOut, balance: totalIn - totalOut };
            }, [entries]);

            const handleOpSubmit = async (e) => {
                e.preventDefault();
                if (!formAmount || !formDesc || !formDate) return;
                setSubmitting(true);
                try {
                    await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'cashflow'), {
                        type: formType, amount: safeNumber(formAmount), description: formDesc, date: formDate,
                        storeId: currentProfile.id === 'all_stores' ? 'default' : currentProfile.id,
                        user: user.email, createdAt: window.serverTimestamp()
                    });
                    logToDB('KEUANGAN', `Catat ${formType === 'in' ? 'Masuk' : 'Keluar'}: ${formDesc}`, currentProfile.id, user.email);
                    showToast("Transaksi berhasil disimpan");
                    setFormAmount(''); setFormDesc(''); setShowModal(false);
                } catch (err) { showToast("Gagal menyimpan data", "error"); } finally { setSubmitting(false); }
            };

            const handleOpDelete = async (id) => {
                if(!confirm("Hapus transaksi ini?")) return;
                try { await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'cashflow', id)); showToast("Transaksi dihapus"); } catch(err) { showToast("Gagal menghapus", "error"); }
            };

            // ADD EXPENSE TO LIST
            const addExpenseItem = () => {
                if (!tempExpName || !tempExpAmount) return;
                const newExp = { name: tempExpName, amount: safeNumber(tempExpAmount) };
                setRevForm(prev => ({ ...prev, expenses: [...prev.expenses, newExp] }));
                setTempExpName('');
                setTempExpAmount('');
            };

            // REMOVE EXPENSE FROM LIST
            const removeExpenseItem = (index) => {
                setRevForm(prev => ({ ...prev, expenses: prev.expenses.filter((_, i) => i !== index) }));
            };

            const handleRevSubmit = async (e) => {
                e.preventDefault();
                if(!revForm.total || !revForm.date) return;
                setIsRevSubmitting(true);
                
                const total = safeNumber(revForm.total);
                const deposited = safeNumber(revForm.deposited);
                const prev = safeNumber(revForm.prevBalance);
                
                // Calculate total expense from array
                const totalExpense = revForm.expenses.reduce((acc, curr) => acc + safeNumber(curr.amount), 0);
                
                // Remaining logic: (Prev + Revenue) - Expense - Deposited
                const remaining = (prev + total) - totalExpense - deposited;

                try {
                    const existing = revenueLogs.find(l => l.date === revForm.date);
                    const data = {
                        date: revForm.date,
                        storeId: currentProfile.id === 'all_stores' ? 'default' : currentProfile.id,
                        totalRevenue: total, 
                        deposited, 
                        remaining, 
                        previousBalance: prev,
                        expenses: revForm.expenses, // Save array
                        expenseAmount: totalExpense, // Save total for quick stats
                        expenseNote: revForm.expenses.map(e => e.name).join(', '), // Save joined string for legacy
                        user: user.email, 
                        updatedAt: window.serverTimestamp()
                    };

                    if (existing) {
                        await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'daily_revenue', existing.id), data);
                        showToast("Data setoran diperbarui");
                    } else {
                        data.createdAt = window.serverTimestamp();
                        await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'daily_revenue'), data);
                        showToast("Data setoran disimpan");
                    }
                    setRevForm(prev => ({ ...prev, total: '', deposited: '', expenses: [] }));
                } catch(err) { showToast("Gagal simpan setoran", "error"); } finally { setIsRevSubmitting(false); }
            };

            const handleRevDelete = async (id) => {
                if(!confirm("Hapus catatan setoran ini?")) return;
                try { await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'daily_revenue', id)); showToast("Dihapus"); } catch(err) { showToast("Gagal hapus", "error"); }
            };

            // UPDATED COPY TO WA LOGIC
            const handleCopyRevenueToWA = (log) => {
                const prev = safeNumber(log.previousBalance);
                const income = safeNumber(log.totalRevenue);
                const totalExp = safeNumber(log.expenseAmount);
                const deposited = safeNumber(log.deposited);
                
                // Hitungan Total (Uang Tersedia sebelum setor)
                const netBalance = (prev + income) - totalExp;
                const remaining = log.remaining;

                // Format Expenses List
                let expenseListText = "";
                if (log.expenses && log.expenses.length > 0) {
                    log.expenses.forEach((exp, idx) => {
                        expenseListText += `${idx + 1}. ${exp.name} : ${formatRupiah(exp.amount)}\n`;
                    });
                } else if (totalExp > 0) {
                    expenseListText += `1. ${log.expenseNote || 'Pengeluaran'} : ${formatRupiah(totalExp)}\n`;
                } else {
                    expenseListText = "-\n";
                }

                const text = `*LAPORAN SETORAN HARIAN*
${currentProfile.name} – ${formatDateFull(log.date)}

Sisa kemarin : ${formatRupiah(prev)}
Pendapatan : ${formatRupiah(income)}
Pengeluaran : 
${expenseListText}---------------------------------------------
*Total :  ${formatRupiah(netBalance)}*
Setor : ${formatRupiah(deposited)} ✅
Sisa : ${formatRupiah(remaining)}`;

                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => showToast("Disalin! Tempel di WA.")).catch(() => alert("Gagal copy otomatis."));
                } else {
                    const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.select(); try { const successful = document.execCommand('copy'); if(successful) showToast("Disalin! Tempel di WA."); } catch (err) {} document.body.removeChild(textArea);
                }
            };

            const currentTotalExpense = revForm.expenses.reduce((acc, curr) => acc + safeNumber(curr.amount), 0);
            const currentRevRemaining = (safeNumber(revForm.prevBalance) + safeNumber(revForm.total)) - currentTotalExpense - safeNumber(revForm.deposited);

            if (currentProfile.id === 'all_stores') {
                return <div className="fade-in max-w-md mx-auto pt-10 text-center px-4"><p className="text-slate-500">Mode Gabungan (Pilih Toko Spesifik)</p></div>;
            }

            return (
                <div className="fade-in pb-24 md:pb-0 h-full relative z-10 max-w-md mx-auto font-sans">
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg"><Icon name="book" /></div>
                            <div><h1 className="text-lg font-bold text-slate-800">Buku Kas</h1><p className="text-[10px] text-slate-500 font-bold">{currentProfile.name}</p></div>
                        </div>
                    </div>

                    <div className="flex p-1 bg-white rounded-xl mb-6 shadow-sm border border-slate-100">
                        <button onClick={() => setViewMode('operational')} className={`flex-1 py-2.5 rounded-lg text-xs font-bold transition-all ${viewMode === 'operational' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}>Operasional Harian</button>
                        <button onClick={() => setViewMode('revenue')} className={`flex-1 py-2.5 rounded-lg text-xs font-bold transition-all ${viewMode === 'revenue' ? 'bg-purple-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}>Rekap Setoran</button>
                    </div>

                    {viewMode === 'operational' ? (
                        <>
                            <div className="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl p-6 text-white shadow-xl shadow-blue-200 relative overflow-hidden mb-6">
                                <Icon name="wallet" className="absolute -right-4 -bottom-4 text-9xl text-white opacity-10 rotate-12" />
                                <p className="text-blue-100 text-sm mb-1 opacity-90">Saldo Operasional</p>
                                <h2 className="text-3xl font-bold mb-4 tracking-tight">{formatRupiah(opStats.balance)}</h2>
                                <div className="grid grid-cols-2 gap-4 pt-4 border-t border-blue-400/30">
                                    <div><div className="flex items-center gap-1 text-green-200 text-[10px] font-bold uppercase"><Icon name="circle-arrow-down" /> Masuk</div><p className="font-semibold">{formatRupiah(opStats.totalIn)}</p></div>
                                    <div><div className="flex items-center gap-1 text-red-200 text-[10px] font-bold uppercase"><Icon name="circle-arrow-up" /> Keluar</div><p className="font-semibold">{formatRupiah(opStats.totalOut)}</p></div>
                                </div>
                            </div>
                            <div className="space-y-3 pb-20">
                                <h3 className="font-bold text-slate-700 text-sm">Riwayat Operasional</h3>
                                {entries.map(t => (
                                    <div key={t.id} className="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center group">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center ${t.type === 'in' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}><Icon name={t.type === 'in' ? 'arrow-down' : 'arrow-up'} /></div>
                                            <div><p className="font-bold text-slate-800 text-sm">{t.description}</p><p className="text-[10px] text-slate-400">{formatDateIndo(t.date)}</p></div>
                                        </div>
                                        <div className="text-right">
                                            <p className={`font-bold text-sm ${t.type === 'in' ? 'text-green-600' : 'text-red-600'}`}>{t.type === 'in' ? '+' : '-'} {formatRupiah(t.amount)}</p>
                                            <button onClick={() => handleOpDelete(t.id)} className="text-slate-300 hover:text-red-500 text-[10px] p-1"><Icon name="trash" /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <button onClick={() => setShowModal(true)} className="fixed bottom-24 md:bottom-10 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center z-30"><Icon name="plus" className="text-2xl" /></button>
                            {showModal && (
                                <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm fade-in">
                                    <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                                        <h3 className="font-bold text-slate-800 mb-4">Catat Operasional</h3>
                                        <form onSubmit={handleOpSubmit} className="space-y-3">
                                            <div className="flex bg-slate-100 p-1 rounded-lg"><button type="button" onClick={() => setFormType('in')} className={`flex-1 py-2 rounded-md text-xs font-bold ${formType === 'in' ? 'bg-green-500 text-white' : 'text-slate-500'}`}>Pemasukan</button><button type="button" onClick={() => setFormType('out')} className={`flex-1 py-2 rounded-md text-xs font-bold ${formType === 'out' ? 'bg-red-500 text-white' : 'text-slate-500'}`}>Pengeluaran</button></div>
                                            <input type="date" value={formDate} onChange={e => setFormDate(e.target.value)} required className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold" />
                                            <input type="number" placeholder="Nominal (Rp)" value={formAmount} onChange={e => setFormAmount(e.target.value)} required className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-lg font-bold" />
                                            <input type="text" placeholder="Keterangan" value={formDesc} onChange={e => setFormDesc(e.target.value)} required className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm" />
                                            <div className="flex gap-2 mt-4"><button type="button" onClick={() => setShowModal(false)} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">Batal</button><button type="submit" className="flex-1 py-3 bg-slate-800 text-white rounded-xl font-bold">Simpan</button></div>
                                        </form>
                                    </div>
                                </div>
                            )}
                        </>
                    ) : (
                        <div className="space-y-6 pb-20">
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-purple-100">
                                <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="pen-to-square" className="text-purple-600" /> Input Setoran Harian</h3>
                                <form onSubmit={handleRevSubmit} className="space-y-3">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase">Tanggal</label><input type="date" value={revForm.date} onChange={e => setRevForm({...revForm, date: e.target.value})} className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold" /></div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase">Sisa Kemarin</label><input type="number" value={revForm.prevBalance} onChange={e => setRevForm({...revForm, prevBalance: e.target.value})} className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-600" /></div>
                                    </div>
                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase">Total Pendapatan</label><input type="number" placeholder="0" value={revForm.total} onChange={e => setRevForm({...revForm, total: e.target.value})} required className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold focus:border-purple-500 focus:ring-1 focus:ring-purple-500" /></div>
                                    
                                    <div className="p-3 bg-red-50 rounded-xl border border-red-100 space-y-2">
                                        <div className="flex justify-between items-center">
                                            <h4 className="text-xs font-bold text-red-800 flex items-center gap-1"><Icon name="arrow-trend-down" /> Daftar Pengeluaran</h4>
                                            <span className="text-xs font-black text-red-600">{formatRupiah(currentTotalExpense)}</span>
                                        </div>
                                        {revForm.expenses.length > 0 && (
                                            <div className="space-y-1 mb-2 bg-white rounded-lg p-2 border border-red-100">
                                                {revForm.expenses.map((exp, idx) => (
                                                    <div key={idx} className="flex justify-between items-center text-xs border-b border-dashed border-slate-100 last:border-0 py-1">
                                                        <span className="font-medium text-slate-600 truncate flex-1">{idx+1}. {exp.name}</span>
                                                        <div className="flex items-center gap-2"><span className="font-bold text-slate-800">{formatRupiah(exp.amount)}</span><button type="button" onClick={() => removeExpenseItem(idx)} className="text-red-400 hover:text-red-600"><Icon name="xmark" /></button></div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        <div className="flex gap-2 items-end">
                                            <div className="flex-1">
                                                <input type="text" placeholder="Ket. (ex: Listrik)" value={tempExpName} onChange={e => setTempExpName(e.target.value)} className="w-full p-2 bg-white border border-red-200 rounded-lg text-xs font-medium mb-1 outline-none" />
                                                <input type="number" placeholder="Rp" value={tempExpAmount} onChange={e => setTempExpAmount(e.target.value)} className="w-full p-2 bg-white border border-red-200 rounded-lg text-xs font-bold outline-none" />
                                            </div>
                                            <button type="button" onClick={addExpenseItem} disabled={!tempExpName || !tempExpAmount} className="bg-red-500 text-white w-8 h-16 rounded-lg flex items-center justify-center hover:bg-red-600 disabled:opacity-50 transition-colors shadow-sm"><Icon name="plus" /></button>
                                        </div>
                                    </div>

                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase">Disetor Ke Owner</label><input type="number" placeholder="0" value={revForm.deposited} onChange={e => setRevForm({...revForm, deposited: e.target.value})} required className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold focus:border-green-500 focus:ring-1 focus:ring-green-500" /></div>
                                    <div className="bg-purple-50 p-3 rounded-xl border border-purple-100 flex justify-between items-center mt-2"><span className="text-xs font-bold text-purple-700">Sisa Belum Disetor:</span><span className={`text-lg font-black ${currentRevRemaining < 0 ? 'text-red-600' : 'text-slate-800'}`}>{formatRupiah(currentRevRemaining)}</span></div>
                                    <button type="submit" disabled={isRevSubmitting} className="w-full py-3 bg-purple-600 text-white rounded-xl font-bold shadow-lg shadow-purple-200 mt-2 active:scale-95 transition-all">{isRevSubmitting ? 'Menyimpan...' : 'Simpan Laporan'}</button>
                                </form>
                            </div>

                            <div className="space-y-3">
                                <h3 className="font-bold text-slate-700 text-sm px-1">Riwayat Setoran</h3>
                                {revenueLogs.map(log => (
                                    <div key={log.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 relative group">
                                        <div className="flex justify-between items-start mb-2 border-b border-dashed border-slate-100 pb-2">
                                            <div><span className="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full">{formatDateFull(log.date)}</span></div>
                                            <div className="flex gap-2">
                                                <button onClick={() => handleCopyRevenueToWA(log)} className="flex items-center gap-1 text-[10px] font-bold bg-[#25D366] text-white px-2 py-1 rounded hover:bg-[#128C7E] transition-colors"><Icon name="whatsapp" type="brands" /> Salin WA</button>
                                                <button onClick={() => handleRevDelete(log.id)} className="w-6 h-6 flex items-center justify-center rounded text-slate-300 hover:text-red-500 hover:bg-red-50 transition-colors"><Icon name="trash" /></button>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-y-2 gap-x-4 text-xs">
                                            <div><p className="text-slate-400 font-medium">Sisa Kemarin</p><p className="font-bold text-slate-600">{formatRupiah(log.previousBalance)}</p></div>
                                            <div className="text-right"><p className="text-slate-400 font-medium">Pendapatan</p><p className="font-bold text-slate-800">{formatRupiah(log.totalRevenue)}</p></div>
                                            {safeNumber(log.expenseAmount) > 0 && (
                                                <div className="col-span-2 bg-red-50 p-2 rounded border border-red-100 my-1">
                                                    <div className="flex justify-between items-center mb-1"><span className="text-[10px] text-red-600 font-bold">Total Pengeluaran</span><span className="text-xs font-bold text-red-600">-{formatRupiah(log.expenseAmount)}</span></div>
                                                    {log.expenses && log.expenses.length > 0 ? (
                                                        <ul className="list-disc list-inside pl-1 space-y-0.5">{log.expenses.map((exp, i) => (<li key={i} className="text-[9px] text-slate-600 flex justify-between"><span>{exp.name}</span><span>{formatRupiah(exp.amount)}</span></li>))}</ul>
                                                    ) : (<p className="text-[9px] text-slate-500 italic">{log.expenseNote || 'Tanpa Keterangan'}</p>)}
                                                </div>
                                            )}
                                            <div><p className="text-slate-400 font-medium">Disetor</p><p className="font-bold text-green-600">{formatRupiah(log.deposited)}</p></div>
                                            <div className="text-right"><p className="text-slate-400 font-medium">Sisa Di Laci</p><p className="font-black text-purple-600 text-sm">{formatRupiah(log.remaining)}</p></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TransferView = ({ items, settings, showToast, currentProfile, user }) => {
            const [sourceStoreId, setSourceStoreId] = useState(currentProfile.id !== 'all_stores' ? currentProfile.id : 'default');
            const [destStoreId, setDestStoreId] = useState('');
            const [cart, setCart] = useState([]);
            const [search, setSearch] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const storeProfiles = settings.storeProfiles || [];
            const fuse = useMemo(() => new Fuse(items, { keys: ['name'], threshold: 0.3 }), [items]);
            const filteredItems = useMemo(() => { if (!search) return []; return fuse.search(search).map(r => r.item).slice(0, 30); }, [items, search, fuse]);
            const getStockInSource = (item) => { if (!item.stocks) return item.qty || 0; return item.stocks[sourceStoreId] || 0; };
            const addToTransfer = (item) => { 
                const currentStock = getStockInSource(item); 
                if (currentStock <= 0) { 
                    showToast("Stok habis di toko asal!", "error"); 
                    return; 
                } 
                setCart(prev => { 
                    const existing = prev.find(c => c.id === item.id); 
                    if (existing) { 
                        if (existing.transferQty >= currentStock) { 
                            showToast("Melebihi stok tersedia!", "error"); 
                            return prev; 
                        } 
                        return prev.map(c => c.id === item.id ? { ...c, transferQty: c.transferQty + 1 } : c); 
                    } 
                    return [...prev, { ...item, transferQty: 1 }]; 
                });
                
                // --- FIX: CLEAR SEARCH AFTER ADDING ITEM ---
                setSearch(''); 
            };
            const updateQty = (id, delta) => { setCart(prev => prev.map(c => { if (c.id === id) { const newQty = c.transferQty + delta; const maxStock = getStockInSource(items.find(i => i.id === id)); if (newQty > maxStock) { showToast("Stok mentok!", "error"); return c; } if (newQty < 1) return c; return { ...c, transferQty: newQty }; } return c; })); };
            const removeFromCart = (id) => setCart(prev => prev.filter(c => c.id !== id));
            const handleTransfer = async () => { if (!sourceStoreId || !destStoreId) { showToast("Pilih toko asal dan tujuan", "error"); return; } if (sourceStoreId === destStoreId) { showToast("Toko asal dan tujuan tidak boleh sama", "error"); return; } if (cart.length === 0) return; setIsProcessing(true); try { const batch = window.writeBatch(window.db); cart.forEach(item => { const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', item.id); const sourceField = `stocks.${sourceStoreId}`; const destField = `stocks.${destStoreId}`; batch.update(docRef, { [sourceField]: window.increment(-item.transferQty), [destField]: window.increment(item.transferQty), updatedAt: window.serverTimestamp() }); }); await batch.commit(); 
                // LOG
                const sourceName = storeProfiles.find(p=>p.id===sourceStoreId)?.name;
                const destName = storeProfiles.find(p=>p.id===destStoreId)?.name;
                logToDB('TRANSFER', `Transfer ${cart.length} jenis item dari ${sourceName} ke ${destName}`, sourceStoreId, user?.email);

                showToast("Transfer Stok Berhasil!", "success"); setCart([]); setSearch(''); } catch (error) { console.error("Transfer error:", error); showToast("Gagal melakukan transfer", "error"); } finally { setIsProcessing(false); } };
            const copyToWA = () => { if (cart.length === 0) return; const sourceName = storeProfiles.find(p => p.id === sourceStoreId)?.name || 'Toko Asal'; const destName = storeProfiles.find(p => p.id === destStoreId)?.name || 'Toko Tujuan'; let text = `*Barang untuk ${destName}*\nDari: ${sourceName}\nTanggal: ${new Date().toLocaleDateString('id-ID')}\n----------------------\n\n`; cart.forEach((item, idx) => { text += `${idx + 1}. ${item.name} (${item.transferQty} ${item.unit || 'Pcs'})\n`; }); text += `\nTotal Item: ${cart.length} Jenis`; if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(text).then(() => showToast("Disalin ke Clipboard! Tempel di WA.")).catch(() => fallbackCopy(text)); } else { fallbackCopy(text); } };
            const fallbackCopy = (text) => { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.select(); try { const successful = document.execCommand('copy'); if(successful) showToast("Disalin! Tempel di WA."); else showToast("Gagal menyalin otomatis", "error"); } catch (err) { showToast("Browser tidak support copy", "error"); } document.body.removeChild(textArea); };

            return (
                <div className="fade-in pb-24 md:pb-0 h-full flex flex-col md:flex-row gap-4 relative z-10">
                    <div className="flex-1 flex flex-col h-full min-h-0"><header className="mb-4"><h2 className="text-2xl font-extrabold text-slate-800 tracking-tight">Transfer Antar Cabang</h2><p className="text-slate-500 text-xs mt-1">Pindahkan stok fisik dari satu toko ke toko lain</p></header><div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm mb-4 grid grid-cols-[1fr,auto,1fr] gap-2 items-center"><div><label className="text-[10px] font-bold text-slate-400 uppercase">Dari (Sumber)</label><select value={sourceStoreId} onChange={e => { setSourceStoreId(e.target.value); setCart([]); }} className="w-full p-2 rounded-lg bg-slate-50 border border-slate-200 text-sm font-bold outline-none focus:ring-2 focus:ring-sky-500">{storeProfiles.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div><div className="text-slate-300 pt-4"><Icon name="arrow-right-arrow-left" /></div><div><label className="text-[10px] font-bold text-slate-400 uppercase">Ke (Tujuan)</label><select value={destStoreId} onChange={e => setDestStoreId(e.target.value)} className="w-full p-2 rounded-lg bg-slate-50 border border-slate-200 text-sm font-bold outline-none focus:ring-2 focus:ring-sky-500"><option value="">-- Pilih Tujuan --</option>{storeProfiles.filter(p => p.id !== sourceStoreId).map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div></div><div className="relative group mb-4"><input autoFocus type="text" placeholder="Cari barang untuk dipindah..." className="w-full pl-11 pr-4 py-3 rounded-2xl bg-white border border-slate-200 shadow-soft focus:ring-2 focus:ring-sky-500 outline-none transition-all font-bold text-slate-700" value={search} onChange={e => setSearch(e.target.value)} /><Icon name="magnifying-glass" className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-lg group-focus-within:text-sky-500" /></div><div className="flex-1 overflow-y-auto custom-scrollbar pr-1 pb-2">{search === '' ? (<div className="h-full flex flex-col items-center justify-center text-slate-400 opacity-60"><Icon name="box-open" className="text-5xl mb-3 text-slate-300" /><p className="font-semibold text-sm">Cari barang di toko sumber</p></div>) : (<div className="grid grid-cols-1 md:grid-cols-2 gap-3">{filteredItems.map(item => { const stock = getStockInSource(item); const inCart = cart.find(c => c.id === item.id); const remaining = stock - (inCart ? inCart.transferQty : 0); const isOOS = remaining <= 0; return (<button key={item.id} onClick={() => addToTransfer(item)} disabled={isOOS} className={`text-left p-3 rounded-xl border transition-all relative overflow-hidden group flex justify-between items-center ${isOOS ? 'bg-slate-50 opacity-60 cursor-not-allowed' : 'bg-white hover:border-sky-300 hover:shadow-md'}`}><div className="min-w-0 pr-2"><h4 className="font-bold text-slate-800 text-sm truncate">{item.name}</h4><p className="text-[10px] text-slate-500">{item.unit}</p></div><div className={`text-[10px] px-2 py-1 rounded font-bold whitespace-nowrap ${isOOS ? 'bg-red-100 text-red-600' : 'bg-sky-50 text-sky-600'}`}>Sisa: {remaining}</div></button>); })}</div>)}</div></div><div className="w-full md:w-80 flex flex-col bg-white rounded-3xl shadow-soft border border-slate-100 h-fit md:h-full max-h-[calc(100vh-100px)]"><div className="p-4 border-b border-slate-100 bg-slate-50/50 rounded-t-3xl flex justify-between items-center"><h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="truck-ramp-box" className="text-amber-500" /> Daftar Pindah</h3><span className="text-xs font-bold bg-amber-100 text-amber-700 px-2 py-1 rounded-full">{cart.length} Item</span></div><div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar min-h-[200px]">{cart.length === 0 ? (<div className="h-full flex flex-col items-center justify-center text-slate-300 opacity-60"><p className="text-xs font-medium">Belum ada barang</p></div>) : (cart.map(item => (<div key={item.id} className="p-3 bg-slate-50 rounded-xl border border-slate-100 flex gap-3 group items-center"><div className="flex-1 min-w-0"><h4 className="text-xs font-bold text-slate-700 truncate">{item.name}</h4></div><div className="flex items-center gap-1 bg-white rounded-lg shadow-sm border border-slate-200 p-0.5"><button onClick={() => updateQty(item.id, -1)} className="w-6 h-6 flex items-center justify-center text-[9px] hover:bg-slate-100 rounded text-slate-500"><Icon name="minus" /></button><span className="text-xs font-bold w-6 text-center">{item.transferQty}</span><button onClick={() => updateQty(item.id, 1)} className="w-6 h-6 flex items-center justify-center text-[9px] hover:bg-slate-100 rounded text-slate-500"><Icon name="plus" /></button></div><button onClick={() => removeFromCart(item.id)} className="text-red-400 hover:text-red-600"><Icon name="xmark" /></button></div>)))}</div><div className="p-4 border-t border-slate-100 bg-slate-50 rounded-b-3xl space-y-3"><button onClick={copyToWA} disabled={cart.length === 0} className="w-full py-3 rounded-xl bg-[#25D366] hover:bg-[#128C7E] text-white font-bold shadow-md transition-all active:scale-95 flex items-center justify-center gap-2 text-sm disabled:opacity-50"><Icon name="whatsapp" type="brands" /> Salin Teks WA</button><button onClick={handleTransfer} disabled={cart.length === 0 || !destStoreId || isProcessing} className="w-full py-3.5 bg-slate-800 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:bg-slate-400">{isProcessing ? <div className="typing-dot bg-white"></div> : <><Icon name="paper-plane" /> PROSES TRANSFER</>}</button></div></div></div>
            );
        };

        const CashierView = ({ items, user, showToast, settings, onGenerateImage, currentProfile }) => {
            const [isSessionActive, setIsSessionActive] = useState(false);
            const [search, setSearch] = useState('');
            const [cart, setCart] = useState([]);
            const [paymentAmount, setPaymentAmount] = useState('');
            const [checkoutModal, setCheckoutModal] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [paymentSuccess, setPaymentSuccess] = useState(false);
            const [receiptData, setReceiptData] = useState(null);
            const [cancelModal, setCancelModal] = useState(false);
            const [btDevice, setBtDevice] = useState(null);
            const [pendingCarts, setPendingCarts] = useState([]);
            const [cashierName, setCashierName] = useState(() => localStorage.getItem('cashierName') || '');
            const [showCashierLogin, setShowCashierLogin] = useState(false);
            const [tempCashierName, setTempCashierName] = useState('');

            useEffect(() => {
                if (!user) return;
                const q = window.query(
                    window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'pending_carts'),
                    window.orderBy('date', 'desc')
                );
                const unsub = window.onSnapshot(q, (snapshot) => {
                    const allCarts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const filtered = allCarts.filter(c => c.storeId === currentProfile.id || c.storeProfile === currentProfile.name);
                    setPendingCarts(filtered);
                });
                return () => unsub();
            }, [user, currentProfile]);

            // HOOKS MOVED UP HERE to avoid React Error #300 (Rendered fewer hooks than expected)
            const fuse = useMemo(() => new Fuse(items, { keys: ['name', 'rack'], threshold: 0.3 }), [items]);
            const filteredItems = useMemo(() => { if (!search) return []; return fuse.search(search).map(r => r.item).slice(0, 30); }, [items, search, fuse]);

            const grandTotal = cart.reduce((acc, item) => acc + (safeNumber(item.price) * item.cartQty), 0);
            const change = safeNumber(paymentAmount) - grandTotal;
            const getPaymentSuggestions = useMemo(() => { const suggestions = new Set(); suggestions.add(grandTotal); [1000, 2000, 5000, 10000, 20000, 50000, 100000].forEach(denom => { const nextVal = Math.ceil(grandTotal / denom) * denom; if (nextVal > grandTotal) suggestions.add(nextVal); }); [2000, 5000, 10000, 20000, 50000, 100000].forEach(bill => { if (bill > grandTotal) suggestions.add(bill); }); return Array.from(suggestions).sort((a,b) => a-b).slice(0, 6); }, [grandTotal]);

            const handleCashierLogin = () => {
                if (!tempCashierName.trim()) {
                    showToast("Nama kasir tidak boleh kosong", "error");
                    return;
                }
                const name = tempCashierName.trim();
                setCashierName(name);
                localStorage.setItem('cashierName', name);
                setShowCashierLogin(false);
                setIsSessionActive(true);
                setTempCashierName('');
                showToast(`Selamat datang, ${name}!`);
            };

            const handleStartSession = () => {
                if (!cashierName) {
                    setShowCashierLogin(true);
                } else {
                    setIsSessionActive(true);
                }
            };

            const handleChangeCashier = () => {
                setTempCashierName(cashierName);
                setShowCashierLogin(true);
            };

            const addToCart = (item) => {
                // UPDATE: Allow adding items even if stock is 0 or negative
                setCart(prev => {
                    const existing = prev.find(c => c.id === item.id);
                    if (existing) {
                        return prev.map(c => c.id === item.id ? { ...c, cartQty: c.cartQty + 1 } : c); 
                    }
                    return [...prev, { ...item, cartQty: 1 }];
                });
                showToast(`${item.name} +1`);
            };
            
            const removeFromCart = (id) => setCart(prev => prev.filter(c => c.id !== id));
            
            const updateQty = (id, delta) => { 
                setCart(prev => prev.map(c => { 
                    if (c.id === id) { 
                        const newQty = c.cartQty + delta; 
                        // UPDATE: Removed max stock check
                        if (newQty < 1) return c; 
                        return { ...c, cartQty: newQty }; 
                    } 
                    return c; 
                })); 
            };
            
            const handleBack = async () => { if (cart.length > 0) { try { await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'pending_carts'), { date: new Date().toISOString(), items: cart, total: grandTotal, cashierName: cashierName || 'Kasir', device: navigator.userAgent, storeProfile: currentProfile.name, storeId: currentProfile.id, createdAt: window.serverTimestamp() }); showToast("Transaksi disimpan (Pending)", "success"); } catch (error) { console.error(error); showToast("Gagal menyimpan transaksi tunda", "error"); } } setIsSessionActive(false); setSearch(''); setCart([]); };
            const confirmCancel = () => { setCart([]); setPaymentAmount(''); setSearch(''); setCancelModal(false); showToast("Transaksi dibatalkan & keranjang dikosongkan", "info"); };
            const resumeTransaction = async (pendingItem) => { try { await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'pending_carts', pendingItem.id)); setCart(pendingItem.items); setIsSessionActive(true); showToast("Transaksi dilanjutkan"); } catch (error) { showToast("Transaksi sudah diambil atau dihapus", "error"); } };
            
            const handleCheckout = async () => { 
                if (!user) return; 
                if (cart.length === 0) return; 
                
                // UPDATE: Removed stock check validation here
                
                if (safeNumber(paymentAmount) < grandTotal) { showToast("Uang kurang!", "error"); return; } 
                
                setIsProcessing(true); 
                try { 
                    const batch = window.writeBatch(window.db); 
                    cart.forEach(item => { 
                        const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', item.id); 
                        const stockField = `stocks.${currentProfile.id}`; 
                        batch.update(docRef, { [stockField]: window.increment(-item.cartQty), updatedAt: window.serverTimestamp() }); 
                    }); 
                    const transactionRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'transactions'); 
                    const newTransaction = { date: window.serverTimestamp(), items: cart, total: grandTotal, pay: safeNumber(paymentAmount), change: change, status: 'success', cashierName: cashierName || 'Kasir', storeId: currentProfile.id || 'default', storeName: currentProfile.name }; 
                    const docRef = window.doc(transactionRef); 
                    batch.set(docRef, newTransaction); 
                    await batch.commit(); 
                
                    // LOG
                    logToDB('TRANSAKSI', `Penjualan ${cart.length} item senilai ${formatRupiah(grandTotal)} oleh ${cashierName || 'Kasir'}`, currentProfile.id, user.email);

                    setReceiptData({ ...newTransaction, id: docRef.id, date: new Date() }); 
                    setPaymentSuccess(true); 
                    showToast("Transaksi Berhasil!"); 
                } catch (error) { 
                    console.error(error); 
                    showToast("Transaksi Gagal", "error"); 
                } finally { 
                    setIsProcessing(false); 
                } 
            };
            
            const handleCloseSuccess = () => { setCheckoutModal(false); setPaymentSuccess(false); setReceiptData(null); setCart([]); setPaymentAmount(''); setIsSessionActive(false); };
            const handlePrintAction = async () => { const printSettings = { ...settings, storeName: currentProfile.name, storeAddress: currentProfile.address, receiptFooter: currentProfile.footer || settings.receiptFooter, additionalHeaders: currentProfile.additionalHeaders || [] }; const connected = await printReceipt(receiptData, btDevice, printSettings); if (connected === true || typeof connected === 'object') { if (typeof connected === 'object') setBtDevice(connected); showToast("Mencetak..."); } else { showToast("Gagal Cetak / Bluetooth Mati", "error"); } };
            const handleWA = () => { if(receiptData) { onGenerateImage(receiptData); } };

            if (currentProfile.id === 'all_stores') {
                return (
                    <div className="fade-in h-full flex flex-col items-center justify-center text-center p-6 relative z-10">
                        <div className="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 text-3xl mb-4 shadow-sm"><Icon name="shop-lock" /></div>
                        <h2 className="text-xl font-bold text-slate-800 mb-2">Mode Gabungan (View Only)</h2>
                        <p className="text-slate-500 max-w-xs mx-auto mb-6 text-sm">Anda sedang melihat stok gabungan semua toko. Untuk melakukan transaksi kasir, silakan pilih salah satu toko spesifik dari menu di kiri atas.</p>
                        <div className="p-3 bg-yellow-50 border border-yellow-200 rounded-xl text-xs text-yellow-700 font-medium">
                            <Icon name="triangle-exclamation" className="mr-1" /> Stok tidak dapat dikurangi dari mode gabungan.
                        </div>
                    </div>
                );
            }

            if (!isSessionActive) {
                return (
                    <div className="fade-in h-full overflow-y-auto pb-20 md:pb-0 flex flex-col items-center justify-center relative z-10">
                        <div className="w-full max-w-sm px-4 flex flex-col items-center">
                             <div className="mb-6 bg-white/60 backdrop-blur-md p-4 rounded-2xl border border-white shadow-sm w-full text-center"><p className="text-xs text-slate-500 font-bold uppercase tracking-wider mb-1">POS Kasir Aktif</p><h2 className="text-xl font-black text-slate-800 flex items-center justify-center gap-2"><Icon name="store" className="text-sky-600" /> {currentProfile.name}</h2></div>
                             {cashierName && (<div className="mb-4 w-full bg-gradient-to-r from-sky-50 to-blue-50 p-3 rounded-xl border border-sky-200 flex items-center justify-between"><div className="flex items-center gap-2"><Icon name="user-tie" className="text-sky-600" /><div><p className="text-[10px] text-slate-500 font-bold uppercase">Kasir</p><p className="text-sm font-bold text-slate-800">{cashierName}</p></div></div><button onClick={handleChangeCashier} className="text-[10px] text-sky-600 font-bold hover:underline">Ganti</button></div>)}
                             {pendingCarts.length > 0 && (<div className="w-full mb-8 fade-in"><div className="flex items-center justify-between mb-3 px-1"><div className="flex items-center gap-2"><Icon name="clock-rotate-left" className="text-sky-600" /><h3 className="font-bold text-slate-700 text-sm">Tertunda di {currentProfile.name}</h3></div><span className="text-[10px] bg-sky-100 text-sky-700 px-2 py-0.5 rounded-full font-bold">{pendingCarts.length} sesi</span></div><div className="space-y-3">{pendingCarts.map(pending => (<button key={pending.id} onClick={() => resumeTransaction(pending)} className="w-full bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md hover:border-sky-300 transition-all flex items-center justify-between group relative overflow-hidden"><div className="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-sky-400 to-sky-600"></div><div className="text-left pl-2"><p className="font-black text-slate-800 text-lg">{formatRupiah(pending.total)}</p><p className="text-xs text-slate-500 font-medium mt-0.5">{pending.items.length} Barang • {new Date(pending.date).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}</p><p className="text-[9px] text-sky-600 font-bold mt-1"><Icon name="user" className="text-[8px]" /> {pending.cashierName || 'Kasir'}</p><span className="inline-block mt-2 text-[9px] font-bold text-sky-600 bg-sky-50 px-2 py-0.5 rounded border border-sky-100">Klik untuk lanjut</span></div><div className="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-300 group-hover:bg-sky-50 group-hover:text-sky-600 transition-colors"><Icon name="chevron-right" /></div></button>))}</div></div>)}
                            <button onClick={handleStartSession} className="group relative w-full aspect-square md:aspect-video rounded-3xl border-4 border-dashed border-sky-300 bg-sky-50/50 hover:bg-sky-100 hover:border-sky-400 transition-all flex flex-col items-center justify-center gap-4 active:scale-95"><div className="w-20 h-20 rounded-full bg-white text-sky-500 shadow-soft flex items-center justify-center text-4xl group-hover:scale-110 transition-transform"><Icon name="cart-plus" /></div><div className="text-center"><h2 className="text-2xl font-black text-slate-700 group-hover:text-sky-700">+ Penjualan Baru</h2><p className="text-sm text-slate-500 font-medium mt-1">Mulai sesi kasir di toko ini</p></div></button>
                        </div>
                        
                        {/* Cashier Login Modal */}
                        {showCashierLogin && (
                            <div className="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm fade-in">
                                <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 relative pop-in">
                                    <div className="w-16 h-16 bg-sky-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <Icon name="user-tie" className="text-3xl text-sky-600" />
                                    </div>
                                    <h3 className="text-xl font-black text-center text-slate-800 mb-2">Login Kasir</h3>
                                    <p className="text-center text-sm text-slate-500 mb-6">Masukkan nama Anda untuk memulai sesi kasir</p>
                                    <div className="mb-6">
                                        <label className="text-xs font-bold text-slate-500 uppercase block mb-2">Nama Kasir</label>
                                        <input 
                                            autoFocus 
                                            type="text" 
                                            value={tempCashierName} 
                                            onChange={e => setTempCashierName(e.target.value)}
                                            onKeyPress={e => { if (e.key === 'Enter') handleCashierLogin(); }}
                                            className="w-full p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none font-bold text-slate-800"
                                            placeholder="Contoh: Budi"
                                        />
                                    </div>
                                    <div className="flex gap-3">
                                        <button 
                                            onClick={() => { setShowCashierLogin(false); setTempCashierName(''); }} 
                                            className="flex-1 py-3 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-colors"
                                        >
                                            Batal
                                        </button>
                                        <button 
                                            onClick={handleCashierLogin} 
                                            disabled={!tempCashierName.trim()}
                                            className="flex-1 py-3 rounded-xl bg-sky-600 text-white font-bold shadow-lg hover:bg-sky-700 active:scale-95 transition-all disabled:opacity-50 disabled:bg-slate-400"
                                        >
                                            Masuk
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            return (
                <div className="fade-in h-full flex flex-col md:flex-row gap-4 pb-20 md:pb-0 relative z-10">
                    <div className="flex-1 flex flex-col h-full min-h-0">
                        <div className="flex items-center gap-3 mb-4">
                            <button onClick={handleBack} className="w-10 h-10 rounded-xl bg-white text-slate-400 hover:text-sky-600 hover:border-sky-300 border border-slate-200 flex items-center justify-center shadow-sm transition-colors" title="Kembali & Simpan Sementara"><Icon name="arrow-left" /></button>
                            <div className="relative group flex-1"><input autoFocus type="text" placeholder="Ketik nama barang disini..." className="w-full pl-11 pr-4 py-3.5 rounded-2xl bg-white border border-slate-200 shadow-soft focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all font-bold text-lg text-slate-700 placeholder:font-normal placeholder:text-slate-400" value={search} onChange={e => setSearch(e.target.value)} /><Icon name="magnifying-glass" className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl group-focus-within:text-sky-500" /></div>
                        </div>
                        {cashierName && (
                            <div className="mb-3 bg-gradient-to-r from-sky-50 to-blue-50 p-2 px-3 rounded-xl border border-sky-200 flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <Icon name="user-tie" className="text-sky-600 text-sm" />
                                    <span className="text-xs font-bold text-slate-800">{cashierName}</span>
                                </div>
                                <button onClick={handleChangeCashier} className="text-[9px] text-sky-600 font-bold hover:underline">Ganti</button>
                            </div>
                        )}
                        <div className="flex-1 overflow-y-auto custom-scrollbar pr-1 pb-2">{search === '' ? (<div className="h-full flex flex-col items-center justify-center text-slate-400 opacity-60"><Icon name="magnifying-glass" className="text-6xl mb-4 text-slate-300" /><p className="font-semibold text-lg">Mulai ketik untuk mencari barang...</p><p className="text-xs mt-1">Stok diambil dari: <b>{currentProfile.name}</b></p></div>) : (<div className="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">{filteredItems.map(item => { const inCart = cart.find(c => c.id === item.id); const currentStock = safeNumber(item.qty) - (inCart ? inCart.cartQty : 0); const isOOS = currentStock <= 0; return (<button key={item.id} onClick={() => addToCart(item)} className={`text-left p-3 rounded-xl border transition-all relative overflow-hidden group ${isOOS ? 'bg-red-50 border-red-200' : 'bg-white border-slate-200 hover:border-sky-300 hover:shadow-md'}`}>{isNewItem(item.createdAt) && !isOOS && <span className="absolute top-0 right-0 bg-rose-500 text-white text-[8px] font-bold px-1.5 rounded-bl-lg">NEW</span>}<h4 className={`font-bold text-xs line-clamp-2 h-8 leading-snug ${isOOS ? 'text-red-800' : 'text-slate-800'}`}>{item.name}</h4><div className="mt-2 flex justify-between items-end"><div><p className={`text-[10px] font-medium ${isOOS ? 'text-red-400' : 'text-slate-500'}`}>{item.unit}</p><p className={`text-xs font-bold ${isOOS ? 'text-red-500' : 'text-sky-600'}`}>{formatRupiah(item.price)}</p></div><div className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${isOOS ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-600'}`}>Stok: {currentStock}</div></div><div className="absolute inset-0 bg-sky-500/10 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"><Icon name="plus" className="text-sky-600 text-xl" /></div></button>)})}{filteredItems.length === 0 && <div className="col-span-full py-10 text-center text-slate-400 text-sm">Barang tidak ditemukan</div>}</div>)}</div></div><div className="w-full md:w-80 lg:w-96 flex flex-col bg-white rounded-3xl shadow-soft border border-slate-100 h-fit md:h-full max-h-[calc(100vh-100px)]"><div className="p-4 border-b border-slate-100 bg-slate-50/50 rounded-t-3xl flex justify-between items-center"><h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="cart-shopping" className="text-sky-600" /> Keranjang</h3><span className="text-xs font-bold bg-sky-100 text-sky-700 px-2 py-1 rounded-full">{cart.length} Item</span></div><div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar min-h-[200px]">{cart.length === 0 ? (<div className="h-full flex flex-col items-center justify-center text-slate-300 opacity-60"><Icon name="basket-shopping" className="text-4xl mb-2" /><p className="text-xs font-medium">Keranjang Kosong</p></div>) : (cart.map(item => (<div key={item.id} className="p-3 bg-slate-50 rounded-xl border border-slate-100 flex gap-3 group"><div className="flex-1 min-w-0"><h4 className="text-xs font-bold text-slate-700 truncate">{item.name}</h4><p className="text-[10px] text-slate-500">{formatRupiah(item.price)} x {item.cartQty}</p></div><div className="flex flex-col items-end gap-1"><p className="text-xs font-bold text-slate-800">{formatRupiah(item.price * item.cartQty)}</p><div className="flex items-center gap-1 bg-white rounded-lg shadow-sm border border-slate-200 p-0.5"><button onClick={() => updateQty(item.id, -1)} className="w-5 h-5 flex items-center justify-center text-[8px] hover:bg-slate-100 rounded text-slate-500"><Icon name="minus" /></button><span className="text-xs font-bold w-4 text-center">{item.cartQty}</span><button onClick={() => updateQty(item.id, 1)} className="w-5 h-5 flex items-center justify-center text-[8px] hover:bg-slate-100 rounded text-slate-500"><Icon name="plus" /></button></div></div><button onClick={() => removeFromCart(item.id)} className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-[8px] opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center shadow-md"><Icon name="xmark" /></button></div>)))}</div><div className="p-4 border-t border-slate-100 bg-slate-50 rounded-b-3xl"><div className="flex justify-between items-end mb-4"><span className="text-xs text-slate-500 font-medium">Total Tagihan</span><span className="text-xl font-black text-slate-800">{formatRupiah(grandTotal)}</span></div><button onClick={() => { setPaymentAmount(''); setCheckoutModal(true); }} disabled={cart.length === 0} className="w-full py-3.5 bg-gradient-to-r from-sky-600 to-sky-500 text-white rounded-xl font-bold shadow-lg shadow-sky-200 active:scale-95 transition-all disabled:opacity-50 disabled:scale-100 flex items-center justify-center gap-2"><Icon name="money-bill-wave" /> Bayar Sekarang</button><button onClick={() => setCancelModal(true)} disabled={cart.length === 0} className="w-full mt-3 py-3 rounded-xl border border-red-200 text-red-500 font-bold hover:bg-red-50 transition-all text-sm disabled:opacity-50 disabled:border-slate-200 disabled:text-slate-400 active:scale-95">Batalkan Transaksi</button></div></div>{checkoutModal && ( <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm fade-in"> {!paymentSuccess ? ( <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 relative"> <button onClick={() => setCheckoutModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="xmark" /></button><h3 className="text-lg font-bold text-slate-800 mb-4 text-center">Pembayaran</h3> <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4"><div className="flex justify-between mb-2 text-sm text-slate-500"><span>Total Belanja</span><span className="font-bold text-slate-800">{formatRupiah(grandTotal)}</span></div><div className="h-px bg-slate-200 my-2"></div><label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Pilih Nominal Cepat</label><div className="grid grid-cols-2 gap-2 mb-4">{getPaymentSuggestions.map((amount, idx) => (<button key={idx} onClick={() => setPaymentAmount(amount.toString())} className={`py-2 px-1 rounded-lg text-xs font-bold border transition-all active:scale-95 ${safeNumber(paymentAmount) === amount ? 'bg-sky-600 text-white border-sky-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-sky-50 hover:border-sky-300'}`}>{amount === grandTotal ? 'Uang Pas' : formatRupiah(amount)}</button>))}</div><div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase">Atau Ketik Manual</label><div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm font-bold">Rp</span><input autoFocus type="number" className="w-full pl-10 pr-3 py-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none font-bold text-lg text-slate-800" placeholder="0" value={paymentAmount} onChange={e => setPaymentAmount(e.target.value)} /></div></div><div className={`mt-3 flex justify-between text-sm transition-colors ${change < 0 ? 'text-red-500' : 'text-green-600'}`}><span className="font-medium">Kembalian</span><span className="font-bold">{change < 0 ? '-' : formatRupiah(change)}</span></div></div> <button onClick={handleCheckout} disabled={change < 0 || isProcessing} className="w-full py-3.5 bg-sky-600 text-white rounded-xl font-bold shadow-lg disabled:opacity-50 disabled:bg-slate-400 flex justify-center items-center gap-2">{isProcessing ? <div className="typing-dot bg-white"></div> : <><Icon name="wallet" /> BAYAR</>}</button> </div> ) : ( <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-8 relative flex flex-col items-center text-center pop-in"> <div className="w-24 h-24 relative mb-4"><svg className="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><circle className="checkmark__circle" cx="26" cy="26" r="25" fill="none"/><path className="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/></svg></div> <h2 className="text-2xl font-black text-slate-800 mb-1">Transaksi Selesai</h2><p className="text-slate-500 text-sm mb-8">Kembalian: <span className="font-bold text-slate-800">{formatRupiah(receiptData.change)}</span></p> <div className="w-full space-y-3"><button onClick={handlePrintAction} className="w-full py-3 rounded-xl bg-slate-800 text-white font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2"><Icon name="print" /> Cetak Bluetooth</button><button onClick={handleWA} className="w-full py-3 rounded-xl bg-green-500 hover:bg-green-600 text-white font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2"><Icon name="image" /> Kirim Gambar Struk (WA)</button><button onClick={handleCloseSuccess} className="w-full py-3 rounded-xl border-2 border-slate-100 text-slate-600 font-bold hover:bg-slate-50 active:scale-95 transition-all">Selesaikan Tanpa Struk</button></div> </div> )} </div> )}
                    <ConfirmModal isOpen={cancelModal} title="Batalkan Transaksi?" message="Keranjang akan dikosongkan dan semua item akan dihapus dari sesi ini." onConfirm={confirmCancel} onCancel={() => setCancelModal(false)} confirmText="Ya, Batalkan" confirmColor="red" />
                    
                    {/* Cashier Login Modal (untuk ganti kasir) */}
                    {showCashierLogin && (
                        <div className="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm fade-in">
                            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 relative pop-in">
                                <div className="w-16 h-16 bg-sky-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icon name="user-tie" className="text-3xl text-sky-600" />
                                </div>
                                <h3 className="text-xl font-black text-center text-slate-800 mb-2">Login Kasir</h3>
                                <p className="text-center text-sm text-slate-500 mb-6">Masukkan nama Anda untuk memulai sesi kasir</p>
                                <div className="mb-6">
                                    <label className="text-xs font-bold text-slate-500 uppercase block mb-2">Nama Kasir</label>
                                    <input 
                                        autoFocus 
                                        type="text" 
                                        value={tempCashierName} 
                                        onChange={e => setTempCashierName(e.target.value)}
                                        onKeyPress={e => { if (e.key === 'Enter') handleCashierLogin(); }}
                                        className="w-full p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none font-bold text-slate-800"
                                        placeholder="Contoh: Budi"
                                    />
                                </div>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => { setShowCashierLogin(false); setTempCashierName(''); }} 
                                        className="flex-1 py-3 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-colors"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        onClick={handleCashierLogin} 
                                        disabled={!tempCashierName.trim()}
                                        className="flex-1 py-3 rounded-xl bg-sky-600 text-white font-bold shadow-lg hover:bg-sky-700 active:scale-95 transition-all disabled:opacity-50 disabled:bg-slate-400"
                                    >
                                        Masuk
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const HistoryView = ({ user, showToast, settings, onGenerateImage, currentProfile }) => {
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedTx, setSelectedTx] = useState(null);
            const [returModal, setReturModal] = useState({ show: false, tx: null, item: null, index: -1 });
            const [qtyToRetur, setQtyToRetur] = useState(1);
            const [processingRetur, setProcessingRetur] = useState(false);
            const [btDevice, setBtDevice] = useState(null);
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [historySearch, setHistorySearch] = useState('');
            const [filterStatus, setFilterStatus] = useState('all'); 
            const [sortOrder, setSortOrder] = useState('newest'); 

            useEffect(() => {
                if (!user) return;
                const q = window.query(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'transactions'), window.orderBy('date', 'desc'), window.limit(500));
                const unsub = window.onSnapshot(q, (snapshot) => { 
                    const allTx = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    let filteredTx = allTx;
                    if (currentProfile.id !== 'all_stores') {
                         filteredTx = allTx.filter(t => t.storeId === currentProfile.id || t.storeName === currentProfile.name);
                    }
                    setTransactions(filteredTx); 
                    setLoading(false); 
                });
                return () => unsub();
            }, [user, currentProfile]);

            const changeDate = (days) => { const newDate = new Date(selectedDate); newDate.setDate(selectedDate.getDate() + days); setSelectedDate(newDate); };
            const isSameDay = (d1, d2) => { return d1.getDate() === d2.getDate() && d1.getMonth() === d2.getMonth() && d1.getFullYear() === d2.getFullYear(); };
            const dailyTransactions = useMemo(() => { return transactions.filter(tx => { const txDate = tx.date.seconds ? tx.date.toDate() : new Date(tx.date); return isSameDay(txDate, selectedDate); }); }, [transactions, selectedDate]);
            const processedTransactions = useMemo(() => {
                let data = [...dailyTransactions];
                if (historySearch) { const lowerQ = historySearch.toLowerCase(); data = data.filter(tx => (tx.id && tx.id.toLowerCase().includes(lowerQ)) || (tx.items && tx.items.some(i => i.name.toLowerCase().includes(lowerQ))) ); }
                if (filterStatus !== 'all') { data = data.filter(tx => tx.status === filterStatus); }
                data.sort((a, b) => { const dateA = a.date.seconds ? a.date.toDate() : new Date(a.date); const dateB = b.date.seconds ? b.date.toDate() : new Date(b.date); switch (sortOrder) { case 'oldest': return dateA - dateB; case 'highest': return b.total - a.total; case 'lowest': return a.total - b.total; case 'newest': default: return dateB - dateA; } });
                return data;
            }, [dailyTransactions, historySearch, filterStatus, sortOrder]);
            const stats = useMemo(() => { let grossSales = 0, grossCount = 0, returnsValue = 0, returnTxCount = 0; dailyTransactions.forEach(tx => { grossSales += tx.items.reduce((sum, item) => sum + (item.price * item.cartQty), 0); grossCount++; let txReturnVal = 0, hasReturn = false; tx.items.forEach(item => { if (item.returnedQty && item.returnedQty > 0) { txReturnVal += (item.returnedQty * item.price); hasReturn = true; } else if (tx.status === 'returned') { txReturnVal += (item.cartQty * item.price); hasReturn = true; } }); returnsValue += txReturnVal; if (hasReturn) returnTxCount++; }); return { netSales: grossSales - returnsValue, grossSales, grossCount, returnsValue, returnTxCount, avgSale: grossCount > 0 ? grossSales / grossCount : 0 }; }, [dailyTransactions]);
            const openReturModal = (tx, item, index) => { const maxRetur = item.cartQty - (item.returnedQty || 0); if (maxRetur <= 0) { showToast("Barang ini sudah diretur semua", "error"); return; } setReturModal({ show: true, tx, item, index, max: maxRetur }); setQtyToRetur(maxRetur); };
            const handleProcessRetur = async () => {
                const { tx, item, index, max } = returModal;
                if (!tx || !user) return;
                setProcessingRetur(true);
                try {
                    const batch = window.writeBatch(window.db);
                    const storeIdToReturn = tx.storeId || 'default';
                    const invRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', item.id);
                    const stockField = `stocks.${storeIdToReturn}`;
                    batch.update(invRef, { [stockField]: window.increment(qtyToRetur) });
                    const txRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'transactions', tx.id);
                    const updatedItems = [...tx.items];
                    updatedItems[index].returnedQty = (updatedItems[index].returnedQty || 0) + qtyToRetur;
                    let totalItemsCount = 0, totalReturnedCount = 0;
                    updatedItems.forEach(i => { totalItemsCount += i.cartQty; totalReturnedCount += (i.returnedQty || 0); });
                    let newStatus = tx.status;
                    if (totalReturnedCount === totalItemsCount) newStatus = 'returned'; else if (totalReturnedCount > 0) newStatus = 'partial';
                    batch.update(txRef, { items: updatedItems, status: newStatus, returnedAt: window.serverTimestamp() });
                    await batch.commit();

                    // LOG
                    logToDB('RETUR', `Retur ${qtyToRetur} ${item.name} pada TRX ${tx.id.slice(-5)}`, storeIdToReturn, user.email);

                    showToast(`Berhasil meretur ${qtyToRetur} ${item.unit} ke Stok Toko`, "success"); setReturModal({ show: false, tx: null, item: null, index: -1 }); setSelectedTx(null);
                } catch (error) { console.error("Retur error", error); showToast("Gagal melakukan retur", "error"); } finally { setProcessingRetur(false); }
            };
            const handlePrint = async (tx) => { const storeProfiles = settings.storeProfiles || []; const txProfile = storeProfiles.find(p => p.id === tx.storeId) || storeProfiles[0] || {}; const printSettings = { ...settings, storeName: txProfile.name || settings.storeName, storeAddress: txProfile.address || settings.storeAddress, receiptFooter: txProfile.footer || settings.receiptFooter, additionalHeaders: txProfile.additionalHeaders || [] }; const connected = await printReceipt(tx, btDevice, printSettings); if (connected === true || typeof connected === 'object') { if (typeof connected === 'object') setBtDevice(connected); showToast("Mencetak..."); } else { showToast("Gagal Cetak", "error"); } };
            const handleWAHistory = (tx) => { onGenerateImage(tx); };

            return (
                <div className="fade-in pb-20 md:pb-0 h-full flex flex-col relative z-10">
                    <header className="mb-4 flex flex-col md:flex-row md:items-center justify-between gap-4"><div><h2 className="text-2xl font-extrabold text-slate-800 tracking-tight">Riwayat {currentProfile.name}</h2><p className="text-slate-500 text-xs mt-1">Laporan harian & retur {currentProfile.id === 'all_stores' ? '(Semua Toko)' : 'khusus toko ini'}</p></div><div className="flex items-center gap-3 bg-white p-1 rounded-xl border border-slate-200 shadow-sm self-start md:self-auto"><button onClick={() => changeDate(-1)} className="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-slate-50 text-slate-500 transition-colors"><Icon name="chevron-left" /></button><div className="flex items-center gap-2 px-2 text-slate-700 font-bold text-sm min-w-[120px] justify-center"><Icon name="calendar-days" className="text-sky-500" />{selectedDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })}</div><button onClick={() => changeDate(1)} disabled={isSameDay(selectedDate, new Date())} className="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-slate-50 text-slate-500 transition-colors disabled:opacity-30"><Icon name="chevron-right" /></button></div></header>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm"><div className="flex items-center gap-1 mb-1 border-b-2 border-dashed border-slate-200 w-fit pb-0.5"><h4 className="font-bold text-slate-800 text-sm">Total transaksi kasir</h4><Icon name="circle-question" className="text-[10px] text-sky-500 mb-2" /></div><div className="text-2xl font-black text-slate-800 mt-2">{formatRupiah(stats.netSales)}</div><p className="text-xs text-slate-400 mt-1">Net setelah retur</p></div>
                        <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm"><div className="flex items-center gap-1 mb-1 border-b-2 border-dashed border-slate-200 w-fit pb-0.5"><h4 className="font-bold text-slate-800 text-sm">Total penjualan kasir</h4><Icon name="circle-question" className="text-[10px] text-sky-500 mb-2" /></div><div className="text-2xl font-black text-slate-800 mt-2">{formatRupiah(stats.grossSales)}</div><p className="text-xs text-slate-400 mt-1">Dari {stats.grossCount} transaksi</p></div>
                        <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm"><div className="flex items-center gap-1 mb-1 border-b-2 border-dashed border-slate-200 w-fit pb-0.5"><h4 className="font-bold text-slate-800 text-sm">Total retur kasir</h4><Icon name="circle-question" className="text-[10px] text-sky-500 mb-2" /></div><div className="text-2xl font-black text-red-600 mt-2">-{formatRupiah(stats.returnsValue).replace('Rp','Rp ')}</div><p className="text-xs text-slate-400 mt-1">Dari {stats.returnTxCount} transaksi bermasalah</p></div>
                        <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm"><h4 className="font-bold text-slate-800 text-sm mb-1">Rata-rata penjualan kasir</h4><div className="text-2xl font-black text-slate-800 mt-2">{formatRupiah(stats.avgSale)}</div></div>
                    </div>
                    <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm mb-4 space-y-3"><div className="relative"><input type="text" placeholder="Cari Ref Transaksi / Nama Barang..." className="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-200 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none text-sm font-medium" value={historySearch} onChange={(e) => setHistorySearch(e.target.value)} /><Icon name="magnifying-glass" className="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-sm" /></div><div className="flex gap-2"><div className="relative flex-1"><select className="w-full appearance-none pl-3 pr-8 py-2.5 rounded-lg border border-slate-200 bg-slate-50 text-xs font-bold text-slate-600 outline-none focus:ring-2 focus:ring-sky-500" value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} ><option value="all">Semua Status</option><option value="success">Sukses</option><option value="partial">Retur Sebagian</option><option value="returned">Retur Full (Batal)</option></select><Icon name="filter" className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none" /></div><div className="relative flex-1"><select className="w-full appearance-none pl-3 pr-8 py-2.5 rounded-lg border border-slate-200 bg-slate-50 text-xs font-bold text-slate-600 outline-none focus:ring-2 focus:ring-sky-500" value={sortOrder} onChange={(e) => setSortOrder(e.target.value)} ><option value="newest">Terbaru</option><option value="oldest">Terlama</option><option value="highest">Total Terbanyak</option><option value="lowest">Total Tersedikit</option></select><Icon name="arrow-down-wide-short" className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none" /></div></div></div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-3 pr-1">{loading ? <div className="text-center py-10 text-slate-400"><div className="typing-dot bg-sky-500"></div> Loading...</div> : processedTransactions.length === 0 ? (<div className="text-center py-12 flex flex-col items-center opacity-60"><div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3"><Icon name="calendar-xmark" className="text-2xl text-slate-400" /></div><p className="font-semibold text-slate-500">Tidak ada transaksi</p><p className="text-xs text-slate-400">Sesuai filter pencarian</p></div>) : processedTransactions.map(tx => (<div key={tx.id} onClick={() => setSelectedTx(tx)} className={`p-4 rounded-2xl border shadow-sm cursor-pointer transition-all hover:shadow-md ${tx.status === 'returned' ? 'bg-red-50 border-red-100 opacity-80' : 'bg-white border-slate-100 hover:border-sky-300'}`}><div className="flex justify-between items-start mb-2"><div><p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">{new Date(tx.date.seconds ? tx.date.toDate() : tx.date).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})} WIB {tx.storeName && `• ${tx.storeName}`}</p><h4 className={`font-black text-lg ${tx.status === 'returned' ? 'text-red-500 line-through' : 'text-slate-800'}`}>{formatRupiah(tx.total)}</h4></div>{tx.status === 'returned' ? <span className="bg-red-100 text-red-600 text-[10px] font-bold px-2 py-1 rounded-full">BATAL</span> : (tx.status === 'partial' ? <span className="bg-amber-100 text-amber-600 text-[10px] font-bold px-2 py-1 rounded-full">SEBAGIAN</span> : <span className="bg-green-100 text-green-600 text-[10px] font-bold px-2 py-1 rounded-full">SUKSES</span>)}</div><div className="text-xs text-slate-500 truncate">{tx.items.map(i => i.name).join(', ')}</div><div className="mt-3 flex justify-between items-center border-t border-dashed border-slate-200 pt-2"><span className="text-[10px] font-bold text-slate-400">{tx.items.length} Barang</span><span className="text-[10px] text-sky-600 font-bold flex items-center gap-1">Lihat Detail <Icon name="chevron-right" /></span></div></div>))}</div>
                    {selectedTx && (<div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm fade-in"><div className="bg-white rounded-3xl shadow-2xl w-full max-w-md p-0 overflow-hidden flex flex-col max-h-[90vh]"><div className="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><div><h3 className="font-bold text-slate-800">Detail Transaksi</h3><p className="text-[10px] text-slate-500">{selectedTx.id} {selectedTx.storeName ? `(${selectedTx.storeName})` : ''}</p></div><button onClick={() => setSelectedTx(null)} className="w-8 h-8 rounded-full bg-white text-slate-400 hover:text-slate-600 flex items-center justify-center shadow-sm"><Icon name="xmark" /></button></div><div className="p-5 overflow-y-auto flex-1"><div className="space-y-4">{selectedTx.items.map((item, idx) => { const returnedQty = item.returnedQty || 0; const remainingQty = item.cartQty - returnedQty; const isFullyReturned = remainingQty === 0; return (<div key={idx} className={`p-3 rounded-xl border ${isFullyReturned ? 'bg-red-50 border-red-100' : 'bg-slate-50 border-slate-100'}`}><div className="flex justify-between items-start mb-2"><div className="flex-1"><p className={`font-bold text-sm ${isFullyReturned ? 'text-red-600 line-through' : 'text-slate-700'}`}>{item.name}</p><p className="text-[10px] text-slate-500">{item.cartQty} x {formatRupiah(item.price)}</p>{returnedQty > 0 && <span className="text-[9px] font-bold text-red-500 bg-red-100 px-1.5 py-0.5 rounded-sm">Sudah Retur: {returnedQty}</span>}</div><div className="text-right"><p className="font-bold text-slate-800 text-sm">{formatRupiah(item.cartQty * item.price)}</p>{selectedTx.status !== 'returned' && remainingQty > 0 && (<button onClick={() => openReturModal(selectedTx, item, idx)} className="mt-2 bg-white border border-red-200 text-red-500 text-[10px] font-bold px-2 py-1 rounded-lg hover:bg-red-50 transition-colors shadow-sm">Retur Item</button>)}</div></div></div>); })}</div><div className="my-4 border-t border-dashed border-slate-300"></div><div className="flex justify-between text-sm mb-1"><span className="text-slate-500">Total</span><span className="font-bold text-slate-800">{formatRupiah(selectedTx.total)}</span></div><div className="flex justify-between text-sm mb-1"><span className="text-slate-500">Bayar</span><span className="font-bold text-slate-800">{formatRupiah(selectedTx.pay)}</span></div><div className="flex justify-between text-sm"><span className="text-slate-500">Kembali</span><span className="font-bold text-green-600">{formatRupiah(selectedTx.change)}</span></div></div><div className="p-5 bg-slate-50 border-t border-slate-100 flex gap-3"><button onClick={() => handleWAHistory(selectedTx)} className="flex-1 py-3 rounded-xl bg-green-500 text-white hover:bg-green-600 font-bold shadow-sm active:scale-95 text-sm flex items-center justify-center gap-2"><Icon name="image" /> Gambar Struk (WA)</button><button onClick={() => handlePrint(selectedTx)} className="flex-1 py-3 rounded-xl bg-slate-800 text-white font-bold shadow-lg active:scale-95 text-sm flex items-center justify-center gap-2"><Icon name="print" /> Cetak Struk</button></div></div></div>)}
                    <ConfirmModal isOpen={returModal.show} title="Retur Barang" message={`Berapa banyak "${returModal.item?.name}"? Stok akan kembali ke toko asal.`} onConfirm={handleProcessRetur} onCancel={() => setReturModal({ show: false, tx: null, item: null, index: -1 })} confirmText={processingRetur ? "Memproses..." : "Konfirmasi Retur"}> {returModal.item && (<div className="bg-slate-50 p-4 rounded-xl border border-slate-200"><div className="flex items-center justify-between"><button onClick={() => setQtyToRetur(Math.max(1, qtyToRetur - 1))} className="w-10 h-10 bg-white border border-slate-300 rounded-lg flex items-center justify-center text-slate-500 hover:bg-slate-100"><Icon name="minus" /></button><div className="flex flex-col items-center"><span className="text-2xl font-black text-slate-800">{qtyToRetur}</span><span className="text-[10px] text-slate-400 font-bold uppercase">Maks: {returModal.max}</span></div><button onClick={() => setQtyToRetur(Math.min(returModal.max, qtyToRetur + 1))} className="w-10 h-10 bg-white border border-slate-300 rounded-lg flex items-center justify-center text-slate-500 hover:bg-slate-100"><Icon name="plus" /></button></div><div className="mt-3 text-center"><p className="text-xs text-slate-500">Nilai Pengembalian:</p><p className="text-lg font-bold text-red-600">{formatRupiah(qtyToRetur * returModal.item.price)}</p></div></div>)}</ConfirmModal>
                </div>
            );
        };

        const BulkImportView = ({ onImportComplete, user, currentProfile, settings }) => {
            const [textInput, setTextInput] = useState('');
            const [parsedItems, setParsedItems] = useState([]);
            const [step, setStep] = useState('input');
            const [isImporting, setIsImporting] = useState(false);
            const [progress, setProgress] = useState(0);

            if (currentProfile.id === 'all_stores') {
                return <div className="p-10 text-center text-slate-500">Mode Gabungan (View Only). Silakan pilih toko spesifik untuk import data.</div>;
            }

            const handleParse = () => {
                if (!textInput.trim()) return;
                const lines = textInput.split('\n');
                const results = [];
                lines.forEach((line) => {
                    if (!line.trim()) return;
                    let delimiter = ',';
                    if (line.includes('\t')) delimiter = '\t';
                    const parts = line.split(delimiter);
                    const name = parts[0]?.trim();
                    const qty = parts[1]?.trim() ? parseFloat(parts[1].trim().replace(',', '.')) : 0;
                    const unit = parts[2]?.trim() || 'Pcs';
                    const rack = parts[3]?.trim() || '-';
                    const exp = parts[4]?.trim() || '';
                    const price = parts[5]?.trim() ? parseFloat(parts[5].trim().replace(/[Rp.,]/g, '')) : 0;
                    if (name) results.push({ name, qty: safeNumber(qty), unit, rack, exp, price: safeNumber(price) });
                });
                setParsedItems(results);
                setStep('preview');
            };

            const handleBulkSave = async () => {
                if (!user) return;
                setIsImporting(true);
                let successCount = 0;
                try {
                    const batchSize = 400; const chunks = [];
                    for (let i = 0; i < parsedItems.length; i += batchSize) { chunks.push(parsedItems.slice(i, i + batchSize)); }
                    
                    const collectionRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory');
                    const profiles = settings.storeProfiles || [{id: 'default'}];

                    for (let i = 0; i < chunks.length; i++) {
                        const batch = window.writeBatch(window.db);
                        chunks[i].forEach(item => {
                            const docRef = window.doc(collectionRef);
                            
                            // Initialize stocks object
                            const stocksMap = {};
                            profiles.forEach(p => {
                                if (p.id === currentProfile.id) {
                                    // This store gets the imported quantity
                                    stocksMap[p.id] = item.qty;
                                } else {
                                    // OTHER STORES GET 0 EXPLICITLY
                                    stocksMap[p.id] = 0;
                                }
                            });

                            batch.set(docRef, { 
                                name: item.name, 
                                unit: item.unit, 
                                rack: item.rack, 
                                exp: item.exp, 
                                price: item.price, 
                                stocks: stocksMap, // Uses the map where others are 0
                                qty: item.qty, // Legacy total qty field
                                createdAt: window.serverTimestamp(), 
                                updatedAt: window.serverTimestamp() 
                            });
                        });
                        await batch.commit();
                        successCount += chunks[i].length;
                        setProgress(Math.round(((i + 1) / chunks.length) * 100));
                    }
                    setIsImporting(false);
                    onImportComplete(successCount);
                    setTextInput(''); setParsedItems([]); setStep('input'); setProgress(0);
                } catch (error) { console.error("Bulk Import Error:", error); setIsImporting(false); alert("Terjadi kesalahan saat import data."); }
            };

            const exampleText = `Amoxsan 500mg, 10, Box, A-1, , 50000\nParacetamol Sirup, 5, Botol, B-2, 2024-12-31, 15000\nVitamin C IPI, 50, Botol, Kasir, , 8000`;

            return (
                <div className="fade-in max-w-2xl mx-auto w-full pt-4 md:pt-10">
                    <div className="bg-white/80 backdrop-blur-md p-6 rounded-[30px] shadow-soft border border-white">
                        <header className="mb-6 flex items-center gap-4"><div className="w-12 h-12 bg-sky-50 text-sky-600 rounded-2xl flex items-center justify-center text-xl shadow-sm"><Icon name="file-import" /></div><div><h2 className="text-xl font-bold text-slate-800">Import Masal</h2><p className="text-xs text-slate-400">Menambah stok ke: <b>{currentProfile.name}</b></p></div></header>
                        {step === 'input' ? (<div className="space-y-4"><div className="bg-slate-50 p-3 rounded-xl border border-slate-200 text-xs text-slate-600"><p className="font-bold mb-1">Format (Excel/Tab atau Koma):</p><code className="block bg-slate-100 p-2 rounded text-slate-800 font-mono border border-slate-200">Nama, Qty, Satuan, Rak, Exp, Harga</code><button onClick={() => setTextInput(exampleText)} className="mt-2 text-[10px] font-bold text-sky-500 hover:underline">+ Pakai Contoh Format</button></div><textarea className="w-full h-48 p-4 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-2 focus:ring-sky-200 outline-none text-sm font-mono whitespace-pre" placeholder={`Paste data Excel di sini...\nContoh:\nPanadol, 10, strip, A1, , 10000`} value={textInput} onChange={e => setTextInput(e.target.value)}></textarea><button onClick={handleParse} disabled={!textInput.trim()} className="w-full py-3.5 rounded-xl bg-sky-600 hover:bg-sky-700 text-white font-bold shadow-lg shadow-sky-200 active:scale-95 transition-all flex items-center justify-center gap-2 text-sm disabled:opacity-50 disabled:scale-100"><Icon name="magnifying-glass-chart" /> Analisa Data</button></div>) : (<div className="space-y-4"><div className="flex justify-between items-center"><h3 className="font-bold text-slate-700">Preview ({parsedItems.length} Item)</h3><button onClick={() => setStep('input')} className="text-xs text-slate-400 font-medium hover:text-slate-600">Ubah Data</button></div><div className="max-h-64 overflow-y-auto border border-slate-200 rounded-xl bg-white custom-scrollbar"><table className="w-full text-left border-collapse"><thead className="bg-slate-50 sticky top-0"><tr><th className="p-3 text-[10px] font-bold text-slate-500 uppercase">Nama</th><th className="p-3 text-[10px] font-bold text-slate-500 uppercase">Qty</th><th className="p-3 text-[10px] font-bold text-slate-500 uppercase">Rak</th><th className="p-3 text-[10px] font-bold text-slate-500 uppercase">Harga</th></tr></thead><tbody className="divide-y divide-slate-100">{parsedItems.map((item, idx) => (<tr key={idx} className="text-xs text-slate-700 hover:bg-slate-50"><td className="p-3 font-medium">{item.name}</td><td className="p-3 font-bold">{item.qty} {item.unit}</td><td className="p-3 text-slate-500">{item.rack}</td><td className="p-3 text-slate-500">{formatRupiah(item.price)}</td></tr>))}</tbody></table></div>{isImporting ? (<div className="space-y-2"><div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-sky-500 transition-all duration-300" style={{ width: `${progress}%` }}></div></div><p className="text-center text-xs text-slate-500 font-medium">Menyimpan ke Cloud... {progress}%</p></div>) : (<div className="flex gap-3"><button onClick={() => setStep('input')} className="flex-1 py-3 rounded-xl border border-slate-200 text-slate-600 font-bold text-sm">Kembali</button><button onClick={handleBulkSave} className="flex-1 py-3 rounded-xl bg-sky-600 hover:bg-sky-700 text-white font-bold shadow-lg shadow-sky-200 active:scale-95 transition-all text-sm">Simpan ke Database</button></div>)}</div>)}
                    </div>
                </div>
            );
        };

        const DashboardView = ({ items, onShowLowStock, settings }) => {
            const lowStockThreshold = settings.lowStockThreshold || DEFAULT_SETTINGS.lowStockThreshold;
            const lowStockCount = items.filter(i => { const threshold = i.minStock ? safeNumber(i.minStock) : lowStockThreshold; return safeNumber(i.qty) < threshold; }).length;
            const totalStock = items.reduce((a,b)=> a + safeNumber(b.qty), 0);
            const expiringItems = useMemo(() => { const today = new Date(); today.setHours(0,0,0,0); const threeMonthsLater = new Date(today); threeMonthsLater.setMonth(today.getMonth() + 3); return items.filter(i => { if (!i.exp) return false; const expDate = new Date(i.exp); return expDate <= threeMonthsLater; }).sort((a,b) => new Date(a.exp) - new Date(b.exp)); }, [items]);
            const getDaysRemaining = (dateStr) => { const today = new Date(); today.setHours(0,0,0,0); const exp = new Date(dateStr); return Math.ceil((exp - today) / (1000 * 60 * 60 * 24)); };

            return (
                <div className="space-y-6 fade-in pb-24 md:pb-0">
                    <div className="bg-gradient-to-r from-night-900 to-sky-900 rounded-3xl p-5 md:p-6 text-white relative overflow-hidden shadow-2xl border border-slate-700 group">
                        <div className="absolute right-0 top-0 w-48 h-48 bg-gold-400 opacity-10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                        <div className="relative z-10 flex items-center justify-between">
                            <div><h3 className="font-arab text-2xl md:text-3xl text-gold-400 mb-1">رمضان كريم</h3><p className="text-xs md:text-sm text-slate-300 font-medium opacity-90">Selamat Menunaikan Ibadah Puasa Ramadhan</p><div className="mt-3 inline-flex items-center gap-2 bg-green-500/20 px-3 py-1 rounded-full backdrop-blur-sm border border-green-500/30"><div className="w-2 h-2 rounded-full bg-green-50 animate-pulse"></div><span className="text-[10px] font-bold tracking-wide text-green-300">ONLINE (FIREBASE)</span></div></div>
                            <div className="text-4xl text-gold-500/80 animate-pulse"><Icon name="mosque" /></div>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-2 lg:grid-cols-3 gap-4 relative z-10">
                        <div className="bg-white/80 backdrop-blur-sm p-5 rounded-3xl shadow-soft border border-white relative overflow-hidden group hover:bg-white transition-all">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform text-sky-600"><Icon name="box" className="text-5xl" /></div>
                            <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Jenis Item</p>
                            <h3 className="text-3xl font-black text-slate-800">{items.length}</h3>
                        </div>
                        
                        <div className="bg-white/80 backdrop-blur-sm p-5 rounded-3xl shadow-soft border border-white relative overflow-hidden group hover:bg-white transition-all">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform text-slate-500"><Icon name="layer-group" className="text-5xl" /></div>
                            <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Stok Unit (Toko Ini)</p>
                            <h3 className="text-3xl font-black text-slate-800">{totalStock}</h3>
                        </div>

                        <button onClick={onShowLowStock} className="col-span-2 lg:col-span-1 bg-gradient-to-r from-white to-amber-50/50 backdrop-blur-sm p-5 rounded-3xl shadow-soft border border-white text-left hover:border-amber-300 transition-all group relative overflow-hidden">
                            <div className="flex items-center justify-between relative z-10">
                                <div>
                                    <div className="flex items-center gap-2 mb-1">
                                        <div className="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></div>
                                        <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Perlu Restock</p>
                                    </div>
                                    <h3 className="text-3xl font-black text-slate-800 flex items-baseline gap-2">{lowStockCount} <span className="text-sm font-medium text-slate-400">item</span></h3>
                                </div>
                                <div className="w-10 h-10 bg-amber-100 text-amber-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform shadow-sm"><Icon name="triangle-exclamation" className="text-lg" /></div>
                            </div>
                        </button>
                    </div>

                    <div className="bg-white/90 backdrop-blur-md rounded-[24px] border border-white shadow-soft overflow-hidden relative z-10">
                        <div className="p-5 border-b border-slate-50 flex items-center justify-between bg-white/50">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-lg bg-red-50 text-red-500 flex items-center justify-center"><Icon name="clock" /></div>
                                <div><h3 className="font-bold text-slate-800 text-sm">Mendekati Kadaluarsa</h3><p className="text-[10px] text-slate-400 font-bold uppercase tracking-wide">Estimasi &lt; 3 Bulan</p></div>
                            </div>
                            <span className="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-md">{expiringItems.length} Item</span>
                        </div>
                        <div className="max-h-[300px] overflow-y-auto custom-scrollbar p-2">
                            {expiringItems.length === 0 ? (<div className="py-10 text-center"><Icon name="calendar-check" className="text-4xl text-slate-200 mb-2" /><p className="text-slate-400 text-xs">Aman! Tidak ada barang expired dalam 3 bulan.</p></div>) : (
                                <div className="grid gap-2">{expiringItems.map((item, idx) => { 
                                    const daysLeft = getDaysRemaining(item.exp); 
                                    const isExpired = daysLeft !== null && daysLeft < 0; 
                                    const isCritical = daysLeft < 30; 
                                    return (
                                        <div key={idx} className="flex items-center justify-between p-3 rounded-xl bg-slate-50 border border-slate-100 hover:bg-white hover:shadow-sm transition-all">
                                            <div className="flex items-center gap-3 min-w-0">
                                                <div className="min-w-0">
                                                    <h4 className="text-xs font-bold text-slate-700 truncate">{item.name}</h4>
                                                    <div className="flex items-center gap-2 mt-0.5">
                                                        <span className="text-[10px] text-slate-500 flex items-center gap-1"><Icon name="calendar" className="text-[8px]" /> {formatDateIndo(item.exp)}</span>
                                                        <span className="text-[10px] text-slate-400">• Rak {item.rack || '-'}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right flex-shrink-0 pl-2">
                                                <span className={`block text-[10px] font-bold ${isExpired ? 'text-red-600' : (isCritical ? 'text-amber-600' : 'text-slate-600')}`}>{isExpired ? 'SUDAH EXP' : `${daysLeft} Hari Lagi`}</span>
                                                <span className="text-[10px] font-medium text-slate-400">Stok: {item.qty}</span>
                                            </div>
                                        </div>
                                    )})}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ListView = ({ items, searchQuery, setSearchQuery, onEdit, onDelete, onDeleteRack, showOnlyLowStock, setShowOnlyLowStock, selectedRacks, setSelectedRacks, uniqueRacksData, onCopySuccess, loading, settings, currentProfile }) => {
            const [isRackDropdownOpen, setIsRackDropdownOpen] = useState(false);
            const [rackSearch, setRackSearch] = useState('');
            const dropdownRef = useRef(null);
            
            const ITEMS_PER_PAGE = 20;
            const [displayedLimit, setDisplayedLimit] = useState(ITEMS_PER_PAGE);
            const loaderRef = useRef(null);
            const lowStockThreshold = settings.lowStockThreshold || DEFAULT_SETTINGS.lowStockThreshold;

            useEffect(() => {
                const handleClickOutside = (event) => { if (dropdownRef.current && !dropdownRef.current.contains(event.target)) { setIsRackDropdownOpen(false); } };
                document.addEventListener("mousedown", handleClickOutside); return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const fuse = useMemo(() => new Fuse(items, { keys: ['name'], threshold: 0.3, ignoreLocation: true, minMatchCharLength: 2, }), [items]);

            const filteredItems = useMemo(() => {
                let result = items;
                if (searchQuery) { result = fuse.search(searchQuery).map(({ item }) => item); }
                return result.filter(i => {
                    const threshold = i.minStock ? safeNumber(i.minStock) : lowStockThreshold;
                    const matchesLowStock = showOnlyLowStock ? safeNumber(i.qty) < threshold : true;
                    let matchesRack = true;
                    if (selectedRacks.length > 0) { const itemRackLower = (i.rack || '-').toLowerCase(); matchesRack = selectedRacks.some(selected => itemRackLower.includes(selected.toLowerCase())); }
                    return matchesLowStock && matchesRack;
                });
            }, [items, searchQuery, showOnlyLowStock, selectedRacks, fuse, lowStockThreshold]);

            useEffect(() => { setDisplayedLimit(ITEMS_PER_PAGE); }, [searchQuery, showOnlyLowStock, selectedRacks]);

            useEffect(() => {
                const observer = new IntersectionObserver((entries) => { const target = entries[0]; if (target.isIntersecting && displayedLimit < filteredItems.length) { setDisplayedLimit(prev => Math.min(prev + ITEMS_PER_PAGE, filteredItems.length + ITEMS_PER_PAGE)); } }, { root: null, rootMargin: "100px", threshold: 0.1 });
                if (loaderRef.current) observer.observe(loaderRef.current); return () => { if (loaderRef.current) observer.unobserve(loaderRef.current); }
            }, [filteredItems.length, displayedLimit]);

            // --- EXPORT EXCEL FUNCTION (UPDATED FOR BOLD HEADERS & CENTERED STOCKS) ---
            const handleExportExcel = () => {
                if (currentProfile.id !== 'all_stores') return;
                
                const profiles = settings.storeProfiles || [];
                
                // Construct HTML for Excel
                // Using a simple HTML table allows for formatting like BOLD headers
                let html = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                    <head>
                        <!--[if gte mso 9]>
                        <xml>
                            <x:ExcelWorkbook>
                                <x:ExcelWorksheets>
                                    <x:ExcelWorksheet>
                                        <x:Name>Stok Gabungan</x:Name>
                                        <x:WorksheetOptions>
                                            <x:DisplayGridlines/>
                                        </x:WorksheetOptions>
                                    </x:ExcelWorksheet>
                                </x:ExcelWorksheets>
                            </x:ExcelWorkbook>
                        </xml>
                        <![endif]-->
                        <style>
                            th { font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; padding: 5px; }
                            td { border: 1px solid #ccc; padding: 5px; }
                        </style>
                    </head>
                    <body>
                        <table>
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Nama Barang</th>
                                    <th style="text-align: center;">Stok (Total Gabungan)</th>
                                    ${profiles.map(p => `<th style="text-align: center;">${p.name}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Data Rows
                filteredItems.forEach(item => {
                    let total = 0;
                    const perStore = profiles.map(p => {
                        const qty = (item.stocks && item.stocks[p.id]) ? item.stocks[p.id] : 0;
                        total += qty;
                        return qty;
                    });
                    
                    // Note: item.qty is already the total in 'all_stores' mode
                    
                    html += `
                        <tr>
                            <td style="text-align: left;">${item.name}</td>
                            <td style="text-align: center;">${total}</td>
                            ${perStore.map(val => `<td style="text-align: center;">${val}</td>`).join('')}
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </body>
                    </html>
                `;

                // Download
                const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.setAttribute("download", `Stok_Gabungan_${new Date().toLocaleDateString('id-ID').replace(/\//g, '-')}.xls`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                onCopySuccess("File Excel berhasil diunduh (Header Bold & Center)!");
            };

            const handleCopyToWA = () => {
                const now = new Date(); const dateStr = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getFullYear()).slice(-2)}`;
                let title = `${currentProfile.name}`; if (showOnlyLowStock) title += " (MENIPIS)";
                if (filteredItems.length === 0) { alert("Tidak ada data!"); return; }
                let text = `*[Stok ${title}]*\n*🗓️${dateStr}*\n------------------\n\n`;
                const processItems = (itemList) => {
                    const itemsByRack = {};
                    itemList.forEach(item => { let rackName = item.rack && item.rack.trim() !== '-' && item.rack.trim() !== '' ? item.rack.trim() : 'NO RACK'; let rackKey = rackName.toUpperCase(); if (!itemsByRack[rackKey]) { itemsByRack[rackKey] = { name: rackName, items: [] }; } itemsByRack[rackKey].items.push(item); });
                    let content = "";
                    Object.keys(itemsByRack).sort().forEach(key => { const group = itemsByRack[key]; content += `*${group.name}*\n`; group.items.forEach((item, idx) => { content += `${idx+1}. ${item.name} (${item.qty} ${item.unit})\n`; }); content += `\n`; });
                    return content;
                };
                text += processItems(filteredItems); text = text.trimEnd() + `\n\nTotal Item: ${filteredItems.length}`;
                if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(text).then(() => onCopySuccess("Disalin! Tempel di WA.")).catch(() => fallbackCopy(text)); } else { fallbackCopy(text); }
            };

            const fallbackCopy = (text) => { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.select(); try { const successful = document.execCommand('copy'); if(successful) onCopySuccess("Disalin! Tempel di WA."); } catch (err) {} document.body.removeChild(textArea); };
            
            const debouncedSetSearchQuery = useMemo(() => { let timer; return (val) => { clearTimeout(timer); timer = setTimeout(() => setSearchQuery(val), 300); }; }, []);
            const toggleRack = (rackName) => { setSelectedRacks(prev => { if (prev.includes(rackName)) return prev.filter(r => r !== rackName); return [...prev, rackName]; }); };
            const getRackLabel = () => { if (selectedRacks.length === 0) return "Semua Rak"; if (selectedRacks.length === 1) return selectedRacks[0]; return `${selectedRacks.length} Rak Terpilih`; };
            const filteredRacks = uniqueRacksData.filter(r => r.name.toLowerCase().includes(rackSearch.toLowerCase()));
            const displayedItems = filteredItems.slice(0, displayedLimit);

            return (
                <div className="space-y-4 fade-in h-full flex flex-col relative z-10">
                    <header className="flex flex-col gap-3">
                        {/* Desktop Layout - Rack Filter First */}
                        <div className="hidden md:flex md:flex-row md:items-start justify-between gap-3">
                            <div className="flex-1">
                                <h2 className="text-2xl font-extrabold text-slate-800 tracking-tight drop-shadow-sm">{showOnlyLowStock ? '⚠️ Stok Menipis' : 'Daftar Barang'}</h2>
                                <p className="text-slate-500 text-xs mt-1">Stok: <b>{currentProfile.name}</b> • Total: {filteredItems.length}</p>
                            </div>
                            <div className="flex flex-wrap gap-2 items-start">
                                {/* Rack Filter - Paling Depan di Desktop */}
                                <div className="relative min-w-[180px] order-1" ref={dropdownRef}>
                                    <button onClick={() => setIsRackDropdownOpen(!isRackDropdownOpen)} className={`w-full py-2.5 px-3 rounded-lg border border-slate-200 bg-white text-[10px] font-bold text-slate-700 shadow-sm flex items-center justify-between transition-all ${isRackDropdownOpen ? 'ring-2 ring-sky-500' : ''}`}><span className="truncate max-w-[120px]">{getRackLabel()}</span><Icon name="chevron-down" className={`text-xs text-slate-400 ml-2 transition-transform ${isRackDropdownOpen ? 'rotate-180' : ''}`} /></button>
                                    {isRackDropdownOpen && (<div className="absolute top-full left-0 mt-2 w-80 bg-white rounded-xl shadow-2xl border border-slate-100 z-[70] overflow-hidden fade-in origin-top"><div className="p-3 border-b border-slate-50 sticky top-0 bg-white z-10"><div className="relative mb-2"><input autoFocus type="text" placeholder="Cari rak..." className="w-full pl-8 pr-8 py-2 rounded-lg bg-slate-50 border border-slate-200 text-xs font-medium focus:ring-2 focus:ring-sky-100 focus:border-sky-400 outline-none transition-all" value={rackSearch} onChange={(e) => setRackSearch(e.target.value)} /><Icon name="magnifying-glass" className="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-400" />{rackSearch && (<button onClick={() => setRackSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 w-5 h-5 flex items-center justify-center rounded-full text-slate-400 hover:bg-slate-200 hover:text-slate-600 transition-colors"><Icon name="xmark" className="text-[10px]" /></button>)}</div><button onClick={() => setSelectedRacks([])} className="w-full py-1.5 text-[10px] font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 rounded-md transition-colors">Reset (Tampilkan Semua)</button></div><div className="max-h-[300px] overflow-y-auto custom-scrollbar p-1.5 space-y-0.5">{filteredRacks.map(rack => { const isSelected = selectedRacks.includes(rack.name); return (<div key={rack.name} onClick={() => toggleRack(rack.name)} className={`group w-full text-left px-3 py-2.5 rounded-lg text-xs font-medium hover:bg-slate-50 transition-colors flex items-center justify-between cursor-pointer ${isSelected ? 'bg-sky-50/60' : ''}`}><div className="flex items-center gap-3 truncate flex-1"><div className="relative w-4 h-4 flex-shrink-0"><input type="checkbox" checked={isSelected} readOnly className="peer appearance-none w-4 h-4 border-2 border-slate-300 rounded checked:bg-sky-500 checked:border-sky-500 transition-all cursor-pointer" /><Icon name="check" className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[10px] text-white opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity" /></div><span className="truncate flex-1">{rack.name}</span></div><div className="flex items-center gap-2">{rack.hasNew && (<span className="flex-shrink-0 bg-rose-500 text-white text-[8px] font-black px-1.5 py-0.5 rounded-sm animate-pulse">NEW</span>)}<button onClick={(e) => { e.stopPropagation(); onDeleteRack(rack.name); }} className="w-6 h-6 flex items-center justify-center rounded text-slate-300 hover:text-red-500 hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100" title="Hapus Rak"><Icon name="trash-can" /></button></div></div>); })}{filteredRacks.length === 0 && (<div className="flex flex-col items-center justify-center py-6 text-slate-400"><Icon name="box-open" className="text-xl mb-1 opacity-50" /><p className="text-[10px]">Rak tidak ditemukan</p></div>)}</div></div>)}
                                </div>
                                {selectedRacks.length > 0 && (<button onClick={() => setSelectedRacks([])} className="py-2 px-2.5 rounded-lg text-[10px] font-bold bg-slate-100 text-slate-600 hover:bg-slate-200 border border-slate-200 whitespace-nowrap order-2">Reset</button>)}
                                <button onClick={() => setShowOnlyLowStock(!showOnlyLowStock)} className={`py-2 px-3 rounded-lg font-bold text-[10px] flex items-center gap-2 transition-all border min-w-[90px] whitespace-nowrap order-3 ${showOnlyLowStock ? 'bg-amber-50 border-amber-200 text-amber-700' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}><Icon name="filter" /> {showOnlyLowStock ? 'Reset Low' : 'Filter Low'}</button>
                                <button onClick={handleCopyToWA} className="py-2 px-3 rounded-lg font-bold text-[10px] flex items-center gap-2 transition-all bg-[#25D366] hover:bg-[#128C7E] text-white shadow-md active:scale-95 whitespace-nowrap order-4"><Icon name="whatsapp" type="brands" className="text-sm" /> Salin WA</button>
                                {currentProfile.id === 'all_stores' && (
                                    <button onClick={handleExportExcel} className="py-2 px-3 rounded-lg font-bold text-[10px] flex items-center gap-2 transition-all bg-emerald-600 hover:bg-emerald-700 text-white shadow-md active:scale-95 whitespace-nowrap order-5">
                                        <Icon name="file-excel" /> Export Excel
                                    </button>
                                )}
                            </div>
                        </div>
                        
                        {/* Mobile Layout - Original */}
                        <div className="flex md:hidden flex-col gap-3">
                            <div>
                                <h2 className="text-2xl font-extrabold text-slate-800 tracking-tight drop-shadow-sm">{showOnlyLowStock ? '⚠️ Stok Menipis' : 'Daftar Barang'}</h2>
                                <p className="text-slate-500 text-xs mt-1">Stok: <b>{currentProfile.name}</b> • Total: {filteredItems.length}</p>
                            </div>
                            <div className="flex flex-nowrap gap-2 items-end overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-slate-300 scrollbar-track-transparent hover:scrollbar-thumb-slate-400">
                                {currentProfile.id === 'all_stores' && (
                                    <button onClick={handleExportExcel} className="py-2 px-3 rounded-lg font-bold text-[10px] flex items-center gap-2 transition-all bg-emerald-600 hover:bg-emerald-700 text-white shadow-md active:scale-95 whitespace-nowrap flex-shrink-0">
                                        <Icon name="file-excel" /> Export Excel
                                    </button>
                                )}
                                <button onClick={handleCopyToWA} className="py-2 px-3 rounded-lg font-bold text-[10px] flex items-center gap-2 transition-all bg-[#25D366] hover:bg-[#128C7E] text-white shadow-md active:scale-95 whitespace-nowrap flex-shrink-0"><Icon name="whatsapp" type="brands" className="text-sm" /> Salin WA</button>
                                <button onClick={() => setShowOnlyLowStock(!showOnlyLowStock)} className={`py-2 px-3 rounded-lg font-bold text-[10px] flex items-center gap-2 transition-all border min-w-[90px] whitespace-nowrap flex-shrink-0 ${showOnlyLowStock ? 'bg-amber-50 border-amber-200 text-amber-700' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}><Icon name="filter" /> {showOnlyLowStock ? 'Reset Low' : 'Filter Low'}</button>
                                <div className="relative min-w-[140px] flex-shrink-0" ref={dropdownRef}>
                                    <button onClick={() => setIsRackDropdownOpen(!isRackDropdownOpen)} className={`w-full py-2.5 px-3 rounded-lg border border-slate-200 bg-white text-[10px] font-bold text-slate-700 shadow-sm flex items-center justify-between transition-all ${isRackDropdownOpen ? 'ring-1 ring-sky-500' : ''}`}><span className="truncate max-w-[100px]">{getRackLabel()}</span><Icon name="chevron-down" className={`text-xs text-slate-400 ml-2 transition-transform ${isRackDropdownOpen ? 'rotate-180' : ''}`} /></button>
                                    {isRackDropdownOpen && (<div className="fixed top-auto left-4 right-4 mt-2 w-auto bg-white rounded-xl shadow-2xl border border-slate-100 z-[70] overflow-hidden fade-in origin-top"><div className="p-3 border-b border-slate-50 sticky top-0 bg-white z-10"><div className="relative mb-2"><input autoFocus type="text" placeholder="Cari rak..." className="w-full pl-8 pr-8 py-2 rounded-lg bg-slate-50 border border-slate-200 text-xs font-medium focus:ring-2 focus:ring-sky-100 focus:border-sky-400 outline-none transition-all" value={rackSearch} onChange={(e) => setRackSearch(e.target.value)} /><Icon name="magnifying-glass" className="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-400" />{rackSearch && (<button onClick={() => setRackSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 w-5 h-5 flex items-center justify-center rounded-full text-slate-400 hover:bg-slate-200 hover:text-slate-600 transition-colors"><Icon name="xmark" className="text-[10px]" /></button>)}</div><button onClick={() => setSelectedRacks([])} className="w-full py-1.5 text-[10px] font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 rounded-md transition-colors">Reset (Tampilkan Semua)</button></div><div className="max-h-[240px] overflow-y-auto custom-scrollbar p-1.5 space-y-0.5">{filteredRacks.map(rack => { const isSelected = selectedRacks.includes(rack.name); return (<div key={rack.name} onClick={() => toggleRack(rack.name)} className={`group w-full text-left px-3 py-2.5 rounded-lg text-xs font-medium hover:bg-slate-50 transition-colors flex items-center justify-between cursor-pointer ${isSelected ? 'bg-sky-50/60' : ''}`}><div className="flex items-center gap-3 truncate flex-1"><div className="relative w-4 h-4 flex-shrink-0"><input type="checkbox" checked={isSelected} readOnly className="peer appearance-none w-4 h-4 border-2 border-slate-300 rounded checked:bg-sky-500 checked:border-sky-500 transition-all cursor-pointer" /><Icon name="check" className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[10px] text-white opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity" /></div><span className="truncate flex-1">{rack.name}</span></div><div className="flex items-center gap-2">{rack.hasNew && (<span className="flex-shrink-0 bg-rose-500 text-white text-[8px] font-black px-1.5 py-0.5 rounded-sm animate-pulse">NEW</span>)}<button onClick={(e) => { e.stopPropagation(); onDeleteRack(rack.name); }} className="w-6 h-6 flex items-center justify-center rounded text-slate-300 hover:text-red-500 hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100" title="Hapus Rak"><Icon name="trash-can" /></button></div></div>); })}{filteredRacks.length === 0 && (<div className="flex flex-col items-center justify-center py-6 text-slate-400"><Icon name="box-open" className="text-xl mb-1 opacity-50" /><p className="text-[10px]">Rak tidak ditemukan</p></div>)}</div></div>)}
                                </div>
                                {selectedRacks.length > 0 && (<button onClick={() => setSelectedRacks([])} className="py-2 px-2.5 rounded-lg text-[10px] font-bold bg-slate-100 text-slate-600 hover:bg-slate-200 border border-slate-200 whitespace-nowrap flex-shrink-0">Reset</button>)}
                            </div>
                        </div>
                    </header>
                    <div className="relative group z-10"><input type="text" placeholder="Cari nama barang..." className="w-full pl-9 pr-3 py-3 rounded-xl border-0 bg-white/90 backdrop-blur-sm shadow-soft ring-1 ring-slate-100 outline-none transition-all placeholder:text-slate-400 font-medium text-sm focus:ring-2 focus:ring-sky-500" defaultValue={searchQuery} onChange={e => debouncedSetSearchQuery(e.target.value)} /><Icon name="magnifying-glass" className="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-sm transition-colors group-focus-within:text-slate-600" /></div>
                    <div className="flex-1 overflow-y-auto pb-32 pr-1 custom-scrollbar">
                        {loading ? (<div className="flex flex-col items-center justify-center py-20"><div className="typing-dot bg-sky-500"></div><p className="text-xs text-slate-400 mt-2">Menghubungkan Database...</p></div>) : filteredItems.length === 0 ? (<div className="flex flex-col items-center justify-center py-20 opacity-40"><div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3"><Icon name="box-open" className="text-2xl text-slate-400" /></div><p className="font-semibold text-slate-500 text-center text-sm">Tidak ada data</p></div>) : (<><div className="space-y-2">{displayedItems.map((item, index) => { const threshold = item.minStock ? safeNumber(item.minStock) : lowStockThreshold; const isLow = safeNumber(item.qty) < threshold; const isNew = isNewItem(item.createdAt); const animDelay = `${index * 50}ms`; const nameClass = searchQuery ? "type-effect-wrapper" : ""; const daysLeft = getDaysRemaining(item.exp); const isExpired = daysLeft !== null && daysLeft < 0; const isNearExp = daysLeft !== null && daysLeft < 90 && !isExpired; const expColor = isExpired ? 'text-red-600' : (isNearExp ? 'text-amber-600' : 'text-slate-400'); const expIcon = isExpired ? 'triangle-exclamation' : 'calendar-days'; return (<div key={item.id + searchQuery} style={{ animationDelay: animDelay }} className={`slide-up bg-white/90 backdrop-blur-sm rounded-xl p-3 border shadow-sm transition-all card-hover group flex items-center justify-between gap-3 ${isLow ? 'border-amber-200 bg-amber-50/30' : 'border-slate-100 hover:border-slate-300'}`}><div className="flex items-center gap-3 flex-1 min-w-0"><div className={`w-9 h-9 flex-shrink-0 rounded-lg flex items-center justify-center text-sm shadow-sm ${isLow ? 'bg-amber-100 text-amber-600' : 'bg-sky-50 text-sky-600'}`}><Icon name={isLow ? 'triangle-exclamation' : 'pills'} /></div><div className="min-w-0"><div className="flex items-start gap-2"><h4 className={`font-bold text-slate-800 text-xs leading-snug whitespace-normal break-words ${nameClass}`}>{item.name}</h4>{isNew && <span className="bg-rose-500 text-white text-[8px] font-black px-1.5 py-0.5 rounded-sm animate-pulse shadow-sm flex-shrink-0 mt-0.5">NEW</span>}</div><div className="mt-1 flex flex-col gap-0.5"><span className="inline-flex items-center gap-1 text-[9px] font-bold text-slate-400"><Icon name="location-dot" className="text-[8px]" /> {item.rack || '-'}</span>{item.exp && (<span className={`inline-flex items-center gap-1 text-[9px] font-bold ${expColor}`}><Icon name={expIcon} className="text-[8px]" /> {formatDateIndo(item.exp)}</span>)}
                            {currentProfile.id === 'all_stores' && item._breakdown && item._breakdown.length > 0 && (
                                <div className="mt-2 flex flex-col gap-1 w-full">
                                    {item._breakdown.map((info, idx) => {
                                        const separatorIndex = info.lastIndexOf(':');
                                        const storeName = info.substring(0, separatorIndex).trim();
                                        const storeQty = info.substring(separatorIndex + 1).trim();
                                        const isZero = parseInt(storeQty) === 0;

                                        return (
                                            <div key={idx} className="flex justify-between items-center text-[10px] bg-slate-50 border border-slate-200 px-2 py-1 rounded">
                                                <span className="text-slate-500 font-medium mr-2 text-left">{storeName}</span>
                                                <span className={`font-bold px-1.5 rounded border ${isZero ? 'bg-slate-100 text-slate-400 border-slate-200' : 'bg-white text-slate-800 border-slate-100'}`}>{storeQty}</span>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div></div></div><div className="flex items-center gap-4 md:gap-8 flex-shrink-0"><div className="text-right"><p className="text-[8px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Stok</p><div className="flex items-baseline justify-end gap-1"><span className={`text-sm font-black ${isLow ? 'text-amber-600' : 'text-slate-800'}`}>{item.qty}</span><span className="text-[9px] font-semibold text-slate-500">{item.unit || 'Pcs'}</span></div>{item.price > 0 && <div className="text-[10px] text-green-600 font-bold mt-0.5 bg-green-50 px-1.5 rounded-md inline-block">{formatRupiah(item.price)}</div>}</div></div><div className="flex gap-1.5 flex-shrink-0 pl-2 border-l border-slate-100 ml-1"><button onClick={() => onEdit(item)} className="w-7 h-7 rounded-lg text-[10px] bg-slate-50 text-slate-500 hover:bg-slate-100 hover:text-slate-800 border border-slate-200 transition-colors flex items-center justify-center"><Icon name="pen" /></button><button onClick={() => onDelete(item)} className="w-7 h-7 rounded-lg text-[10px] bg-white text-slate-400 hover:bg-red-50 hover:text-red-500 border border-slate-200 hover:border-red-200 transition-colors flex items-center justify-center"><Icon name="trash" /></button></div></div>); })}</div><div ref={loaderRef} className="h-10 flex items-center justify-center w-full mt-4 pb-20 md:pb-0">{displayedLimit < filteredItems.length ? (<div className="flex items-center gap-2 text-slate-400 text-xs"><div className="w-4 h-4 border-2 border-slate-300 border-t-sky-500 rounded-full animate-spin"></div><span>Memuat...</span></div>) : filteredItems.length > 0 && ( <span className="text-[10px] text-slate-300">Semua data ditampilkan</span> )}</div></>)}
                    </div>
                </div>
            );
        };

        const FormView = ({ formData, setFormData, onSubmit, isEditing, onCancel, submitting, currentProfile }) => {
            const [selectedStoreForInput, setSelectedStoreForInput] = useState(currentProfile.id === 'all_stores' ? 'default' : currentProfile.id);
            
            // Auto-fill qty dari stok toko yang dipilih saat mode gabungan & sedang edit
            useEffect(() => {
                if (isEditing && currentProfile.id === 'all_stores' && formData.stocks) {
                    const storeQty = formData.stocks[selectedStoreForInput] !== undefined
                        ? formData.stocks[selectedStoreForInput]
                        : 0;
                    setFormData(prev => ({ ...prev, qty: storeQty }));
                }
            }, [selectedStoreForInput, isEditing]);

            const unitOptions = [ "Pcs", "Box", "Botol", "Strip", "Tube", "Ampul", "Vial", "Tablet", "Kapsul", "Sachet", "Pack", "Roll", "Set", "Lembar", "Pasang", "Galon" ];
            
            return (
                <div className="fade-in max-w-xl mx-auto w-full pt-4 md:pt-10">
                    <div className="bg-white/90 backdrop-blur-sm p-6 md:p-8 rounded-[30px] shadow-soft border border-white">
                        <header className="mb-6 text-center"><div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-xl mx-auto mb-3 shadow-lg ${isEditing ? 'bg-slate-100 text-slate-600' : 'bg-sky-50 text-sky-600'}`}><Icon name={isEditing ? 'pen-to-square' : 'circle-plus'} /></div><h2 className="text-xl font-bold text-slate-800">{isEditing ? 'Edit Barang' : 'Input Baru'}</h2><p className="text-xs text-slate-400 mt-1">Stok akan ditambahkan ke: <b>{currentProfile.id === 'all_stores' ? 'Pilih toko di bawah' : currentProfile.name}</b></p></header>
                        <form onSubmit={(e) => { e.preventDefault(); onSubmit(e, selectedStoreForInput); }} className="space-y-4">
                            {currentProfile.id === 'all_stores' && (
                                <div className="space-y-1.5 bg-sky-50 border border-sky-200 p-3 rounded-xl">
                                    <label className="text-[10px] font-bold text-sky-700 uppercase tracking-wider ml-1">Pilih Toko Tujuan</label>
                                    <select 
                                        value={selectedStoreForInput} 
                                        onChange={e => setSelectedStoreForInput(e.target.value)}
                                        className="w-full p-3.5 rounded-xl bg-white border border-sky-300 outline-none font-bold text-sm text-slate-700 focus:border-sky-500"
                                        required
                                    >
                                        <option value="">-- Pilih Toko --</option>
                                        {(window.globalSettings?.storeProfiles || [{id: 'default', name: window.APP_NAME || 'Toko Utama'}]).map(profile => (
                                            <option key={profile.id} value={profile.id}>{profile.name}</option>
                                        ))}
                                    </select>
                                </div>
                            )}
                            <div className="space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Nama Produk</label><input className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white outline-none transition-all font-semibold text-sm text-slate-700 focus:border-slate-400" placeholder="Contoh: Paracetamol 500mg" value={formData.name || ''} onChange={e=>setFormData({...formData, name: e.target.value})} required /></div>
                            <div className="grid grid-cols-2 gap-3"><div className="space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Harga Satuan (Rp)</label><input type="number" className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white outline-none transition-all font-bold text-sm text-slate-700 focus:border-slate-400" placeholder="0" value={formData.price || ''} onChange={e=>setFormData({...formData, price: e.target.value})} /></div><div className="space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Lokasi Rak</label><input className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 outline-none font-medium text-sm transition-all focus:bg-white focus:border-slate-400" placeholder="Ex: A-01" value={formData.rack || ''} onChange={e=>setFormData({...formData, rack: e.target.value})} /></div></div>
                            <div className="grid grid-cols-5 gap-3"><div className="col-span-3 space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Jumlah</label><div className="relative"><input type="number" step="any" className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white outline-none transition-all font-bold text-slate-700 text-sm focus:border-slate-400" value={formData.qty || ''} onChange={e=>setFormData({...formData, qty: e.target.value})} placeholder="0" /><div className="absolute right-3 top-1/2 -translate-y-1/2 flex flex-col gap-0.5"><button type="button" onClick={() => setFormData({...formData, qty: safeNumber(formData.qty)+1})} className="w-4 h-4 bg-white rounded shadow text-[8px] text-slate-500 hover:text-brand-600"><Icon name="chevron-up" /></button><button type="button" onClick={() => setFormData({...formData, qty: Math.max(0, safeNumber(formData.qty)-1)})} className="w-4 h-4 bg-white rounded shadow text-[8px] text-slate-500 hover:text-red-600"><Icon name="chevron-down" /></button></div></div></div><div className="col-span-2 space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Satuan</label><select className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 outline-none appearance-none font-medium text-sm text-slate-600 focus:border-slate-400" value={formData.unit || 'Pcs'} onChange={e=>setFormData({...formData, unit: e.target.value})}>{unitOptions.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                            <div className="space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Kadaluarsa</label><input type="date" className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 outline-none font-medium text-sm transition-all focus:bg-white text-slate-600 focus:border-slate-400" value={formData.exp || ''} onChange={e=>setFormData({...formData, exp: e.target.value})} /></div>
                            <div className="space-y-1.5 bg-slate-50 p-3 rounded-xl border border-dashed border-slate-200"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1 flex justify-between">Minimum Stok (Khusus) <span className="text-[9px] font-normal lowercase text-slate-400">kosongkan jika ikut aturan global</span></label><input type="number" className="w-full p-2.5 rounded-lg bg-white border border-slate-200 focus:border-sky-500 outline-none text-sm" placeholder="Contoh: 10 (Item ini akan 'Low' jika dibawah 10)" value={formData.minStock || ''} onChange={e=>setFormData({...formData, minStock: e.target.value})} /></div>
                            <div className="pt-4 flex gap-3">{isEditing && (<button type="button" disabled={submitting} onClick={onCancel} className="flex-1 py-3.5 rounded-xl text-slate-600 font-bold bg-white border border-slate-200 hover:bg-slate-50 text-sm transition-colors">Batal</button>)}<button type="submit" disabled={submitting} className={`flex-1 py-3.5 rounded-xl text-white font-bold shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 text-sm disabled:opacity-50 ${isEditing ? 'bg-slate-700 hover:bg-slate-800' : 'bg-sky-600 hover:bg-sky-700 shadow-sky-200'}`}>{submitting ? <div className="typing-dot bg-white" /> : <Icon name={isEditing ? 'check' : 'plus'} />} {submitting ? 'Menyimpan...' : (isEditing ? 'Simpan' : 'Tambah')}</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [inventoryData, setInventoryData] = useState([]);
            const [rawInventory, setRawInventory] = useState([]);
            const [settingsData, setSettingsData] = useState(DEFAULT_SETTINGS); 
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('home'); 
            const [searchQuery, setSearchQuery] = useState('');
            const [showOnlyLowStock, setShowOnlyLowStock] = useState(false);
            const [selectedRacks, setSelectedRacks] = useState([]);
            const [formData, setFormData] = useState({ name: '', qty: '', unit: 'Pcs', exp: '', rack: '', price: '', minStock: '' });
            const [editingItem, setEditingItem] = useState(null); 
            const [deleteModal, setDeleteModal] = useState({ show: false, item: null });
            const [deleteRackModal, setDeleteRackModal] = useState({ show: false, rackName: null });
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            const [submitting, setSubmitting] = useState(false);
            const [user, setUser] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [receiptToPrint, setReceiptToPrint] = useState(null);
            const [isGeneratingImage, setIsGeneratingImage] = useState(false);
            const [activeStoreId, setActiveStoreId] = useState(localStorage.getItem('activeStoreId') || 'default');
            const [showStoreMenu, setShowStoreMenu] = useState(false);
            const hasSetInitialTab = useRef(false);
            
            // Notification State
            const [showNotifications, setShowNotifications] = useState(false);

            useEffect(() => { const initAuth = async () => { if (window.initialAuthToken) { await window.signInWithCustomToken(window.auth, window.initialAuthToken); } else { await window.signInAnonymously(window.auth); } }; initAuth(); const unsubscribeAuth = window.onAuthStateChanged(window.auth, (currentUser) => { setUser(currentUser); if (!currentUser) setLoading(true); }); return () => unsubscribeAuth(); }, []);
            useEffect(() => { const globalClickHandler = (e) => { triggerFireworks(e.clientX, e.clientY); }; window.addEventListener('click', globalClickHandler); return () => window.removeEventListener('click', globalClickHandler); }, []);

            useEffect(() => {
                if(!user) return;
                const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings', 'global');
                const unsub = window.onSnapshot(docRef, (docSnap) => { 
                    if(docSnap.exists()){ 
                        const fetched = docSnap.data();
                        const newSettings = { ...DEFAULT_SETTINGS, ...fetched };
                        setSettingsData(newSettings);
                        window.globalSettings = newSettings; // Make available globally for FormView
                        const profiles = fetched.storeProfiles || [{ id: 'default' }];
                        if(activeStoreId !== 'all_stores' && !profiles.find(p => p.id === activeStoreId)) { 
                            setActiveStoreId(profiles[0].id); 
                            localStorage.setItem('activeStoreId', profiles[0].id); 
                        }
                    } 
                });
                return () => unsub();
            }, [user, activeStoreId]);

            useEffect(() => {
                if (loading) return;

                // REDIRECT / DEFAULT VIEW LOGIC
                // 'cashbook' is now a hidden tab too
                const hiddenTabs = ['cashier', 'history', 'purchases'];
                
                // 1. Jika fitur dimatikan tapi user ada di tab terlarang -> Paksa ke Dashboard (Home)
                if (!settingsData.showExtraFeatures && hiddenTabs.includes(activeTab)) {
                    setActiveTab('home');
                }

                // 2. Initial Route Logic: Hanya jalankan sekali saat app load/settings pertama kali load
                if (!hasSetInitialTab.current) {
                    if (settingsData.showExtraFeatures) {
                        // Jika Mode Kasir Aktif -> Default ke Kasir
                        setActiveTab('cashier');
                    } else {
                        // Jika Mode Kasir Mati -> Default ke Dashboard
                        setActiveTab('home');
                    }
                    hasSetInitialTab.current = true;
                }

            }, [settingsData.showExtraFeatures, activeTab, loading]);

            useEffect(() => {
                if (!user) return;
                const q = window.query(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory'));
                const unsubscribeSnapshot = window.onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setRawInventory(data); 
                    setLoading(false);
                }, (error) => { console.error("Firestore Error:", error); showToast("Gagal memuat data live", "error"); });
                return () => unsubscribeSnapshot();
            }, [user]);

            useEffect(() => {
                const processed = rawInventory.map(item => {
                    let displayQty = 0;
                    let breakdown = [];
                    if (activeStoreId === 'all_stores') {
                        const profiles = settingsData.storeProfiles || [{id: 'default', name: APP_NAME}];
                        let total = 0;
                        profiles.forEach(p => { const q = (item.stocks && item.stocks[p.id] !== undefined) ? item.stocks[p.id] : (p.id === 'default' ? (item.qty || 0) : 0); total += q; breakdown.push(`${p.name}: ${q}`); });
                        displayQty = total;
                    } else {
                        if (item.stocks && item.stocks[activeStoreId] !== undefined) { displayQty = item.stocks[activeStoreId]; } else if (activeStoreId === 'default') { displayQty = item.qty || 0; } else { displayQty = 0; }
                    }
                    return { ...item, qty: displayQty, _originalQty: item.qty, _breakdown: breakdown };
                });
                processed.sort((a, b) => a.name.localeCompare(b.name));
                setInventoryData(processed);
            }, [rawInventory, activeStoreId, settingsData]);

            const uniqueRacksData = useMemo(() => { const rackMap = new Map(); inventoryData.forEach(item => { if (item.rack && item.rack !== '-') { const racks = item.rack.split(',').map(r => r.trim()); let isItemNew = isNewItem(item.createdAt); racks.forEach(r => { if (!r) return; if (!rackMap.has(r)) rackMap.set(r, { name: r, hasNew: false }); if (isItemNew) rackMap.get(r).hasNew = true; }); } }); return Array.from(rackMap.values()).sort((a, b) => a.name.localeCompare(b.name)); }, [inventoryData]);
            const getCurrentProfile = () => { if (activeStoreId === 'all_stores') { return { id: 'all_stores', name: 'SEMUA TOKO', address: 'Mode Gabungan' }; } const profiles = settingsData.storeProfiles || []; const profile = profiles.find(p => p.id === activeStoreId); return profile || { id: 'default', name: settingsData.storeName || APP_NAME, address: settingsData.storeAddress || '' }; };
            const currentProfile = getCurrentProfile();

            const handleSwitchStore = (profileId) => { setActiveStoreId(profileId); localStorage.setItem('activeStoreId', profileId); setShowStoreMenu(false); showToast(`Profil toko diganti`); };
            const showToast = useCallback((message, type = "success") => { setToast({ show: true, message, type }); setTimeout(() => setToast({ show: false, message: '', type: 'success' }), 3000); }, []);
            const handleGenerateImage = async (transaction) => { setIsGeneratingImage(true); const storeProfiles = settingsData.storeProfiles || []; const txProfile = storeProfiles.find(p => p.id === transaction.storeId) || storeProfiles[0] || {}; setReceiptToPrint({ ...transaction, storeName: txProfile.name || settingsData.storeName, storeAddress: txProfile.address || settingsData.storeAddress, footer: txProfile.footer || settingsData.receiptFooter, headers: txProfile.additionalHeaders || [] }); showToast("Membuat gambar struk..."); setTimeout(async () => { const element = document.getElementById('receipt-hidden-container'); if (!element) { showToast("Gagal menemukan elemen struk", "error"); setIsGeneratingImage(false); return; } try { const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }); canvas.toBlob(async (blob) => { if (!blob) return; const file = new File([blob], `struk-${transaction.id || 'trx'}.jpg`, { type: 'image/jpeg' }); const shareData = { files: [file], title: 'Struk Belanja', text: `Struk Transaksi ${transaction.id || ''}` }; if (navigator.canShare && navigator.canShare(shareData)) { try { await navigator.share(shareData); showToast("Berhasil membuka menu share!"); } catch (err) { const link = document.createElement('a'); link.href = canvas.toDataURL('image/jpeg'); link.download = `struk-${transaction.id}.jpg`; link.click(); } } else { const link = document.createElement('a'); link.href = canvas.toDataURL('image/jpeg'); link.download = `struk-${transaction.id}.jpg`; link.click(); showToast("Gambar diunduh. Kirim manual ke WA Web."); } setIsGeneratingImage(false); setReceiptToPrint(null); }, 'image/jpeg', 0.9); } catch (error) { console.error("Image gen error:", error); showToast("Gagal membuat gambar", "error"); setIsGeneratingImage(false); setReceiptToPrint(null); } }, 500); };

            const handleSubmit = async (e, targetStoreId = null) => {
                if (e) e.preventDefault();
                if (!formData.name?.trim() || !user) return;
                
                // Determine which store to use
                const storeIdToUse = targetStoreId || activeStoreId;
                
                // Validate store selection in all_stores mode
                if (activeStoreId === 'all_stores' && !targetStoreId) {
                    showToast("Pilih toko tujuan terlebih dahulu", "error");
                    return;
                }
                
                setSubmitting(true);
                try {
                    const collectionRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory');
                    const newQty = safeNumber(formData.qty);
                    const baseData = { 
                        name: formData.name, 
                        unit: formData.unit || 'Pcs', 
                        rack: formData.rack || '-', 
                        exp: formData.exp || '', 
                        price: safeNumber(formData.price), 
                        minStock: formData.minStock ? safeNumber(formData.minStock) : null, 
                        updatedAt: window.serverTimestamp() 
                    };

                    const profiles = settingsData.storeProfiles || [{id: 'default'}];

                    if (editingItem) {
                        const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', editingItem.id);
                        const stockUpdate = { [`stocks.${storeIdToUse}`]: newQty };
                        await window.updateDoc(docRef, { ...baseData, ...stockUpdate }); 
                        logToDB('STOK', `Update item ${formData.name} menjadi ${newQty} ${formData.unit}`, storeIdToUse, user.email);
                        const targetProfile = profiles.find(p => p.id === storeIdToUse);
                        showToast(`Stok untuk ${targetProfile?.name || 'toko'} diperbarui`);
                    } else {
                        const initialStocks = {};
                        profiles.forEach(p => {
                            if (p.id === storeIdToUse) {
                                initialStocks[p.id] = newQty;
                            } else {
                                initialStocks[p.id] = 0; 
                            }
                        });

                        const existingItem = rawInventory.find(i => i.name.toLowerCase() === formData.name.toLowerCase());
                        
                        if (existingItem) {
                             const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', existingItem.id);
                             // HANYA update stok toko yang dipilih, TIDAK mengubah harga/rak/exp/satuan
                             const stockOnlyUpdate = {
                                 [`stocks.${storeIdToUse}`]: newQty,
                                 updatedAt: window.serverTimestamp()
                             };
                             await window.updateDoc(docRef, stockOnlyUpdate);
                             logToDB('STOK', `Update stok item ${formData.name} (Existing) menjadi ${newQty} ${formData.unit}`, storeIdToUse, user.email);
                             const targetProfile = profiles.find(p => p.id === storeIdToUse);
                             showToast(`Barang sudah ada. Hanya stok ${targetProfile?.name || 'toko'} yang diupdate.`);
                        } else {
                            await window.addDoc(collectionRef, { 
                                ...baseData, 
                                stocks: initialStocks, 
                                qty: newQty, 
                                createdAt: window.serverTimestamp() 
                            }); 
                            logToDB('STOK', `Tambah item baru ${formData.name} (${newQty} ${formData.unit})`, storeIdToUse, user.email);
                            showToast("Barang baru ditambahkan (Stok toko lain diset 0)");
                        }
                    }
                    setEditingItem(null); 
                    setFormData({ name: '', qty: '', unit: 'Pcs', exp: '', rack: '', price: '', minStock: '' }); 
                    setActiveTab('list');
                } catch (error) { 
                    console.error("Error saving:", error); 
                    showToast("Gagal menyimpan ke database", "error"); 
                } finally { 
                    setSubmitting(false); 
                }
            };

            const handleSaveSettings = async (newSettings) => { if(!user) return; setSubmitting(true); try { const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings', 'global'); await window.setDoc(docRef, newSettings); showToast("Pengaturan disimpan"); } catch(error) { console.error(error); showToast("Gagal simpan pengaturan", "error"); } finally { setSubmitting(false); } };
            const handleDelete = async () => { if (!deleteModal.item || !user) return; try { const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', deleteModal.item.id); await window.deleteDoc(docRef); 
                logToDB('HAPUS', `Hapus permanen item ${deleteModal.item.name}`, 'all_stores', user.email);
                showToast("Barang dihapus (dari semua toko)"); 
            } catch (error) { showToast("Gagal menghapus", "error"); } finally { setDeleteModal({ show: false, item: null }); } };
            
            const handleConfirmDeleteRack = async () => { 
                if (!deleteRackModal.rackName || !user) return; 
                const rackName = deleteRackModal.rackName; 
                try { 
                    const batch = window.writeBatch(window.db); 
                    const itemsToUpdate = inventoryData.filter(item => item.rack && item.rack.includes(rackName)); 
                    if (itemsToUpdate.length === 0) { 
                        showToast("Tidak ada item di rak ini"); 
                        setDeleteRackModal({ show: false, rackName: null }); 
                        return; 
                    } 
                    itemsToUpdate.forEach(item => { 
                        const newRacks = item.rack.split(',').map(r => r.trim()).filter(r => r !== rackName); 
                        const newRackString = newRacks.length > 0 ? newRacks.join(', ') : '-'; 
                        const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', item.id); 
                        batch.update(docRef, { rack: newRackString }); 
                    }); 
                    await batch.commit(); 
                    showToast(`Rak "${rackName}" berhasil dihapus`); 
                    setSelectedRacks([]); 
                } catch (err) { 
                    console.error("Failed delete rack", err); 
                    showToast("Gagal menghapus rak", "error"); 
                } finally { 
                    setDeleteRackModal({ show: false, rackName: null }); 
                } 
            };

            const handleNavClick = (tabId, event) => { setActiveTab(tabId); if (tabId !== 'list') setShowOnlyLowStock(false); setIsSidebarOpen(false); };
            
            // MENU CONFIGURATION
            const allMenuItems = [ 
                { id: 'cashier', label: 'Kasir', icon: 'cash-register', requiresExtra: true }, 
                { id: 'history', label: 'Riwayat', icon: 'clock-rotate-left', requiresExtra: true }, 
                { id: 'purchases', label: 'Faktur Pembelian', icon: 'file-invoice-dollar', requiresExtra: true }, 
                { id: 'home', label: 'Dashboard', icon: 'chart-pie' }, 
                { id: 'list', label: 'Stok Barang', icon: 'boxes-stacked' }, 
                { id: 'transfer', label: 'Transfer Stok', icon: 'arrow-right-arrow-left' }, 
                { id: 'cashbook', label: 'Buku Kas', icon: 'book', requiresExtra: false }, // Updated: requiresExtra: false
                { id: 'add', label: 'Input Manual', icon: 'pen-to-square' }, 
                { id: 'import', label: 'Import Masal', icon: 'file-import' }, 
                { id: 'settings', label: 'Pengaturan', icon: 'gears' } 
            ];

            const menuItems = allMenuItems.filter(item => {
                if (item.requiresExtra && !settingsData.showExtraFeatures) return false;
                return true;
            });

            return (
                <div className={`min-h-screen flex flex-col md:flex-row bg-sky-50/50 transition-colors duration-500 ${activeStoreId === 'all_stores' ? 'theme-all-stores' : ''}`}>
                    <RamadhanDecor /> <Toast show={toast.show} message={toast.message} type={toast.type} /> {isSidebarOpen && (<div className="fixed inset-0 bg-slate-900/50 z-40 md:hidden backdrop-blur-sm fade-in" onClick={() => setIsSidebarOpen(false)}></div>)}
                    <NotificationCenter isOpen={showNotifications} onClose={() => setShowNotifications(false)} user={user} currentProfile={currentProfile} />
                    
                    {receiptToPrint && ( <div style={{ position: 'fixed', top: '-9999px', left: '-9999px', zIndex: -1 }}> <div id="receipt-hidden-container" className="bg-white p-6 w-[380px] text-black font-mono shadow-none" style={{ fontFamily: '"Courier New", Courier, monospace' }}> <div className="text-center mb-4"> <h2 className="text-xl font-bold uppercase">{receiptToPrint.storeName || APP_NAME}</h2> <p className="text-sm text-gray-600"> {receiptToPrint.storeAddress || "Indonesia"} </p> {(receiptToPrint.headers || []).map((h, i) => <p key={i} className="text-sm text-gray-600">{h}</p>)} </div> <div className="border-b-2 border-dashed border-gray-300 my-2"></div> <div className="flex justify-between text-xs mb-1"> <span>Tgl: {new Date(receiptToPrint.date.seconds ? receiptToPrint.date.toDate() : receiptToPrint.date).toLocaleString('id-ID')}</span> </div> <div className="flex justify-between text-xs mb-2"> <span>Ref: {receiptToPrint.id ? receiptToPrint.id.slice(-8).toUpperCase() : '-'}</span> <span>Kasir: {receiptToPrint.cashierName || 'Admin'}</span> </div> <div className="border-b-2 border-dashed border-gray-300 my-2"></div> <div className="space-y-2 mb-4"> {receiptToPrint.items.map((item, idx) => { const validQty = item.cartQty - (item.returnedQty || 0); if (validQty <= 0) return null; return ( <div key={idx} className="text-sm"> <div className="font-bold">{item.name}</div> <div className="flex justify-between"> <span>{validQty} x {formatRupiah(item.price)}</span> <span>{formatRupiah(validQty * item.price)}</span> </div> </div> ); })} </div> <div className="border-b-2 border-dashed border-gray-300 my-2"></div> <div className="flex justify-between font-bold text-lg mb-1"> <span>TOTAL</span> <span>{formatRupiah(receiptToPrint.items.reduce((acc, item) => acc + (item.price * (item.cartQty - (item.returnedQty || 0))), 0))}</span> </div> {receiptToPrint.pay !== undefined && ( <div className="flex justify-between text-sm"> <span>Tunai</span> <span>{formatRupiah(receiptToPrint.pay)}</span> </div> )} {receiptToPrint.change !== undefined && ( <div className="flex justify-between text-sm"> <span>Kembali</span> <span>{formatRupiah(receiptToPrint.change)}</span> </div> )} <div className="border-b-2 border-dashed border-gray-300 my-4"></div> <div className="text-center text-xs text-gray-500 whitespace-pre-wrap"> {receiptToPrint.footer || "Terima Kasih\nBarang tidak dapat ditukar"} </div> {receiptToPrint.status === 'returned' && <div className="mt-4 text-center font-bold text-xl text-red-600 border-2 border-red-600 p-2 transform -rotate-12">TRANSAKSI DIBATALKAN</div>} {receiptToPrint.status === 'partial' && <div className="mt-4 text-center font-bold text-sm text-amber-600">*** ADA RETUR SEBAGIAN ***</div>} </div> </div> )}

                    <aside className={`fixed top-0 left-0 h-full z-50 w-72 md:w-80 bg-white/95 backdrop-blur-xl md:backdrop-blur-md border-r border-slate-200 md:border-white/20 shadow-2xl md:shadow-soft transform transition-transform duration-300 ease-in-out md:translate-x-0 md:static ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 pb-4 h-full flex flex-col">
                            <div className="flex items-center justify-between mb-8">
                                <div className="flex items-center gap-3 relative z-50">
                                    <div className="w-16 h-16 rounded-xl flex items-center justify-center bg-white shadow-lg border border-slate-200"><img src="data:image/png;base64,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" alt="Rafa Medica Logo" className="w-full h-full object-contain rounded-xl" /></div>
                                    <div className="relative">
                                        <button onClick={() => setShowStoreMenu(!showStoreMenu)} className="text-left group flex items-center gap-2 hover:bg-slate-50 p-1 -ml-1 rounded-lg transition-colors">
                                            <div><h1 className="font-black text-base text-sky-600 leading-none tracking-tight">Rafa Medica</h1><p className="text-[10px] font-bold text-slate-600 mt-0.5">{currentProfile.name}</p><p className="text-[8px] font-semibold uppercase tracking-wider mt-0.5 text-slate-400">Sistem Apotek</p></div>
                                            <Icon name="chevron-down" className={`text-xs text-slate-400 transition-transform ${showStoreMenu ? 'rotate-180' : ''}`} />
                                        </button>
                                        {showStoreMenu && (
                                            <div className="absolute top-full left-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden fade-in z-[60]">
                                                <div className="p-2 border-b border-slate-50 bg-slate-50/50"><span className="text-[10px] font-bold text-slate-500 uppercase px-2">Pilih Profil Toko</span></div>
                                                <div className="max-h-48 overflow-y-auto">
                                                    {(settingsData.storeProfiles || [{id:'default', name: APP_NAME}]).map(profile => (
                                                        <button key={profile.id} onClick={() => handleSwitchStore(profile.id)} className={`w-full text-left px-4 py-3 text-sm font-bold flex items-center justify-between hover:bg-sky-50 transition-colors ${activeStoreId === profile.id ? 'text-sky-600 bg-sky-50' : 'text-slate-700'}`}>
                                                            <span className="truncate">{profile.name}</span>{activeStoreId === profile.id && <Icon name="check" className="text-xs" />}
                                                        </button>
                                                    ))}
                                                    {(settingsData.storeProfiles && settingsData.storeProfiles.length > 1) && (
                                                        <button onClick={() => handleSwitchStore('all_stores')} className={`w-full text-left px-4 py-3 text-sm font-bold flex items-center justify-between hover:bg-indigo-50 transition-colors border-t border-slate-100 ${activeStoreId === 'all_stores' ? 'text-indigo-600 bg-indigo-50' : 'text-slate-700'}`}>
                                                            <span className="truncate">Semua Toko (Gabungan)</span>{activeStoreId === 'all_stores' && <Icon name="check" className="text-xs" />}
                                                        </button>
                                                    )}
                                                </div>
                                                <button onClick={() => { setActiveTab('settings'); setShowStoreMenu(false); }} className="w-full text-left px-4 py-2 text-[10px] font-bold text-slate-400 hover:bg-slate-50 border-t border-slate-100">+ Kelola Toko di Pengaturan</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <button onClick={() => setIsSidebarOpen(false)} className="md:hidden text-slate-400 hover:text-slate-600 p-2"><Icon name="xmark" className="text-xl" /></button>
                            </div>
                            <nav className="space-y-2 flex-1">{menuItems.map(menu => (<button key={menu.id} onClick={(e) => handleNavClick(menu.id, e)} className={`w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-sm font-bold transition-all duration-300 relative overflow-hidden group ${activeTab === menu.id ? 'bg-slate-800 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-100'}`}><Icon name={menu.icon} className={`w-5 text-base ${activeTab === menu.id ? 'text-white' : 'text-slate-400'}`} /> {menu.label}</button>))}</nav>
                            <div className="mt-auto pt-6 border-t border-slate-100"><p className="text-[10px] text-center text-slate-400">Versi 25.13 (Buku Kas Multi Expense)</p></div>
                        </div>
                    </aside>
                    <main className="flex-1 md:ml-0 p-4 md:p-8 max-w-7xl mx-auto w-full mb-0 relative z-20">
                        {/* Mobile Header Updated with Notification Bell */}
                        <div className="md:hidden mb-6 flex items-center justify-between gap-4 relative z-30">
                            <div className="flex items-center gap-2">
                                <div className={`w-9 h-9 rounded-lg flex items-center justify-center text-white ${activeStoreId === 'all_stores' ? 'bg-indigo-600' : 'bg-sky-600'} shadow-md`}><Icon name="pills" /></div>
                                <h1 className="font-bold text-slate-800 text-lg">{currentProfile.name}</h1>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowNotifications(true)} className="w-10 h-10 bg-white/90 backdrop-blur-md rounded-xl text-slate-600 font-bold shadow-sm border border-slate-200 active:scale-95 transition-all flex items-center justify-center">
                                    <Icon name="bell" className="text-sky-600" />
                                </button>
                                <button onClick={() => setIsSidebarOpen(true)} className="bg-white/90 backdrop-blur-md px-4 py-2.5 rounded-xl text-slate-700 font-bold text-sm shadow-sm border border-slate-200 active:scale-95 transition-all flex items-center gap-2">
                                    <Icon name="bars" className="text-sky-600" /> Menu
                                </button>
                            </div>
                        </div>

                        {/* Desktop Header Notification Bell */}
                        <div className="hidden md:flex justify-end mb-4">
                             <button onClick={() => setShowNotifications(true)} className="bg-white px-4 py-2 rounded-xl text-slate-600 font-bold text-sm shadow-sm border border-slate-200 hover:bg-slate-50 transition-all flex items-center gap-2">
                                <Icon name="bell" className="text-sky-600" /> Aktivitas
                            </button>
                        </div>

                        {activeTab === 'home' && (<DashboardView items={inventoryData} settings={settingsData} onShowLowStock={() => { setActiveTab('list'); setShowOnlyLowStock(true); }} />)}
                        {activeTab === 'cashier' && (<CashierView items={inventoryData} user={user} showToast={showToast} settings={settingsData} onGenerateImage={handleGenerateImage} currentProfile={currentProfile} />)}
                        {activeTab === 'transfer' && (<TransferView items={rawInventory} settings={settingsData} showToast={showToast} currentProfile={currentProfile} user={user} />)}
                        {activeTab === 'history' && (<HistoryView user={user} showToast={showToast} settings={settingsData} onGenerateImage={handleGenerateImage} currentProfile={currentProfile} />)}
                        {activeTab === 'purchases' && (<PurchaseView user={user} showToast={showToast} />)}
                        {activeTab === 'cashbook' && (<CashBookView user={user} currentProfile={currentProfile} showToast={showToast} />)}
                        {activeTab === 'list' && (<ListView items={inventoryData} loading={loading} settings={settingsData} searchQuery={searchQuery} setSearchQuery={setSearchQuery} showOnlyLowStock={showOnlyLowStock} setShowOnlyLowStock={setShowOnlyLowStock} selectedRacks={selectedRacks} setSelectedRacks={setSelectedRacks} uniqueRacksData={uniqueRacksData} onCopySuccess={showToast} onEdit={(item) => { setFormData({...item}); setEditingItem(item); setActiveTab('add'); }} onDelete={(item) => setDeleteModal({ show: true, item: item })} onDeleteRack={(rackName) => setDeleteRackModal({ show: true, rackName })} currentProfile={currentProfile} />)}
                        {activeTab === 'add' && (<FormView formData={formData} setFormData={setFormData} onSubmit={handleSubmit} isEditing={!!editingItem} submitting={submitting} onCancel={() => { setEditingItem(null); setFormData({name:'', qty:'', unit:'Pcs', exp:'', rack:'', price:'', minStock: ''}); setActiveTab('list'); }} currentProfile={currentProfile} />)}
                        {activeTab === 'import' && (<BulkImportView user={user} onImportComplete={(count) => { showToast(`${count} Barang berhasil diimport`); setActiveTab('list'); }} currentProfile={currentProfile} settings={settingsData} />)}
                        {activeTab === 'settings' && (<SettingsView settings={settingsData} onSave={handleSaveSettings} loading={submitting} />)}
                    </main>
                    <ConfirmModal isOpen={deleteModal.show} title="Hapus Barang?" message={`"${deleteModal.item?.name}" akan dihapus permanen dari semua toko.`} onConfirm={handleDelete} onCancel={() => setDeleteModal({ show: false, item: null })} />
                    <ConfirmModal isOpen={deleteRackModal.show} title="Hapus Rak?" message={`Semua barang di Rak "${deleteRackModal.rackName}" akan di-reset lokasinya menjadi '-'.`} onConfirm={handleConfirmDeleteRack} onCancel={() => setDeleteRackModal({ show: false, rackName: null })} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
