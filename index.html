<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Kasir Toko Husna (Smart 2K)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 900: '#14532d' },
                        gold: { 100: '#fef9c3', 300: '#fde047', 400: '#facc15', 500: '#eab308', 600: '#ca8a04' },
                        husna: { light: '#0ea5e9', dark: '#0284c7', bg: '#f0f9ff' }
                    },
                    fontFamily: { sans: ['Inter', 'Plus Jakarta Sans', 'sans-serif'] },
                    boxShadow: { 'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)', 'glow': '0 0 15px rgba(14, 165, 233, 0.3)' },
                    animation: {
                        'sway': 'sway 3s ease-in-out infinite alternate',
                        'sway-slow': 'sway 4s ease-in-out infinite alternate-reverse',
                        'twinkle': 'twinkle 4s ease-in-out infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'type-reveal': 'typeReveal 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'pop-in': 'popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                    },
                    keyframes: {
                        typeReveal: { '0%': { width: '0%', opacity: '0' }, '100%': { width: '100%', opacity: '1' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.5)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    
    <!-- React & Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">

    <!-- Fuse.js -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>

    <!-- Firebase SDK (Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, writeBatch, query, orderBy, increment, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi dari User
        const userConfig = {
            apiKey: "AIzaSyAKhe3ILdMTN7Dn9Ao3MqlzW3s5hHUDB_c",
            authDomain: "toko-husna-c6415.firebaseapp.com",
            projectId: "toko-husna-c6415",
            storageBucket: "toko-husna-c6415.firebasestorage.app",
            messagingSenderId: "171239564619",
            appId: "1:171239564619:web:29972d886bd39f1559f4ce",
            measurementId: "G-4BKNYL5KFC"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userConfig;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Expose ke window
        window.db = db;
        window.auth = auth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.collection = collection;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.serverTimestamp = serverTimestamp;
        window.writeBatch = writeBatch;
        window.query = query;
        window.orderBy = orderBy;
        window.increment = increment; // Penting untuk Retur
        window.limit = limit;
        window.appId = appId;
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f9ff; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        .typing-dot { height: 6px; width: 6px; background-color: #0ea5e9; border-radius: 50%; display: inline-block; animation: typing 1.4s infinite ease-in-out both; margin: 0 2px; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.05); }
        
        /* Syaban Decorations Animations */
        @keyframes sway { from { transform: rotate(-5deg); } to { transform: rotate(5deg); } }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .islamic-pattern {
            background-color: #f0f9ff;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%230ea5e9' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .font-arab { font-family: 'Amiri', serif; }

        /* FIREWORKS STYLE */
        .firework-particle { position: fixed; pointer-events: none; border-radius: 50%; z-index: 9999; animation: firework-fade 1.5s ease-out forwards; }
        @keyframes firework-fade { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(0); opacity: 0; } }
        .type-effect-wrapper { display: inline-block; overflow: hidden; white-space: nowrap; vertical-align: bottom; max-width: 0; animation: revealText 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        @keyframes revealText { 0% { max-width: 0; opacity: 0; } 100% { max-width: 100%; opacity: 1; } }
        
        /* Checkmark Animation */
        .checkmark-circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 2; stroke-miterlimit: 10; stroke: #22c55e; fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .checkmark { width: 56px; height: 56px; border-radius: 50%; display: block; stroke-width: 2; stroke: #fff; stroke-miterlimit: 10; margin: 10% auto; box-shadow: inset 0px 0px 0px #22c55e; animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both; }
        .checkmark__check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
        @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 30px #22c55e; } }
    </style>
</head>
<body class="islamic-pattern relative">
    <div id="root" class="relative z-10"></div>

    <!-- React App (Babel) -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const APP_NAME = "Toko Husna";

        // --- BLUETOOTH PRINTER HELPERS ---
        const ESC = "\u001B";
        const GS = "\u001D";
        const INIT = ESC + "@";
        const ALIGN_CENTER = ESC + "a" + "\u0001";
        const ALIGN_LEFT = ESC + "a" + "\u0000";
        const BOLD_ON = ESC + "E" + "\u0001";
        const BOLD_OFF = ESC + "E" + "\u0000";
        const CUT = GS + "V" + "\u0042" + "\u0000";
        
        class ThermalPrinterEncoder {
            constructor() {
                this.buffer = [];
            }
            
            init() { this.buffer.push(INIT); return this; }
            alignCenter() { this.buffer.push(ALIGN_CENTER); return this; }
            alignLeft() { this.buffer.push(ALIGN_LEFT); return this; }
            bold(on = true) { this.buffer.push(on ? BOLD_ON : BOLD_OFF); return this; }
            text(str) { 
                // Simple replacement to clean text
                let clean = str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                this.buffer.push(clean); 
                return this; 
            }
            newline() { this.buffer.push("\n"); return this; }
            line(char = "-") { this.buffer.push(char.repeat(32)); this.buffer.push("\n"); return this; }
            feed(n = 2) { for(let i=0; i<n; i++) this.buffer.push("\n"); return this; }
            
            encode() {
                const combined = this.buffer.join("");
                const encoder = new TextEncoder();
                return encoder.encode(combined);
            }
        }

        // --- FIREWORKS UTILITY ---
        const triggerFireworks = (x, y) => {
            const colors = ['#0ea5e9', '#eab308', '#3b82f6', '#0284c7', '#f43f5e'];
            const particleCount = 20; 
            for (let i = 0; i < particleCount; i++) {
                const el = document.createElement('div');
                el.classList.add('firework-particle');
                const color = colors[Math.floor(Math.random() * colors.length)];
                const size = Math.random() * 6 + 4; 
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 4 + 2; 
                el.style.backgroundColor = color;
                el.style.width = `${size}px`;
                el.style.height = `${size}px`;
                el.style.left = `${x}px`;
                el.style.top = `${y}px`;
                document.body.appendChild(el);
                let posX = x, posY = y, velX = Math.cos(angle) * velocity, velY = Math.sin(angle) * velocity, gravity = 0.15, opacity = 1;
                const animate = () => {
                    velY += gravity; posX += velX; posY += velY; opacity -= 0.015; 
                    el.style.left = `${posX}px`; el.style.top = `${posY}px`; el.style.opacity = opacity;
                    if (opacity > 0) requestAnimationFrame(animate); else el.remove();
                };
                requestAnimationFrame(animate);
            }
        };

        const Icon = React.memo(({ name, type = "solid", className = "" }) => <i className={`fa-${type} fa-${name} ${className}`}></i>);

        // --- DEKORASI SYABAN ---
        const SyabanDecor = () => {
            return (
                <div className="fixed inset-0 pointer-events-none z-0 overflow-hidden">
                    <div className="absolute top-10 left-[10%] text-gold-400 text-[8px] animate-twinkle delay-100 opacity-60"><Icon name="star" /></div>
                    <div className="absolute top-20 left-[25%] text-gold-300 text-[6px] animate-twinkle delay-700 opacity-40"><Icon name="star" /></div>
                    <div className="absolute top-5 right-[15%] text-gold-500 text-[10px] animate-twinkle delay-300 opacity-70"><Icon name="star" /></div>
                    <div className="absolute -top-4 left-4 md:left-10 z-0 animate-sway origin-top">
                        <div className="h-16 md:h-24 w-[1px] bg-gold-400 mx-auto opacity-70"></div>
                        <div className="text-gold-500 text-3xl md:text-4xl drop-shadow-glow relative z-10"><Icon name="mosque" /></div>
                    </div>
                    <div className="absolute -top-8 right-16 md:right-32 z-0 animate-sway-slow origin-top hidden md:block">
                        <div className="h-32 w-[1px] bg-gold-400 mx-auto opacity-70"></div>
                        <div className="text-gold-600 text-2xl drop-shadow-md"><Icon name="star-and-crescent" /></div>
                    </div>
                    <div className="absolute top-12 right-4 md:right-10 opacity-20 text-gold-400 animate-float"><Icon name="moon" className="text-6xl md:text-8xl" /></div>
                </div>
            );
        };

        // --- UTILS ---
        const safeNumber = (val) => { if (!val) return 0; const num = parseFloat(val); return isNaN(num) ? 0 : num; };
        
        const formatRupiah = (angka) => {
            const num = safeNumber(angka);
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num).replace(/,00$/, '');
        };

        const isNewItem = (createdAt) => {
            if (!createdAt) return false;
            const date = createdAt.toDate ? createdAt.toDate() : new Date(createdAt);
            const now = new Date();
            const diffInMs = now - date;
            return diffInMs < (24 * 60 * 60 * 1000);
        };
        const formatDateIndo = (dateStr) => {
            if (!dateStr) return "-";
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: '2-digit' });
        };

        const Toast = ({ message, show, onClose, type = "success" }) => {
            if (!show) return null;
            const bgClass = type === "error" ? "bg-red-500" : "bg-slate-800";
            const iconName = type === "error" ? "circle-xmark" : "circle-check";
            return (
                <div className={`fixed bottom-10 left-1/2 -translate-x-1/2 z-[110] ${bgClass} text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 fade-in animate-bounce border-2 border-white/10`}>
                    <Icon name={iconName} className={type === "error" ? "text-white" : "text-brand-400"} />
                    <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "Ya, Hapus", confirmColor = "red", children }) => {
            if (!isOpen) return null;
            const btnColorClass = confirmColor === "red" ? "bg-red-500 hover:bg-red-600 shadow-red-200" : "bg-blue-600 hover:bg-blue-700 shadow-blue-200";
            const iconBg = confirmColor === "red" ? "bg-red-50 text-red-500" : "bg-blue-50 text-blue-500";
            const iconName = confirmColor === "red" ? "trash-can" : "check";
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm fade-in">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100 border border-gold-100">
                        <div className={`w-14 h-14 ${iconBg} rounded-full flex items-center justify-center mb-5 mx-auto`}><Icon name={iconName} className="text-2xl" /></div>
                        <h3 className="text-xl font-bold text-center text-slate-800 mb-2">{title}</h3>
                        <p className="text-slate-500 text-center text-sm mb-4 leading-relaxed">{message}</p>
                        
                        {children && <div className="mb-6">{children}</div>}

                        <div className="flex gap-3 mt-4">
                            <button onClick={onCancel} className="flex-1 py-3 rounded-xl border border-slate-200 text-slate-600 font-semibold text-sm hover:bg-slate-50 transition-colors">Batal</button>
                            <button onClick={onConfirm} className={`flex-1 py-3 rounded-xl ${btnColorClass} text-white font-semibold text-sm shadow-lg active:scale-95 transition-all`}>{confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- HELPERS FOR PRINTER (GLOBAL) ---
        const connectBluetooth = async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }]
                });
                const server = await device.gatt.connect();
                return device;
            } catch (error) {
                console.error(error);
                return null;
            }
        };

        const printReceipt = async (receipt, device) => {
            if (!device || !device.gatt.connected) {
                device = await connectBluetooth();
                if (!device) return false;
            }

            try {
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

                const encoder = new ThermalPrinterEncoder();
                encoder.init().alignCenter().bold(true).text(APP_NAME).newline()
                    .bold(false).text("Jl. Berkah No. 99, Indonesia").newline().line()
                    .alignLeft().text(`Tgl: ${new Date(receipt.date.seconds ? receipt.date.toDate() : receipt.date).toLocaleString('id-ID')}`).newline().line();
                
                receipt.items.forEach(item => {
                    const originalQty = item.cartQty;
                    const returnedQty = item.returnedQty || 0;
                    const validQty = originalQty - returnedQty;

                    if (validQty > 0) {
                        encoder.text(item.name).newline();
                        const qtyPrice = `${validQty} x ${formatRupiah(item.price).replace('Rp', '')}`;
                        const subTotal = formatRupiah(item.price * validQty).replace('Rp', '');
                        const spaces = 32 - qtyPrice.length - subTotal.length;
                        encoder.text(qtyPrice + " ".repeat(Math.max(1, spaces)) + subTotal).newline();
                    }
                });

                // Recalculate totals for receipt based on valid items
                const validTotal = receipt.items.reduce((acc, item) => acc + (item.price * (item.cartQty - (item.returnedQty || 0))), 0);

                encoder.line()
                    .bold(true).text("TOTAL      " + formatRupiah(validTotal).replace('Rp','')).newline()
                    .feed(2).alignCenter()
                    .text("Terima Kasih").newline()
                    .text(receipt.status === 'returned' ? "RETUR FULL" : (receipt.status === 'partial' ? "ADA RETUR SEBAGIAN" : "Barang tidak dapat ditukar")).newline()
                    .feed(3);

                await characteristic.writeValue(encoder.encode());
                return true;
            } catch (error) {
                console.error("Print Error", error);
                return false;
            }
        };


        // --- CASHIER COMPONENT ---
        const CashierView = ({ items, user, showToast }) => {
            const [isSessionActive, setIsSessionActive] = useState(false);
            const [search, setSearch] = useState('');
            const [cart, setCart] = useState([]);
            const [paymentAmount, setPaymentAmount] = useState('');
            
            // Checkout & Success Logic
            const [checkoutModal, setCheckoutModal] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [paymentSuccess, setPaymentSuccess] = useState(false);
            const [receiptData, setReceiptData] = useState(null);

            // Cancel Confirmation
            const [cancelModal, setCancelModal] = useState(false);

            // Bluetooth State (Local)
            const [btDevice, setBtDevice] = useState(null);
            
            // Pending Transaction State (Persistent via LocalStorage)
            const [pendingCarts, setPendingCarts] = useState(() => {
                const saved = localStorage.getItem('husna_pending_carts');
                return saved ? JSON.parse(saved) : [];
            });

            useEffect(() => {
                localStorage.setItem('husna_pending_carts', JSON.stringify(pendingCarts));
            }, [pendingCarts]);

            // Filter items for cashier search
            const fuse = useMemo(() => new Fuse(items, { keys: ['name', 'rack'], threshold: 0.3 }), [items]);
            
            const filteredItems = useMemo(() => {
                if (!search) return []; 
                return fuse.search(search).map(r => r.item).slice(0, 30);
            }, [items, search, fuse]);

            const addToCart = (item) => {
                if (safeNumber(item.qty) <= 0) {
                    showToast("Stok Habis!", "error");
                    return;
                }
                setCart(prev => {
                    const existing = prev.find(c => c.id === item.id);
                    if (existing) {
                        if (existing.cartQty >= item.qty) {
                            showToast("Stok tidak cukup!", "error");
                            return prev;
                        }
                        return prev.map(c => c.id === item.id ? { ...c, cartQty: c.cartQty + 1 } : c);
                    }
                    return [...prev, { ...item, cartQty: 1 }];
                });
            };

            const removeFromCart = (id) => setCart(prev => prev.filter(c => c.id !== id));

            const updateQty = (id, delta) => {
                setCart(prev => prev.map(c => {
                    if (c.id === id) {
                        const newQty = c.cartQty + delta;
                        if (newQty > c.qty) { showToast("Stok mentok!", "error"); return c; }
                        if (newQty < 1) return c;
                        return { ...c, cartQty: newQty };
                    }
                    return c;
                }));
            };

            const grandTotal = cart.reduce((acc, item) => acc + (safeNumber(item.price) * item.cartQty), 0);
            const change = safeNumber(paymentAmount) - grandTotal;

            // SMART MONEY SUGGESTIONS
            const getPaymentSuggestions = useMemo(() => {
                const suggestions = new Set();
                suggestions.add(grandTotal); 
                const next1k = Math.ceil(grandTotal / 1000) * 1000;
                if (next1k > grandTotal) suggestions.add(next1k);
                const next2k = Math.ceil(grandTotal / 2000) * 2000;
                if (next2k > grandTotal) suggestions.add(next2k);
                const next5k = Math.ceil(grandTotal / 5000) * 5000;
                if (next5k > grandTotal) suggestions.add(next5k);
                const next10k = Math.ceil(grandTotal / 10000) * 10000;
                if (next10k > grandTotal) suggestions.add(next10k);
                 const next50k = Math.ceil(grandTotal / 50000) * 50000;
                if (next50k > grandTotal) suggestions.add(next50k);
                const bills = [2000, 5000, 10000, 20000, 50000, 100000];
                bills.forEach(bill => {
                    if (bill > grandTotal) suggestions.add(bill);
                });
                return Array.from(suggestions).sort((a,b) => a-b).slice(0, 6);
            }, [grandTotal]);

            const handleBack = () => {
                if (cart.length > 0) {
                    const newPending = {
                        id: Date.now(),
                        date: new Date().toISOString(),
                        items: cart,
                        total: grandTotal
                    };
                    setPendingCarts(prev => [newPending, ...prev]);
                    showToast("Transaksi disimpan sementara", "success");
                }
                setIsSessionActive(false);
                setSearch('');
                setCart([]);
            };

            const confirmCancel = () => {
                setCart([]);
                setPaymentAmount('');
                setSearch('');
                setCancelModal(false);
                showToast("Transaksi dibatalkan & keranjang dikosongkan", "info");
            };

            const resumeTransaction = (pendingItem) => {
                setCart(pendingItem.items);
                setPendingCarts(prev => prev.filter(p => p.id !== pendingItem.id));
                setIsSessionActive(true);
            };

            const handleCheckout = async () => {
                if (!user) return;
                if (cart.length === 0) return;
                if (safeNumber(paymentAmount) < grandTotal) { showToast("Uang kurang!", "error"); return; }
                
                setIsProcessing(true);
                try {
                    const batch = window.writeBatch(window.db);
                    
                    // 1. Deduct stock from inventory
                    cart.forEach(item => {
                        const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', item.id);
                        batch.update(docRef, { 
                            qty: window.increment(-item.cartQty), 
                            updatedAt: window.serverTimestamp() 
                        });
                    });

                    // 2. Save Transaction History
                    const transactionRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'transactions');
                    const newTransaction = {
                        date: window.serverTimestamp(),
                        items: cart,
                        total: grandTotal,
                        pay: safeNumber(paymentAmount),
                        change: change,
                        status: 'success', // success, returned, partial
                        cashierName: user.email || 'Admin'
                    };
                    batch.set(window.doc(transactionRef), newTransaction);

                    await batch.commit();

                    setReceiptData({ ...newTransaction, date: new Date() }); // Local date for display
                    setPaymentSuccess(true);
                    showToast("Transaksi Berhasil!");
                } catch (error) {
                    console.error(error);
                    showToast("Transaksi Gagal", "error");
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleCloseSuccess = () => {
                setCheckoutModal(false);
                setPaymentSuccess(false);
                setReceiptData(null);
                setCart([]);
                setPaymentAmount('');
                setIsSessionActive(false); 
            };

            const handlePrintAction = async () => {
                const connected = await printReceipt(receiptData, btDevice);
                if (connected === true || typeof connected === 'object') {
                    if (typeof connected === 'object') setBtDevice(connected); // update if new device
                    showToast("Mencetak...");
                } else {
                    showToast("Gagal Cetak / Bluetooth Mati", "error");
                }
            };

            // START SCREEN & ACTIVE CASHIER SCREEN (SAME AS BEFORE)
            if (!isSessionActive) {
                return (
                    <div className="fade-in h-full overflow-y-auto pb-20 md:pb-0 flex flex-col items-center justify-center relative z-10">
                        <div className="w-full max-w-sm px-4 flex flex-col items-center">
                             {pendingCarts.length > 0 && (
                                <div className="w-full mb-8 fade-in">
                                    <div className="flex items-center justify-between mb-3 px-1">
                                        <div className="flex items-center gap-2"><Icon name="clock-rotate-left" className="text-sky-600" /><h3 className="font-bold text-slate-700 text-sm">Lanjutkan Transaksi</h3></div>
                                        <span className="text-[10px] bg-sky-100 text-sky-700 px-2 py-0.5 rounded-full font-bold">{pendingCarts.length} tertunda</span>
                                    </div>
                                    <div className="space-y-3">{pendingCarts.map(pending => (<button key={pending.id} onClick={() => resumeTransaction(pending)} className="w-full bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md hover:border-sky-300 transition-all flex items-center justify-between group relative overflow-hidden"><div className="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-sky-400 to-sky-600"></div><div className="text-left pl-2"><p className="font-black text-slate-800 text-lg">{formatRupiah(pending.total)}</p><p className="text-xs text-slate-500 font-medium mt-0.5">{pending.items.length} Barang â€¢ {new Date(pending.date).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}</p></div><div className="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-300 group-hover:bg-sky-50 group-hover:text-sky-600 transition-colors"><Icon name="chevron-right" /></div></button>))}</div>
                                </div>
                            )}
                            <button onClick={() => setIsSessionActive(true)} className="group relative w-full aspect-square md:aspect-video rounded-3xl border-4 border-dashed border-sky-300 bg-sky-50/50 hover:bg-sky-100 hover:border-sky-400 transition-all flex flex-col items-center justify-center gap-4 active:scale-95"><div className="w-20 h-20 rounded-full bg-white text-sky-500 shadow-soft flex items-center justify-center text-4xl group-hover:scale-110 transition-transform"><Icon name="cart-plus" /></div><div className="text-center"><h2 className="text-2xl font-black text-slate-700 group-hover:text-sky-700">+ Penjualan Baru</h2><p className="text-sm text-slate-500 font-medium mt-1">Klik untuk mulai transaksi kasir</p></div></button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fade-in h-full flex flex-col md:flex-row gap-4 pb-20 md:pb-0 relative z-10">
                    <div className="flex-1 flex flex-col h-full min-h-0">
                        <div className="flex items-center gap-3 mb-4"><button onClick={handleBack} className="w-10 h-10 rounded-xl bg-white text-slate-400 hover:text-sky-600 hover:border-sky-300 border border-slate-200 flex items-center justify-center shadow-sm transition-colors" title="Kembali & Simpan Sementara"><Icon name="arrow-left" /></button><div className="relative group flex-1"><input autoFocus type="text" placeholder="Ketik nama barang disini..." className="w-full pl-11 pr-4 py-3.5 rounded-2xl bg-white border border-slate-200 shadow-soft focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all font-bold text-lg text-slate-700 placeholder:font-normal placeholder:text-slate-400" value={search} onChange={e => setSearch(e.target.value)} /><Icon name="magnifying-glass" className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl group-focus-within:text-sky-500" /></div></div>
                        <div className="flex-1 overflow-y-auto custom-scrollbar pr-1 pb-2">
                            {search === '' ? (<div className="h-full flex flex-col items-center justify-center text-slate-400 opacity-60"><Icon name="magnifying-glass" className="text-6xl mb-4 text-slate-300" /><p className="font-semibold text-lg">Mulai ketik untuk mencari barang...</p><p className="text-xs mt-1">Hasil pencarian akan muncul di sini</p></div>) : (
                                <div className="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">{filteredItems.map(item => { const inCart = cart.find(c => c.id === item.id); const currentStock = safeNumber(item.qty) - (inCart ? inCart.cartQty : 0); const isOOS = currentStock <= 0; return (<button key={item.id} onClick={() => addToCart(item)} disabled={isOOS} className={`text-left p-3 rounded-xl border transition-all relative overflow-hidden group ${isOOS ? 'bg-slate-100 border-slate-200 opacity-70' : 'bg-white border-slate-200 hover:border-sky-300 hover:shadow-md'}`}>{isNewItem(item.createdAt) && !isOOS && <span className="absolute top-0 right-0 bg-rose-500 text-white text-[8px] font-bold px-1.5 rounded-bl-lg">NEW</span>}<h4 className="font-bold text-slate-800 text-xs line-clamp-2 h-8 leading-snug">{item.name}</h4><div className="mt-2 flex justify-between items-end"><div><p className="text-[10px] text-slate-500 font-medium">{item.unit}</p><p className="text-xs font-bold text-sky-600">{formatRupiah(item.price)}</p></div><div className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${isOOS ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-600'}`}>Stok: {currentStock}</div></div>{!isOOS && <div className="absolute inset-0 bg-sky-500/10 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"><Icon name="plus" className="text-sky-600 text-xl" /></div>}</button>)})}{filteredItems.length === 0 && <div className="col-span-full py-10 text-center text-slate-400 text-sm">Barang tidak ditemukan</div>}</div>
                            )}
                        </div>
                    </div>
                    <div className="w-full md:w-80 lg:w-96 flex flex-col bg-white rounded-3xl shadow-soft border border-slate-100 h-fit md:h-full max-h-[calc(100vh-100px)]">
                        <div className="p-4 border-b border-slate-100 bg-slate-50/50 rounded-t-3xl flex justify-between items-center"><h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="cart-shopping" className="text-sky-600" /> Keranjang</h3><span className="text-xs font-bold bg-sky-100 text-sky-700 px-2 py-1 rounded-full">{cart.length} Item</span></div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar min-h-[200px]">{cart.length === 0 ? (<div className="h-full flex flex-col items-center justify-center text-slate-300 opacity-60"><Icon name="basket-shopping" className="text-4xl mb-2" /><p className="text-xs font-medium">Keranjang Kosong</p></div>) : (cart.map(item => (<div key={item.id} className="p-3 bg-slate-50 rounded-xl border border-slate-100 flex gap-3 group"><div className="flex-1 min-w-0"><h4 className="text-xs font-bold text-slate-700 truncate">{item.name}</h4><p className="text-[10px] text-slate-500">{formatRupiah(item.price)} x {item.cartQty}</p></div><div className="flex flex-col items-end gap-1"><p className="text-xs font-bold text-slate-800">{formatRupiah(item.price * item.cartQty)}</p><div className="flex items-center gap-1 bg-white rounded-lg shadow-sm border border-slate-200 p-0.5"><button onClick={() => updateQty(item.id, -1)} className="w-5 h-5 flex items-center justify-center text-[8px] hover:bg-slate-100 rounded text-slate-500"><Icon name="minus" /></button><span className="text-xs font-bold w-4 text-center">{item.cartQty}</span><button onClick={() => updateQty(item.id, 1)} className="w-5 h-5 flex items-center justify-center text-[8px] hover:bg-slate-100 rounded text-slate-500"><Icon name="plus" /></button></div></div><button onClick={() => removeFromCart(item.id)} className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-[8px] opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center shadow-md"><Icon name="xmark" /></button></div>)))}</div>
                        <div className="p-4 border-t border-slate-100 bg-slate-50 rounded-b-3xl">
                            <div className="flex justify-between items-end mb-4"><span className="text-xs text-slate-500 font-medium">Total Tagihan</span><span className="text-xl font-black text-slate-800">{formatRupiah(grandTotal)}</span></div>
                            <button onClick={() => { setPaymentAmount(''); setCheckoutModal(true); }} disabled={cart.length === 0} className="w-full py-3.5 bg-gradient-to-r from-sky-600 to-sky-500 text-white rounded-xl font-bold shadow-lg shadow-sky-200 active:scale-95 transition-all disabled:opacity-50 disabled:scale-100 flex items-center justify-center gap-2"><Icon name="money-bill-wave" /> Bayar Sekarang</button>
                            {/* Tombol Batalkan Transaksi */}
                            <button onClick={() => setCancelModal(true)} disabled={cart.length === 0} className="w-full mt-3 py-3 rounded-xl border border-red-200 text-red-500 font-bold hover:bg-red-50 transition-all text-sm disabled:opacity-50 disabled:border-slate-200 disabled:text-slate-400 active:scale-95">Batalkan Transaksi</button>
                        </div>
                    </div>

                    {checkoutModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm fade-in">
                            {!paymentSuccess ? (
                                <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 relative">
                                    <button onClick={() => setCheckoutModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="xmark" /></button><h3 className="text-lg font-bold text-slate-800 mb-4 text-center">Pembayaran</h3>
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4"><div className="flex justify-between mb-2 text-sm text-slate-500"><span>Total Belanja</span><span className="font-bold text-slate-800">{formatRupiah(grandTotal)}</span></div><div className="h-px bg-slate-200 my-2"></div><label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Pilih Nominal Cepat</label><div className="grid grid-cols-2 gap-2 mb-4">{getPaymentSuggestions.map((amount, idx) => (<button key={idx} onClick={() => setPaymentAmount(amount.toString())} className={`py-2 px-1 rounded-lg text-xs font-bold border transition-all active:scale-95 ${safeNumber(paymentAmount) === amount ? 'bg-sky-600 text-white border-sky-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-sky-50 hover:border-sky-300'}`}>{amount === grandTotal ? 'Uang Pas' : formatRupiah(amount)}</button>))}</div><div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase">Atau Ketik Manual</label><div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm font-bold">Rp</span><input autoFocus type="number" className="w-full pl-10 pr-3 py-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none font-bold text-lg text-slate-800" placeholder="0" value={paymentAmount} onChange={e => setPaymentAmount(e.target.value)} /></div></div><div className={`mt-3 flex justify-between text-sm transition-colors ${change < 0 ? 'text-red-500' : 'text-green-600'}`}><span className="font-medium">Kembalian</span><span className="font-bold">{change < 0 ? '-' : formatRupiah(change)}</span></div></div>
                                    <button onClick={handleCheckout} disabled={change < 0 || isProcessing} className="w-full py-3.5 bg-sky-600 text-white rounded-xl font-bold shadow-lg disabled:opacity-50 disabled:bg-slate-400 flex justify-center items-center gap-2">{isProcessing ? <div className="typing-dot bg-white"></div> : <><Icon name="wallet" /> BAYAR</>}</button>
                                </div>
                            ) : (
                                <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-8 relative flex flex-col items-center text-center pop-in">
                                    <div className="w-24 h-24 relative mb-4"><svg className="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><circle className="checkmark__circle" cx="26" cy="26" r="25" fill="none"/><path className="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/></svg></div>
                                    <h2 className="text-2xl font-black text-slate-800 mb-1">Transaksi Selesai</h2><p className="text-slate-500 text-sm mb-8">Kembalian: <span className="font-bold text-slate-800">{formatRupiah(receiptData.change)}</span></p>
                                    <div className="w-full space-y-3"><button onClick={handlePrintAction} className="w-full py-3 rounded-xl bg-slate-800 text-white font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2"><Icon name="print" /> Cetak Bluetooth</button><button onClick={() => { window.open(`https://wa.me/?text=${encodeURIComponent(`*${APP_NAME}*\nTotal: ${formatRupiah(receiptData.total)}`)}`, '_blank'); }} className="w-full py-3 rounded-xl bg-[#25D366] text-white font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2"><Icon name="whatsapp" type="brands" /> Kirim Struk via WhatsApp</button><button onClick={handleCloseSuccess} className="w-full py-3 rounded-xl border-2 border-slate-100 text-slate-600 font-bold hover:bg-slate-50 active:scale-95 transition-all">Selesaikan Tanpa Struk</button></div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Konfirmasi Batalkan Transaksi */}
                    <ConfirmModal 
                        isOpen={cancelModal} 
                        title="Batalkan Transaksi?" 
                        message="Keranjang akan dikosongkan dan semua item akan dihapus dari sesi ini." 
                        onConfirm={confirmCancel} 
                        onCancel={() => setCancelModal(false)} 
                        confirmText="Ya, Batalkan"
                        confirmColor="red"
                    />
                </div>
            );
        };

        // --- UPDATED: HISTORY VIEW WITH DASHBOARD & PARTIAL RETURN ---
        const HistoryView = ({ user, showToast }) => {
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedTx, setSelectedTx] = useState(null);
            
            // Retur State
            const [returModal, setReturModal] = useState({ show: false, tx: null, item: null, index: -1 });
            const [qtyToRetur, setQtyToRetur] = useState(1);
            const [processingRetur, setProcessingRetur] = useState(false);
            
            const [btDevice, setBtDevice] = useState(null);
            const [selectedDate, setSelectedDate] = useState(new Date());

            useEffect(() => {
                if (!user) return;
                // Increase limit to 500 to cover more days for client-side filtering
                const q = window.query(
                    window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'transactions'),
                    window.orderBy('date', 'desc'),
                    window.limit(500) 
                );

                const unsub = window.onSnapshot(q, (snapshot) => {
                    setTransactions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                });
                return () => unsub();
            }, [user]);

            // Date Navigation Helpers
            const changeDate = (days) => {
                const newDate = new Date(selectedDate);
                newDate.setDate(selectedDate.getDate() + days);
                setSelectedDate(newDate);
            };

            const isSameDay = (d1, d2) => {
                return d1.getDate() === d2.getDate() &&
                       d1.getMonth() === d2.getMonth() &&
                       d1.getFullYear() === d2.getFullYear();
            };

            // Filter transactions for selected date
            const dailyTransactions = useMemo(() => {
                return transactions.filter(tx => {
                    const txDate = tx.date.seconds ? tx.date.toDate() : new Date(tx.date);
                    return isSameDay(txDate, selectedDate);
                });
            }, [transactions, selectedDate]);

            // Calculate Stats for Dashboard (Including Partial Returns)
            const stats = useMemo(() => {
                let grossSales = 0; // Total nilai awal transaksi (sebelum retur)
                let grossCount = 0;
                let returnsValue = 0; // Total nilai barang yang diretur (partial atau full)
                let returnTxCount = 0; // Jumlah transaksi yang ada returnya

                dailyTransactions.forEach(tx => {
                    // Hitung Gross Sales (Total asli saat transaksi dibuat)
                    const txGross = tx.items.reduce((sum, item) => sum + (item.price * item.cartQty), 0);
                    grossSales += txGross;
                    grossCount++;

                    // Hitung Return Value (Nilai barang yang sudah diretur)
                    let txReturnVal = 0;
                    let hasReturn = false;

                    tx.items.forEach(item => {
                        if (item.returnedQty && item.returnedQty > 0) {
                            txReturnVal += (item.returnedQty * item.price);
                            hasReturn = true;
                        } else if (tx.status === 'returned') {
                             // Fallback untuk backward compatibility (data lama yang statusnya returned tapi tidak ada returnedQty di item)
                             txReturnVal += (item.cartQty * item.price);
                             hasReturn = true;
                        }
                    });

                    returnsValue += txReturnVal;
                    if (hasReturn) returnTxCount++;
                });

                const netSales = grossSales - returnsValue; // Uang yang benar-benar diterima
                const avgSale = grossCount > 0 ? grossSales / grossCount : 0;

                return {
                    netSales,
                    grossSales,
                    grossCount,
                    returnsValue,
                    returnTxCount,
                    avgSale
                };
            }, [dailyTransactions]);

            const openReturModal = (tx, item, index) => {
                const alreadyReturned = item.returnedQty || 0;
                const maxRetur = item.cartQty - alreadyReturned;
                
                if (maxRetur <= 0) {
                    showToast("Barang ini sudah diretur semua", "error");
                    return;
                }

                setReturModal({ show: true, tx, item, index, max: maxRetur });
                setQtyToRetur(maxRetur); // Default ke max
            };

            const handleProcessRetur = async () => {
                const { tx, item, index, max } = returModal;
                if (!tx || !user) return;
                
                if (qtyToRetur <= 0 || qtyToRetur > max) {
                    showToast("Jumlah retur tidak valid", "error");
                    return;
                }

                setProcessingRetur(true);
                try {
                    const batch = window.writeBatch(window.db);
                    
                    // 1. Update Inventory (Kembalikan stok)
                    const invRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', item.id);
                    batch.update(invRef, { qty: window.increment(qtyToRetur) });

                    // 2. Update Transaction Item
                    const txRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'transactions', tx.id);
                    
                    // Clone items array to mutate
                    const updatedItems = [...tx.items];
                    const currentItem = updatedItems[index];
                    
                    // Add/Update returnedQty
                    currentItem.returnedQty = (currentItem.returnedQty || 0) + qtyToRetur;
                    updatedItems[index] = currentItem;

                    // Determine Status
                    let totalItemsCount = 0;
                    let totalReturnedCount = 0;
                    updatedItems.forEach(i => {
                        totalItemsCount += i.cartQty;
                        totalReturnedCount += (i.returnedQty || 0);
                    });

                    let newStatus = tx.status;
                    if (totalReturnedCount === totalItemsCount) {
                        newStatus = 'returned'; // Full Retur
                    } else if (totalReturnedCount > 0) {
                        newStatus = 'partial'; // Partial Retur
                    }

                    batch.update(txRef, { 
                        items: updatedItems,
                        status: newStatus,
                        returnedAt: window.serverTimestamp() // Update timestamp of last return
                    });

                    await batch.commit();
                    showToast(`Berhasil meretur ${qtyToRetur} ${item.unit}`, "success");
                    setReturModal({ show: false, tx: null, item: null, index: -1 });
                    setSelectedTx(null); // Close detail to refresh
                } catch (error) {
                    console.error("Retur error", error);
                    showToast("Gagal melakukan retur", "error");
                } finally {
                    setProcessingRetur(false);
                }
            };

            const handlePrint = async (tx) => {
                showToast("Menghubungkan printer...");
                const connected = await printReceipt(tx, btDevice);
                 if (connected === true || typeof connected === 'object') {
                    if (typeof connected === 'object') setBtDevice(connected); 
                } else {
                    showToast("Gagal Cetak", "error");
                }
            };

            return (
                <div className="fade-in pb-20 md:pb-0 h-full flex flex-col relative z-10">
                    <header className="mb-4 flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 className="text-2xl font-extrabold text-slate-800 tracking-tight">Riwayat Kasir</h2>
                            <p className="text-slate-500 text-xs mt-1">Laporan harian & retur</p>
                        </div>
                        <div className="flex items-center gap-3 bg-white p-1 rounded-xl border border-slate-200 shadow-sm self-start md:self-auto">
                            <button onClick={() => changeDate(-1)} className="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-slate-50 text-slate-500 transition-colors"><Icon name="chevron-left" /></button>
                            <div className="flex items-center gap-2 px-2 text-slate-700 font-bold text-sm min-w-[120px] justify-center">
                                <Icon name="calendar-days" className="text-sky-500" />
                                {selectedDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })}
                            </div>
                            <button onClick={() => changeDate(1)} disabled={isSameDay(selectedDate, new Date())} className="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-slate-50 text-slate-500 transition-colors disabled:opacity-30"><Icon name="chevron-right" /></button>
                        </div>
                    </header>

                    {/* DASHBOARD STATS */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        {/* Total Transaksi Kasir (Net) */}
                        <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                            <div className="flex items-center gap-1 mb-1 border-b-2 border-dashed border-slate-200 w-fit pb-0.5">
                                <h4 className="font-bold text-slate-800 text-sm">Total transaksi kasir</h4>
                                <Icon name="circle-question" className="text-[10px] text-sky-500 mb-2" />
                            </div>
                            <div className="text-2xl font-black text-slate-800 mt-2">{formatRupiah(stats.netSales)}</div>
                            <p className="text-xs text-slate-400 mt-1">Net setelah retur</p>
                        </div>

                        {/* Total Penjualan Kasir (Gross) */}
                        <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                            <div className="flex items-center gap-1 mb-1 border-b-2 border-dashed border-slate-200 w-fit pb-0.5">
                                <h4 className="font-bold text-slate-800 text-sm">Total penjualan kasir</h4>
                                <Icon name="circle-question" className="text-[10px] text-sky-500 mb-2" />
                            </div>
                            <div className="text-2xl font-black text-slate-800 mt-2">{formatRupiah(stats.grossSales)}</div>
                            <p className="text-xs text-slate-400 mt-1">Dari {stats.grossCount} transaksi</p>
                        </div>

                         {/* Total Retur */}
                         <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                            <div className="flex items-center gap-1 mb-1 border-b-2 border-dashed border-slate-200 w-fit pb-0.5">
                                <h4 className="font-bold text-slate-800 text-sm">Total retur kasir</h4>
                                <Icon name="circle-question" className="text-[10px] text-sky-500 mb-2" />
                            </div>
                            <div className="text-2xl font-black text-red-600 mt-2">-{formatRupiah(stats.returnsValue).replace('Rp','Rp ')}</div>
                            <p className="text-xs text-slate-400 mt-1">Dari {stats.returnTxCount} transaksi bermasalah</p>
                        </div>

                         {/* Rata-rata Penjualan */}
                         <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                            <h4 className="font-bold text-slate-800 text-sm mb-1">Rata-rata penjualan kasir</h4>
                            <div className="text-2xl font-black text-slate-800 mt-2">{formatRupiah(stats.avgSale)}</div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-3 pr-1">
                        {loading ? <div className="text-center py-10 text-slate-400"><div className="typing-dot bg-sky-500"></div> Loading...</div> : 
                        dailyTransactions.length === 0 ? (
                            <div className="text-center py-12 flex flex-col items-center opacity-60">
                                <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3"><Icon name="calendar-xmark" className="text-2xl text-slate-400" /></div>
                                <p className="font-semibold text-slate-500">Tidak ada transaksi</p>
                                <p className="text-xs text-slate-400">Pada tanggal ini</p>
                            </div>
                        ) :
                        dailyTransactions.map(tx => (
                            <div key={tx.id} onClick={() => setSelectedTx(tx)} className={`p-4 rounded-2xl border shadow-sm cursor-pointer transition-all hover:shadow-md ${tx.status === 'returned' ? 'bg-red-50 border-red-100 opacity-80' : 'bg-white border-slate-100 hover:border-sky-300'}`}>
                                <div className="flex justify-between items-start mb-2">
                                    <div>
                                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">{new Date(tx.date.seconds ? tx.date.toDate() : tx.date).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})} WIB</p>
                                        <h4 className={`font-black text-lg ${tx.status === 'returned' ? 'text-red-500 line-through' : 'text-slate-800'}`}>{formatRupiah(tx.total)}</h4>
                                    </div>
                                    {tx.status === 'returned' ? 
                                        <span className="bg-red-100 text-red-600 text-[10px] font-bold px-2 py-1 rounded-full">BATAL</span> : 
                                        (tx.status === 'partial' ? 
                                            <span className="bg-amber-100 text-amber-600 text-[10px] font-bold px-2 py-1 rounded-full">SEBAGIAN</span> : 
                                            <span className="bg-green-100 text-green-600 text-[10px] font-bold px-2 py-1 rounded-full">SUKSES</span>
                                        )
                                    }
                                </div>
                                <div className="text-xs text-slate-500 truncate">{tx.items.map(i => i.name).join(', ')}</div>
                                <div className="mt-3 flex justify-between items-center border-t border-dashed border-slate-200 pt-2">
                                    <span className="text-[10px] font-bold text-slate-400">{tx.items.length} Barang</span>
                                    <span className="text-[10px] text-sky-600 font-bold flex items-center gap-1">Lihat Detail <Icon name="chevron-right" /></span>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Detail Modal */}
                    {selectedTx && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm fade-in">
                            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md p-0 overflow-hidden flex flex-col max-h-[90vh]">
                                <div className="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                    <div><h3 className="font-bold text-slate-800">Detail Transaksi</h3><p className="text-[10px] text-slate-500">{selectedTx.id}</p></div>
                                    <button onClick={() => setSelectedTx(null)} className="w-8 h-8 rounded-full bg-white text-slate-400 hover:text-slate-600 flex items-center justify-center shadow-sm"><Icon name="xmark" /></button>
                                </div>
                                <div className="p-5 overflow-y-auto flex-1">
                                    <div className="space-y-4">
                                        {selectedTx.items.map((item, idx) => {
                                            const returnedQty = item.returnedQty || 0;
                                            const remainingQty = item.cartQty - returnedQty;
                                            const isFullyReturned = remainingQty === 0;

                                            return (
                                                <div key={idx} className={`p-3 rounded-xl border ${isFullyReturned ? 'bg-red-50 border-red-100' : 'bg-slate-50 border-slate-100'}`}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            <p className={`font-bold text-sm ${isFullyReturned ? 'text-red-600 line-through' : 'text-slate-700'}`}>{item.name}</p>
                                                            <p className="text-[10px] text-slate-500">{item.cartQty} x {formatRupiah(item.price)}</p>
                                                            {returnedQty > 0 && <span className="text-[9px] font-bold text-red-500 bg-red-100 px-1.5 py-0.5 rounded-sm">Sudah Retur: {returnedQty}</span>}
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="font-bold text-slate-800 text-sm">{formatRupiah(item.cartQty * item.price)}</p>
                                                            {selectedTx.status !== 'returned' && remainingQty > 0 && (
                                                                <button 
                                                                    onClick={() => openReturModal(selectedTx, item, idx)} 
                                                                    className="mt-2 bg-white border border-red-200 text-red-500 text-[10px] font-bold px-2 py-1 rounded-lg hover:bg-red-50 transition-colors shadow-sm"
                                                                >
                                                                    Retur Item
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <div className="my-4 border-t border-dashed border-slate-300"></div>
                                    <div className="flex justify-between text-sm mb-1"><span className="text-slate-500">Total</span><span className="font-bold text-slate-800">{formatRupiah(selectedTx.total)}</span></div>
                                    <div className="flex justify-between text-sm mb-1"><span className="text-slate-500">Bayar</span><span className="font-bold text-slate-800">{formatRupiah(selectedTx.pay)}</span></div>
                                    <div className="flex justify-between text-sm"><span className="text-slate-500">Kembali</span><span className="font-bold text-green-600">{formatRupiah(selectedTx.change)}</span></div>
                                </div>
                                <div className="p-5 bg-slate-50 border-t border-slate-100">
                                    <button onClick={() => handlePrint(selectedTx)} className="w-full py-3 rounded-xl bg-slate-800 text-white font-bold shadow-lg active:scale-95 text-sm flex items-center justify-center gap-2"><Icon name="print" /> Cetak Struk</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Retur Item Modal */}
                    <ConfirmModal 
                        isOpen={returModal.show} 
                        title="Retur Barang" 
                        message={`Berapa banyak "${returModal.item?.name}" yang ingin diretur?`} 
                        onConfirm={handleProcessRetur} 
                        onCancel={() => setReturModal({ show: false, tx: null, item: null, index: -1 })} 
                        confirmText={processingRetur ? "Memproses..." : "Konfirmasi Retur"}
                    >
                        {returModal.item && (
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <div className="flex items-center justify-between">
                                    <button onClick={() => setQtyToRetur(Math.max(1, qtyToRetur - 1))} className="w-10 h-10 bg-white border border-slate-300 rounded-lg flex items-center justify-center text-slate-500 hover:bg-slate-100"><Icon name="minus" /></button>
                                    <div className="flex flex-col items-center">
                                        <span className="text-2xl font-black text-slate-800">{qtyToRetur}</span>
                                        <span className="text-[10px] text-slate-400 font-bold uppercase">Maks: {returModal.max}</span>
                                    </div>
                                    <button onClick={() => setQtyToRetur(Math.min(returModal.max, qtyToRetur + 1))} className="w-10 h-10 bg-white border border-slate-300 rounded-lg flex items-center justify-center text-slate-500 hover:bg-slate-100"><Icon name="plus" /></button>
                                </div>
                                <div className="mt-3 text-center">
                                    <p className="text-xs text-slate-500">Nilai Pengembalian:</p>
                                    <p className="text-lg font-bold text-red-600">{formatRupiah(qtyToRetur * returModal.item.price)}</p>
                                </div>
                            </div>
                        )}
                    </ConfirmModal>
                </div>
            );
        };

        const BulkImportView = ({ onImportComplete, user }) => {
            const [textInput, setTextInput] = useState('');
            const [parsedItems, setParsedItems] = useState([]);
            const [step, setStep] = useState('input');
            const [isImporting, setIsImporting] = useState(false);
            const [progress, setProgress] = useState(0);

            const handleParse = () => {
                if (!textInput.trim()) return;
                const lines = textInput.split('\n');
                const results = [];
                lines.forEach((line) => {
                    if (!line.trim()) return;
                    let delimiter = ',';
                    if (line.includes('\t')) delimiter = '\t';
                    const parts = line.split(delimiter);
                    const name = parts[0]?.trim();
                    const qty = parts[1]?.trim() ? parseFloat(parts[1].trim().replace(',', '.')) : 0;
                    const unit = parts[2]?.trim() || 'Pcs';
                    const rack = parts[3]?.trim() || '-';
                    const exp = parts[4]?.trim() || '';
                    const price = parts[5]?.trim() ? parseFloat(parts[5].trim().replace(/[Rp.,]/g, '')) : 0;
                    
                    if (name) results.push({ name, qty: safeNumber(qty), unit, rack, exp, price: safeNumber(price) });
                });
                setParsedItems(results);
                setStep('preview');
            };

            const handleBulkSave = async () => {
                if (!user) return;
                setIsImporting(true);
                let successCount = 0;

                try {
                    const batchSize = 400;
                    const chunks = [];
                    for (let i = 0; i < parsedItems.length; i += batchSize) {
                        chunks.push(parsedItems.slice(i, i + batchSize));
                    }

                    const collectionRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory');

                    for (let i = 0; i < chunks.length; i++) {
                        const batch = window.writeBatch(window.db);
                        chunks[i].forEach(item => {
                            const docRef = window.doc(collectionRef);
                            batch.set(docRef, {
                                name: item.name,
                                qty: item.qty,
                                unit: item.unit,
                                rack: item.rack,
                                exp: item.exp,
                                price: item.price,
                                createdAt: window.serverTimestamp(),
                                updatedAt: window.serverTimestamp()
                            });
                        });
                        
                        await batch.commit();
                        successCount += chunks[i].length;
                        setProgress(Math.round(((i + 1) / chunks.length) * 100));
                    }

                    setIsImporting(false);
                    onImportComplete(successCount);
                    setTextInput(''); setParsedItems([]); setStep('input'); setProgress(0);
                } catch (error) {
                    console.error("Bulk Import Error:", error);
                    setIsImporting(false);
                    alert("Terjadi kesalahan saat import data.");
                }
            };

            const exampleText = `Amoxsan 500mg, 10, Box, A-1, , 50000\nParacetamol Sirup, 5, Botol, B-2, 2024-12-31, 15000\nVitamin C IPI, 50, Botol, Kasir, , 8000`;

            return (
                <div className="fade-in max-w-2xl mx-auto w-full pt-4 md:pt-10">
                    <div className="bg-white/80 backdrop-blur-md p-6 rounded-[30px] shadow-soft border border-white">
                        <header className="mb-6 flex items-center gap-4">
                            <div className="w-12 h-12 bg-sky-50 text-sky-600 rounded-2xl flex items-center justify-center text-xl shadow-sm"><Icon name="file-import" /></div>
                            <div><h2 className="text-xl font-bold text-slate-800">Import Masal</h2><p className="text-xs text-slate-400">Copy-Paste dari Excel atau ketik list manual</p></div>
                        </header>
                        
                        {step === 'input' ? (
                            <div className="space-y-4">
                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 text-xs text-slate-600"><p className="font-bold mb-1">Format (Excel/Tab atau Koma):</p><code className="block bg-slate-100 p-2 rounded text-slate-800 font-mono border border-slate-200">Nama, Qty, Satuan, Rak, Exp, Harga</code><button onClick={() => setTextInput(exampleText)} className="mt-2 text-[10px] font-bold text-sky-500 hover:underline">+ Pakai Contoh Format</button></div>
                                <textarea className="w-full h-48 p-4 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-2 focus:ring-sky-200 outline-none text-sm font-mono whitespace-pre" placeholder={`Paste data Excel di sini...\nContoh:\nPanadol, 10, strip, A1, , 10000`} value={textInput} onChange={e => setTextInput(e.target.value)}></textarea>
                                <button onClick={handleParse} disabled={!textInput.trim()} className="w-full py-3.5 rounded-xl bg-sky-600 hover:bg-sky-700 text-white font-bold shadow-lg shadow-sky-200 active:scale-95 transition-all flex items-center justify-center gap-2 text-sm disabled:opacity-50 disabled:scale-100"><Icon name="magnifying-glass-chart" /> Analisa Data</button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center"><h3 className="font-bold text-slate-700">Preview ({parsedItems.length} Item)</h3><button onClick={() => setStep('input')} className="text-xs text-slate-400 font-medium hover:text-slate-600">Ubah Data</button></div>
                                <div className="max-h-64 overflow-y-auto border border-slate-200 rounded-xl bg-white custom-scrollbar">
                                    <table className="w-full text-left border-collapse">
                                        <thead className="bg-slate-50 sticky top-0"><tr><th className="p-3 text-[10px] font-bold text-slate-500 uppercase">Nama</th><th className="p-3 text-[10px] font-bold text-slate-500 uppercase">Qty</th><th className="p-3 text-[10px] font-bold text-slate-500 uppercase">Rak</th><th className="p-3 text-[10px] font-bold text-slate-500 uppercase">Harga</th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">{parsedItems.map((item, idx) => (<tr key={idx} className="text-xs text-slate-700 hover:bg-slate-50"><td className="p-3 font-medium">{item.name}</td><td className="p-3 font-bold">{item.qty} {item.unit}</td><td className="p-3 text-slate-500">{item.rack}</td><td className="p-3 text-slate-500">{formatRupiah(item.price)}</td></tr>))}</tbody>
                                    </table>
                                </div>
                                {isImporting ? (<div className="space-y-2"><div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-sky-500 transition-all duration-300" style={{ width: `${progress}%` }}></div></div><p className="text-center text-xs text-slate-500 font-medium">Menyimpan ke Cloud... {progress}%</p></div>) : (<div className="flex gap-3"><button onClick={() => setStep('input')} className="flex-1 py-3 rounded-xl border border-slate-200 text-slate-600 font-bold text-sm">Kembali</button><button onClick={handleBulkSave} className="flex-1 py-3 rounded-xl bg-sky-600 hover:bg-sky-700 text-white font-bold shadow-lg shadow-sky-200 active:scale-95 transition-all text-sm">Simpan ke Database</button></div>)}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const DashboardView = ({ items, onShowLowStock }) => {
            const lowStockCount = items.filter(i => safeNumber(i.qty) < 5).length;
            const totalStock = items.reduce((a,b)=> a + safeNumber(b.qty), 0);
            
            const expiringItems = useMemo(() => {
                const today = new Date(); today.setHours(0,0,0,0);
                const threeMonthsLater = new Date(today); threeMonthsLater.setMonth(today.getMonth() + 3);
                return items.filter(i => { if (!i.exp) return false; const expDate = new Date(i.exp); return expDate <= threeMonthsLater; }).sort((a,b) => new Date(a.exp) - new Date(b.exp));
            }, [items]);

            const getDaysRemaining = (dateStr) => { const today = new Date(); today.setHours(0,0,0,0); const exp = new Date(dateStr); return Math.ceil((exp - today) / (1000 * 60 * 60 * 24)); };

            return (
                <div className="space-y-6 fade-in pb-24 md:pb-0">
                    <div className="bg-gradient-to-r from-slate-900 to-sky-900 rounded-3xl p-5 md:p-6 text-white relative overflow-hidden shadow-2xl border border-slate-700 group">
                        <div className="absolute right-0 top-0 w-48 h-48 bg-gold-400 opacity-10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                        <div className="relative z-10 flex items-center justify-between">
                            <div><h3 className="font-arab text-2xl md:text-3xl text-gold-400 mb-1">Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ Ø´Ø¹Ø¨Ø§Ù†</h3><p className="text-xs md:text-sm text-slate-300 font-medium opacity-90">Selamat Datang Bulan Sya'ban, Menuju Ramadhan</p><div className="mt-3 inline-flex items-center gap-2 bg-green-500/20 px-3 py-1 rounded-full backdrop-blur-sm border border-green-500/30"><div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div><span className="text-[10px] font-bold tracking-wide text-green-300">ONLINE (FIREBASE)</span></div></div>
                            <div className="text-4xl text-gold-500/80 animate-pulse"><Icon name="mosque" /></div>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-2 lg:grid-cols-3 gap-4 relative z-10">
                        <div className="bg-white/80 backdrop-blur-sm p-5 rounded-3xl shadow-soft border border-white relative overflow-hidden group hover:bg-white transition-all">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform text-sky-600"><Icon name="box" className="text-5xl" /></div>
                            <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Total Item</p>
                            <h3 className="text-3xl font-black text-slate-800">{items.length}</h3>
                        </div>
                        
                        <div className="bg-white/80 backdrop-blur-sm p-5 rounded-3xl shadow-soft border border-white relative overflow-hidden group hover:bg-white transition-all">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform text-slate-500"><Icon name="layer-group" className="text-5xl" /></div>
                            <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Total Unit</p>
                            <h3 className="text-3xl font-black text-slate-800">{totalStock}</h3>
                        </div>

                        <button onClick={onShowLowStock} className="col-span-2 lg:col-span-1 bg-gradient-to-r from-white to-amber-50/50 backdrop-blur-sm p-5 rounded-3xl shadow-soft border border-white text-left hover:border-amber-300 transition-all group relative overflow-hidden">
                            <div className="flex items-center justify-between relative z-10">
                                <div>
                                    <div className="flex items-center gap-2 mb-1">
                                        <div className="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></div>
                                        <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Perlu Restock</p>
                                    </div>
                                    <h3 className="text-3xl font-black text-slate-800 flex items-baseline gap-2">{lowStockCount} <span className="text-sm font-medium text-slate-400">item</span></h3>
                                </div>
                                <div className="w-10 h-10 bg-amber-100 text-amber-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform shadow-sm"><Icon name="triangle-exclamation" className="text-lg" /></div>
                            </div>
                        </button>
                    </div>

                    <div className="bg-white/90 backdrop-blur-md rounded-[24px] border border-white shadow-soft overflow-hidden relative z-10">
                        <div className="p-5 border-b border-slate-50 flex items-center justify-between bg-white/50">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-lg bg-red-50 text-red-500 flex items-center justify-center"><Icon name="clock" /></div>
                                <div><h3 className="font-bold text-slate-800 text-sm">Mendekati Kadaluarsa</h3><p className="text-[10px] text-slate-400 font-bold uppercase tracking-wide">Estimasi &lt; 3 Bulan</p></div>
                            </div>
                            <span className="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-md">{expiringItems.length} Item</span>
                        </div>
                        <div className="max-h-[300px] overflow-y-auto custom-scrollbar p-2">
                            {expiringItems.length === 0 ? (<div className="py-10 text-center"><Icon name="calendar-check" className="text-4xl text-slate-200 mb-2" /><p className="text-slate-400 text-xs">Aman! Tidak ada barang expired dalam 3 bulan.</p></div>) : (
                                <div className="grid gap-2">{expiringItems.map((item, idx) => { 
                                    const daysLeft = getDaysRemaining(item.exp); 
                                    const isExpired = daysLeft < 0; 
                                    const isCritical = daysLeft < 30; 
                                    return (
                                        <div key={idx} className="flex items-center justify-between p-3 rounded-xl bg-slate-50 border border-slate-100 hover:bg-white hover:shadow-sm transition-all">
                                            <div className="flex items-center gap-3 min-w-0">
                                                <div className="min-w-0">
                                                    <h4 className="text-xs font-bold text-slate-700 truncate">{item.name}</h4>
                                                    <div className="flex items-center gap-2 mt-0.5">
                                                        <span className="text-[10px] text-slate-500 flex items-center gap-1"><Icon name="calendar" className="text-[8px]" /> {formatDateIndo(item.exp)}</span>
                                                        <span className="text-[10px] text-slate-400">â€¢ Rak {item.rack || '-'}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right flex-shrink-0 pl-2">
                                                <span className={`block text-[10px] font-bold ${isExpired ? 'text-red-600' : (isCritical ? 'text-amber-600' : 'text-slate-600')}`}>{isExpired ? 'SUDAH EXP' : `${daysLeft} Hari Lagi`}</span>
                                                <span className="text-[10px] font-medium text-slate-400">Stok: {item.qty}</span>
                                            </div>
                                        </div>
                                    )})}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ListView = ({ items, searchQuery, setSearchQuery, onEdit, onDelete, onDeleteRack, showOnlyLowStock, setShowOnlyLowStock, selectedRacks, setSelectedRacks, uniqueRacksData, onCopySuccess, loading }) => {
            const [isRackDropdownOpen, setIsRackDropdownOpen] = useState(false);
            const [rackSearch, setRackSearch] = useState('');
            const dropdownRef = useRef(null);
            
            const ITEMS_PER_PAGE = 20;
            const [displayedLimit, setDisplayedLimit] = useState(ITEMS_PER_PAGE);
            const loaderRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsRackDropdownOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const fuse = useMemo(() => new Fuse(items, {
                keys: ['name'],
                threshold: 0.3,
                ignoreLocation: true,
                minMatchCharLength: 2,
            }), [items]);

            const filteredItems = useMemo(() => {
                let result = items;
                if (searchQuery) {
                    result = fuse.search(searchQuery).map(({ item }) => item);
                }
                return result.filter(i => {
                    const matchesLowStock = showOnlyLowStock ? safeNumber(i.qty) < 5 : true;
                    let matchesRack = true;
                    if (selectedRacks.length > 0) {
                        const itemRackLower = (i.rack || '-').toLowerCase();
                        matchesRack = selectedRacks.some(selected => itemRackLower.includes(selected.toLowerCase()));
                    }
                    return matchesLowStock && matchesRack;
                });
            }, [items, searchQuery, showOnlyLowStock, selectedRacks, fuse]);

            useEffect(() => { setDisplayedLimit(ITEMS_PER_PAGE); }, [searchQuery, showOnlyLowStock, selectedRacks]);

            useEffect(() => {
                const observer = new IntersectionObserver((entries) => {
                    const target = entries[0];
                    if (target.isIntersecting && displayedLimit < filteredItems.length) {
                        setDisplayedLimit(prev => Math.min(prev + ITEMS_PER_PAGE, filteredItems.length + ITEMS_PER_PAGE));
                    }
                }, { root: null, rootMargin: "100px", threshold: 0.1 });
                if (loaderRef.current) observer.observe(loaderRef.current);
                return () => { if (loaderRef.current) observer.unobserve(loaderRef.current); }
            }, [filteredItems.length, displayedLimit]);

            const handleCopyToWA = () => {
                const now = new Date();
                const dateStr = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getFullYear()).slice(-2)}`;
                let title = APP_NAME;
                if (showOnlyLowStock) title += " (MENIPIS)";
                if (filteredItems.length === 0) { alert("Tidak ada data!"); return; }

                let text = `*[Stok ${title}]*\n*ðŸ—“ï¸${dateStr}*\n------------------\n\n`;
                
                const processItems = (itemList) => {
                    const itemsByRack = {};
                    itemList.forEach(item => {
                        let rackName = item.rack && item.rack.trim() !== '-' && item.rack.trim() !== '' ? item.rack.trim() : 'NO RACK';
                        let rackKey = rackName.toUpperCase();
                        if (!itemsByRack[rackKey]) { itemsByRack[rackKey] = { name: rackName, items: [] }; }
                        itemsByRack[rackKey].items.push(item);
                    });
                    let content = "";
                    Object.keys(itemsByRack).sort().forEach(key => {
                        const group = itemsByRack[key];
                        content += `*${group.name}*\n`;
                        group.items.forEach((item, idx) => { content += `${idx+1}. ${item.name} (${item.qty} ${item.unit})\n`; });
                        content += `\n`;
                    });
                    return content;
                };
                text += processItems(filteredItems);
                text = text.trimEnd() + `\n\nTotal Item: ${filteredItems.length}`;
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => onCopySuccess("Disalin! Tempel di WA.")).catch(() => fallbackCopy(text));
                } else { fallbackCopy(text); }
            };

            const fallbackCopy = (text) => {
                const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.select(); try { const successful = document.execCommand('copy'); if(successful) onCopySuccess("Disalin! Tempel di WA."); } catch (err) {} document.body.removeChild(textArea);
            };

            const debouncedSetSearchQuery = useMemo(() => {
                let timer;
                return (val) => { clearTimeout(timer); timer = setTimeout(() => setSearchQuery(val), 300); };
            }, []);

            const toggleRack = (rackName) => {
                setSelectedRacks(prev => {
                    if (prev.includes(rackName)) return prev.filter(r => r !== rackName);
                    return [...prev, rackName];
                });
            };

            const getRackLabel = () => {
                if (selectedRacks.length === 0) return "Semua Rak";
                if (selectedRacks.length === 1) return selectedRacks[0];
                return `${selectedRacks.length} Rak Terpilih`;
            };

            const filteredRacks = uniqueRacksData.filter(r => r.name.toLowerCase().includes(rackSearch.toLowerCase()));
            const displayedItems = filteredItems.slice(0, displayedLimit);

            return (
                <div className="space-y-4 fade-in h-full flex flex-col relative z-10">
                    <header className="flex flex-col md:flex-row md:items-end justify-between gap-3">
                        <div>
                            <h2 className="text-2xl font-extrabold text-slate-800 tracking-tight drop-shadow-sm">{showOnlyLowStock ? 'âš ï¸ Stok Menipis' : 'Daftar Barang'}</h2>
                            <p className="text-slate-500 text-xs mt-1">Stok: <b>{APP_NAME}</b> â€¢ Total: {filteredItems.length}</p>
                        </div>
                        <div className="flex flex-wrap gap-2 items-end">
                            <button onClick={handleCopyToWA} className="py-2 px-3 rounded-lg font-bold text-[10px] flex items-center gap-2 transition-all bg-[#25D366] hover:bg-[#128C7E] text-white shadow-md active:scale-95"><Icon name="whatsapp" type="brands" className="text-sm" /> Salin WA</button>
                            <button onClick={() => setShowOnlyLowStock(!showOnlyLowStock)} className={`py-2 px-3 rounded-lg font-bold text-[10px] flex items-center gap-2 transition-all border min-w-[90px] ${showOnlyLowStock ? 'bg-amber-50 border-amber-200 text-amber-700' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}><Icon name="filter" /> {showOnlyLowStock ? 'Reset Low' : 'Filter Low'}</button>

                            <div className="relative min-w-[140px] md:min-w-[160px]" ref={dropdownRef}>
                                <button onClick={() => setIsRackDropdownOpen(!isRackDropdownOpen)} className={`w-full py-2.5 px-3 rounded-lg border border-slate-200 bg-white text-[10px] font-bold text-slate-700 shadow-sm flex items-center justify-between transition-all ${isRackDropdownOpen ? 'ring-1 ring-sky-500' : ''}`}>
                                    <span className="truncate max-w-[100px]">{getRackLabel()}</span>
                                    <Icon name="chevron-down" className={`text-xs text-slate-400 ml-2 transition-transform ${isRackDropdownOpen ? 'rotate-180' : ''}`} />
                                </button>
                                {isRackDropdownOpen && (
                                    <div className="absolute top-full right-0 mt-2 w-[280px] md:w-72 bg-white rounded-xl shadow-2xl border border-slate-100 z-[60] overflow-hidden fade-in origin-top-right">
                                        <div className="p-3 border-b border-slate-50 sticky top-0 bg-white z-10">
                                            <div className="relative mb-2">
                                                <input autoFocus type="text" placeholder="Cari rak..." className="w-full pl-8 pr-8 py-2 rounded-lg bg-slate-50 border border-slate-200 text-xs font-medium focus:ring-2 focus:ring-sky-100 focus:border-sky-400 outline-none transition-all" value={rackSearch} onChange={(e) => setRackSearch(e.target.value)} />
                                                <Icon name="magnifying-glass" className="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-400" />
                                                {rackSearch && (<button onClick={() => setRackSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 w-5 h-5 flex items-center justify-center rounded-full text-slate-400 hover:bg-slate-200 hover:text-slate-600 transition-colors"><Icon name="xmark" className="text-[10px]" /></button>)}
                                            </div>
                                            <button onClick={() => setSelectedRacks([])} className="w-full py-1.5 text-[10px] font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 rounded-md transition-colors">Reset (Tampilkan Semua)</button>
                                        </div>
                                        <div className="max-h-[240px] overflow-y-auto custom-scrollbar p-1.5 space-y-0.5">
                                            {filteredRacks.map(rack => {
                                                const isSelected = selectedRacks.includes(rack.name);
                                                return (
                                                    <div key={rack.name} onClick={() => toggleRack(rack.name)} className={`group w-full text-left px-3 py-2.5 rounded-lg text-xs font-medium hover:bg-slate-50 transition-colors flex items-center justify-between cursor-pointer ${isSelected ? 'bg-sky-50/60' : ''}`}>
                                                        <div className="flex items-center gap-3 truncate flex-1">
                                                            <div className="relative w-4 h-4 flex-shrink-0">
                                                                <input type="checkbox" checked={isSelected} readOnly className="peer appearance-none w-4 h-4 border-2 border-slate-300 rounded checked:bg-sky-500 checked:border-sky-500 transition-all cursor-pointer" />
                                                                <Icon name="check" className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[10px] text-white opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity" />
                                                            </div>
                                                            <span className="truncate flex-1">{rack.name}</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            {rack.hasNew && (<span className="flex-shrink-0 bg-rose-500 text-white text-[8px] font-black px-1.5 py-0.5 rounded-sm animate-pulse">NEW</span>)}
                                                            <button onClick={(e) => { e.stopPropagation(); onDeleteRack(rack.name); }} className="w-6 h-6 flex items-center justify-center rounded text-slate-300 hover:text-red-500 hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100" title="Hapus Rak"><Icon name="trash-can" /></button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                            {filteredRacks.length === 0 && (<div className="flex flex-col items-center justify-center py-6 text-slate-400"><Icon name="box-open" className="text-xl mb-1 opacity-50" /><p className="text-[10px]">Rak tidak ditemukan</p></div>)}
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {selectedRacks.length > 0 && (<button onClick={() => setSelectedRacks([])} className="py-2 px-2.5 rounded-lg text-[10px] font-bold bg-slate-100 text-slate-600 hover:bg-slate-200 border border-slate-200">Reset</button>)}
                        </div>
                    </header>
                    
                    <div className="relative group z-10">
                        <input type="text" placeholder="Cari nama barang..." className="w-full pl-9 pr-3 py-3 rounded-xl border-0 bg-white/90 backdrop-blur-sm shadow-soft ring-1 ring-slate-100 outline-none transition-all placeholder:text-slate-400 font-medium text-sm focus:ring-2 focus:ring-sky-500" defaultValue={searchQuery} onChange={e => debouncedSetSearchQuery(e.target.value)} />
                        <Icon name="magnifying-glass" className="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-sm transition-colors group-focus-within:text-slate-600" />
                    </div>

                    <div className="flex-1 overflow-y-auto pb-32 pr-1 custom-scrollbar">
                        {loading ? (
                             <div className="flex flex-col items-center justify-center py-20"><div className="typing-dot bg-sky-500"></div><p className="text-xs text-slate-400 mt-2">Menghubungkan Database...</p></div>
                        ) : filteredItems.length === 0 ? (
                            <div className="flex flex-col items-center justify-center py-20 opacity-40"><div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3"><Icon name="box-open" className="text-2xl text-slate-400" /></div><p className="font-semibold text-slate-500 text-center text-sm">Tidak ada data</p></div>
                        ) : (
                            <>
                                <div className="space-y-2">
                                    {displayedItems.map((item, index) => {
                                        const isLow = safeNumber(item.qty) < 5;
                                        const isNew = isNewItem(item.createdAt);
                                        const animDelay = `${index * 50}ms`;
                                        const nameClass = searchQuery ? "type-effect-wrapper" : "";

                                        return (
                                            <div key={item.id + searchQuery} style={{ animationDelay: animDelay }} className={`slide-up bg-white/90 backdrop-blur-sm rounded-xl p-3 border shadow-sm transition-all card-hover group flex items-center justify-between gap-3 ${isLow ? 'border-amber-200 bg-amber-50/30' : 'border-slate-100 hover:border-slate-300'}`}>
                                                <div className="flex items-center gap-3 flex-1 min-w-0">
                                                    <div className={`w-9 h-9 flex-shrink-0 rounded-lg flex items-center justify-center text-sm shadow-sm ${isLow ? 'bg-amber-100 text-amber-600' : 'bg-sky-50 text-sky-600'}`}><Icon name={isLow ? 'triangle-exclamation' : 'pills'} /></div>
                                                    <div className="min-w-0">
                                                        <div className="flex items-center gap-2"><h4 className={`font-bold text-slate-800 text-xs truncate leading-snug ${nameClass}`}>{item.name}</h4>{isNew && <span className="bg-rose-500 text-white text-[8px] font-black px-1.5 py-0.5 rounded-sm animate-pulse shadow-sm">NEW</span>}</div>
                                                        <span className="inline-flex items-center gap-1 text-[9px] font-bold text-slate-400"><Icon name="location-dot" className="text-[8px]" /> {item.rack || '-'}</span>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-4 md:gap-8 flex-shrink-0">
                                                    <div className="text-right">
                                                        <p className="text-[8px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Stok</p>
                                                        <div className="flex items-baseline justify-end gap-1"><span className={`text-sm font-black ${isLow ? 'text-amber-600' : 'text-slate-800'}`}>{item.qty}</span><span className="text-[9px] font-semibold text-slate-500">{item.unit || 'Pcs'}</span></div>
                                                        {item.price > 0 && <div className="text-[10px] text-green-600 font-bold mt-0.5 bg-green-50 px-1.5 rounded-md inline-block">{formatRupiah(item.price)}</div>}
                                                    </div>
                                                </div>
                                                <div className="flex gap-1.5 flex-shrink-0 pl-2 border-l border-slate-100 ml-1"><button onClick={() => onEdit(item)} className="w-7 h-7 rounded-lg text-[10px] bg-slate-50 text-slate-500 hover:bg-slate-100 hover:text-slate-800 border border-slate-200 transition-colors flex items-center justify-center"><Icon name="pen" /></button><button onClick={() => onDelete(item)} className="w-7 h-7 rounded-lg text-[10px] bg-white text-slate-400 hover:bg-red-50 hover:text-red-500 border border-slate-200 hover:border-red-200 transition-colors flex items-center justify-center"><Icon name="trash" /></button></div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div ref={loaderRef} className="h-10 flex items-center justify-center w-full mt-4 pb-20 md:pb-0">
                                    {displayedLimit < filteredItems.length ? (
                                        <div className="flex items-center gap-2 text-slate-400 text-xs"><div className="w-4 h-4 border-2 border-slate-300 border-t-sky-500 rounded-full animate-spin"></div><span>Memuat...</span></div>
                                    ) : filteredItems.length > 0 && ( <span className="text-[10px] text-slate-300">Semua data ditampilkan</span> )}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const FormView = ({ formData, setFormData, onSubmit, isEditing, onCancel, submitting }) => {
            const unitOptions = [
                "Pcs", "Box", "Botol", "Strip", "Tube", "Ampul", "Vial", 
                "Tablet", "Kapsul", "Sachet", "Pack", "Roll", "Set", 
                "Lembar", "Pasang", "Galon"
            ];
            
            return (
                <div className="fade-in max-w-xl mx-auto w-full pt-4 md:pt-10">
                    <div className="bg-white/90 backdrop-blur-sm p-6 md:p-8 rounded-[30px] shadow-soft border border-white">
                        <header className="mb-6 text-center">
                            <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-xl mx-auto mb-3 shadow-lg ${isEditing ? 'bg-slate-100 text-slate-600' : 'bg-sky-50 text-sky-600'}`}><Icon name={isEditing ? 'pen-to-square' : 'circle-plus'} /></div>
                            <h2 className="text-xl font-bold text-slate-800">{isEditing ? 'Edit Barang' : 'Input Baru'}</h2>
                            <p className="text-xs text-slate-400 mt-1">{isEditing ? 'Mengupdate data stok' : 'Menambahkan stok baru'}</p>
                        </header>
                        <form onSubmit={onSubmit} className="space-y-4">
                            <div className="space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Nama Produk</label><input className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white outline-none transition-all font-semibold text-sm text-slate-700 focus:border-slate-400" placeholder="Contoh: Paracetamol 500mg" value={formData.name || ''} onChange={e=>setFormData({...formData, name: e.target.value})} required /></div>
                            
                            <div className="grid grid-cols-2 gap-3">
                                 <div className="space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Harga Satuan (Rp)</label><input type="number" className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white outline-none transition-all font-bold text-sm text-slate-700 focus:border-slate-400" placeholder="0" value={formData.price || ''} onChange={e=>setFormData({...formData, price: e.target.value})} /></div>
                                 <div className="space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Lokasi Rak</label><input className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 outline-none font-medium text-sm transition-all focus:bg-white focus:border-slate-400" placeholder="Ex: A-01" value={formData.rack || ''} onChange={e=>setFormData({...formData, rack: e.target.value})} /></div>
                            </div>

                            <div className="grid grid-cols-5 gap-3">
                                <div className="col-span-3 space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Jumlah</label><div className="relative"><input type="number" step="any" className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white outline-none transition-all font-bold text-slate-700 text-sm focus:border-slate-400" value={formData.qty || ''} onChange={e=>setFormData({...formData, qty: e.target.value})} placeholder="0" /><div className="absolute right-3 top-1/2 -translate-y-1/2 flex flex-col gap-0.5"><button type="button" onClick={() => setFormData({...formData, qty: safeNumber(formData.qty)+1})} className="w-4 h-4 bg-white rounded shadow text-[8px] text-slate-500 hover:text-brand-600"><Icon name="chevron-up" /></button><button type="button" onClick={() => setFormData({...formData, qty: Math.max(0, safeNumber(formData.qty)-1)})} className="w-4 h-4 bg-white rounded shadow text-[8px] text-slate-500 hover:text-red-600"><Icon name="chevron-down" /></button></div></div></div>
                                <div className="col-span-2 space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Satuan</label><select className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 outline-none appearance-none font-medium text-sm text-slate-600 focus:border-slate-400" value={formData.unit || 'Pcs'} onChange={e=>setFormData({...formData, unit: e.target.value})}>{unitOptions.map(u => <option key={u} value={u}>{u}</option>)}</select></div>
                            </div>
                            
                             <div className="space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Kadaluarsa</label><input type="date" className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 outline-none font-medium text-sm transition-all focus:bg-white text-slate-600 focus:border-slate-400" value={formData.exp || ''} onChange={e=>setFormData({...formData, exp: e.target.value})} /></div>
                           
                            <div className="pt-4 flex gap-3">
                                {isEditing && (<button type="button" disabled={submitting} onClick={onCancel} className="flex-1 py-3.5 rounded-xl text-slate-600 font-bold bg-white border border-slate-200 hover:bg-slate-50 text-sm transition-colors">Batal</button>)}
                                <button type="submit" disabled={submitting} className={`flex-1 py-3.5 rounded-xl text-white font-bold shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 text-sm disabled:opacity-50 ${isEditing ? 'bg-slate-700 hover:bg-slate-800' : 'bg-sky-600 hover:bg-sky-700 shadow-sky-200'}`}>{submitting ? <div className="typing-dot bg-white" /> : <Icon name={isEditing ? 'check' : 'plus'} />} {submitting ? 'Menyimpan...' : (isEditing ? 'Simpan' : 'Tambah')}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [inventoryData, setInventoryData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('cashier'); // DEFAULT TAB KASIR
            const [searchQuery, setSearchQuery] = useState('');
            const [showOnlyLowStock, setShowOnlyLowStock] = useState(false);
            const [selectedRacks, setSelectedRacks] = useState([]);
            const [formData, setFormData] = useState({ name: '', qty: '', unit: 'Pcs', exp: '', rack: '', price: '' });
            const [editingItem, setEditingItem] = useState(null); 
            const [deleteModal, setDeleteModal] = useState({ show: false, item: null });
            const [deleteRackModal, setDeleteRackModal] = useState({ show: false, rackName: null });
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            const [submitting, setSubmitting] = useState(false);
            const [user, setUser] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);

            // --- FIREBASE INIT ---
            useEffect(() => {
                const initAuth = async () => {
                    if (window.initialAuthToken) {
                        await window.signInWithCustomToken(window.auth, window.initialAuthToken);
                    } else {
                        await window.signInAnonymously(window.auth);
                    }
                };
                initAuth();

                const unsubscribeAuth = window.onAuthStateChanged(window.auth, (currentUser) => {
                    setUser(currentUser);
                    if (!currentUser) setLoading(true);
                });
                return () => unsubscribeAuth();
            }, []);

            // --- FIRESTORE LISTENER ---
            useEffect(() => {
                if (!user) return;
                
                const q = window.query(
                    window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory')
                );

                const unsubscribeSnapshot = window.onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Sort locally
                    data.sort((a, b) => a.name.localeCompare(b.name));
                    setInventoryData(data);
                    setLoading(false);
                }, (error) => {
                    console.error("Firestore Error:", error);
                    showToast("Gagal memuat data live", "error");
                });

                return () => unsubscribeSnapshot();
            }, [user]);

            const uniqueRacksData = useMemo(() => {
                const rackMap = new Map();
                inventoryData.forEach(item => {
                    if (item.rack && item.rack !== '-') {
                        const racks = item.rack.split(',').map(r => r.trim());
                        let isItemNew = isNewItem(item.createdAt);
                        racks.forEach(r => {
                            if (!r) return;
                            if (!rackMap.has(r)) rackMap.set(r, { name: r, hasNew: false });
                            if (isItemNew) rackMap.get(r).hasNew = true;
                        });
                    }
                });
                return Array.from(rackMap.values()).sort((a, b) => a.name.localeCompare(b.name));
            }, [inventoryData]);

            const showToast = useCallback((message, type = "success") => {
                setToast({ show: true, message, type });
                setTimeout(() => setToast({ show: false, message: '', type: 'success' }), 3000);
            }, []);

            const handleSubmit = async (e) => {
                if (e) e.preventDefault();
                if (!formData.name?.trim() || !user) return;
                setSubmitting(true);

                try {
                    const collectionRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory');

                    if (editingItem) {
                        const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', editingItem.id);
                        await window.updateDoc(docRef, {
                            name: formData.name,
                            qty: safeNumber(formData.qty),
                            unit: formData.unit || 'Pcs',
                            rack: formData.rack || '-',
                            exp: formData.exp || '',
                            price: safeNumber(formData.price), // Simpan Harga
                            updatedAt: window.serverTimestamp()
                        });
                        showToast("Data diperbarui");
                    } else {
                        // Check duplicate name simply by array filter on client side for UX
                        const isExist = inventoryData.some(item => item.name.trim().toLowerCase() === formData.name.trim().toLowerCase());
                        if (isExist) {
                            showToast("Nama barang sudah ada!", "error");
                            setSubmitting(false);
                            return;
                        }

                        await window.addDoc(collectionRef, {
                            name: formData.name,
                            qty: safeNumber(formData.qty),
                            unit: formData.unit || 'Pcs',
                            rack: formData.rack || '-',
                            exp: formData.exp || '',
                            price: safeNumber(formData.price), // Simpan Harga
                            createdAt: window.serverTimestamp(),
                            updatedAt: window.serverTimestamp()
                        });
                        showToast("Barang ditambahkan");
                    }
                    
                    setEditingItem(null); 
                    setFormData({ name: '', qty: '', unit: 'Pcs', exp: '', rack: '', price: '' }); 
                    setActiveTab('list');

                } catch (error) { 
                    console.error("Error saving:", error); 
                    showToast("Gagal menyimpan ke database", "error"); 
                } 
                finally { setSubmitting(false); }
            };

            const handleDelete = async () => {
                if (!deleteModal.item || !user) return;
                try {
                    const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', deleteModal.item.id);
                    await window.deleteDoc(docRef);
                    showToast("Barang dihapus"); 
                } catch (error) { showToast("Gagal menghapus", "error"); } 
                finally { setDeleteModal({ show: false, item: null }); }
            };

            const handleConfirmDeleteRack = async () => {
                if (!deleteRackModal.rackName || !user) return;
                const rackName = deleteRackModal.rackName;
                try {
                    const batch = window.writeBatch(window.db);
                    const itemsToUpdate = inventoryData.filter(item => item.rack && item.rack.includes(rackName));
                    
                    if (itemsToUpdate.length === 0) {
                        showToast("Tidak ada item di rak ini");
                        setDeleteRackModal({ show: false, rackName: null });
                        return;
                    }

                    itemsToUpdate.forEach(item => {
                        const newRacks = item.rack.split(',').map(r => r.trim()).filter(r => r !== rackName);
                        const newRackString = newRacks.length > 0 ? newRacks.join(', ') : '-';
                        const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', item.id);
                        batch.update(docRef, { rack: newRackString });
                    });

                    await batch.commit();
                    showToast(`Rak "${rackName}" berhasil dihapus`); setSelectedRacks([]);
                } catch (err) { console.error("Failed delete rack", err); showToast("Gagal menghapus rak", "error"); } finally { setDeleteRackModal({ show: false, rackName: null }); }
            };

            const handleNavClick = (tabId, event) => {
                if (event) triggerFireworks(event.clientX, event.clientY);
                setActiveTab(tabId);
                if (tabId !== 'list') setShowOnlyLowStock(false);
                setIsSidebarOpen(false); // Close sidebar on selection (mobile)
            };

            // MENU ITEMS REORDERED
            const menuItems = [
                { id: 'cashier', label: 'Kasir', icon: 'cash-register' }, // Cashier First
                { id: 'history', label: 'Riwayat', icon: 'clock-rotate-left' }, // NEW
                { id: 'home', label: 'Dashboard', icon: 'chart-pie' },
                { id: 'list', label: 'Stok Barang', icon: 'boxes-stacked' },
                { id: 'add', label: 'Input Manual', icon: 'pen-to-square' },
                { id: 'import', label: 'Import Masal', icon: 'file-import' }
            ];

            return (
                <div className={`min-h-screen flex flex-col md:flex-row bg-sky-50/50 transition-colors duration-500`}>
                    <SyabanDecor /> 
                    <Toast show={toast.show} message={toast.message} type={toast.type} />
                    
                    {/* OVERLAY for Mobile */}
                    {isSidebarOpen && (
                        <div 
                            className="fixed inset-0 bg-slate-900/50 z-40 md:hidden backdrop-blur-sm fade-in"
                            onClick={() => setIsSidebarOpen(false)}
                        ></div>
                    )}

                    {/* SIDEBAR (Drawer Mode on Mobile, Fixed on Desktop) */}
                    <aside className={`fixed top-0 left-0 h-full z-50 w-72 md:w-80 bg-white/95 backdrop-blur-xl md:backdrop-blur-md border-r border-slate-200 md:border-white/20 shadow-2xl md:shadow-soft transform transition-transform duration-300 ease-in-out md:translate-x-0 md:static ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 pb-4 h-full flex flex-col">
                            <div className="flex items-center justify-between mb-8">
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-white shadow-lg transition-all duration-500 bg-sky-600`}><Icon name="shop" className="text-lg" /></div>
                                    <div><h1 className="font-black text-lg text-slate-800 leading-none tracking-tight">{APP_NAME}</h1><p className="text-[9px] font-bold uppercase tracking-widest mt-1 text-slate-400">Inventory App (Online)</p></div>
                                </div>
                                <button onClick={() => setIsSidebarOpen(false)} className="md:hidden text-slate-400 hover:text-slate-600 p-2"><Icon name="xmark" className="text-xl" /></button>
                            </div>
                            
                            <nav className="space-y-2 flex-1">
                                {menuItems.map(menu => (
                                    <button key={menu.id} onClick={(e) => handleNavClick(menu.id, e)} className={`w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-sm font-bold transition-all duration-300 relative overflow-hidden group ${activeTab === menu.id ? 'bg-slate-800 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-100'}`}><Icon name={menu.icon} className={`w-5 text-base ${activeTab === menu.id ? 'text-white' : 'text-slate-400'}`} /> {menu.label}</button>
                                ))}
                            </nav>
                            
                            <div className="mt-auto pt-6 border-t border-slate-100">
                                <p className="text-[10px] text-center text-slate-400">Versi 12.0 â€¢ Auto Reset</p>
                            </div>
                        </div>
                    </aside>

                    <main className="flex-1 md:ml-0 p-4 md:p-8 max-w-7xl mx-auto w-full mb-0 relative z-20">
                        {/* MOBILE HEADER with MENU Button */}
                        <div className="md:hidden mb-6 flex items-center justify-between gap-4 relative z-30">
                            <div className="flex items-center gap-2">
                                <div className="w-9 h-9 rounded-lg flex items-center justify-center text-white bg-sky-600 shadow-md"><Icon name="shop" /></div>
                                <h1 className="font-bold text-slate-800 text-lg">{APP_NAME}</h1>
                            </div>
                            <button 
                                onClick={() => setIsSidebarOpen(true)}
                                className="bg-white/90 backdrop-blur-md px-4 py-2.5 rounded-xl text-slate-700 font-bold text-sm shadow-sm border border-slate-200 active:scale-95 transition-all flex items-center gap-2"
                            >
                                <Icon name="bars" className="text-sky-600" /> Menu
                            </button>
                        </div>

                        {activeTab === 'home' && (<DashboardView items={inventoryData} onShowLowStock={() => { setActiveTab('list'); setShowOnlyLowStock(true); }} />)}
                        {activeTab === 'cashier' && (<CashierView items={inventoryData} user={user} showToast={showToast} />)}
                        {activeTab === 'history' && (<HistoryView user={user} showToast={showToast} />)}
                        {activeTab === 'list' && (<ListView items={inventoryData} loading={loading} searchQuery={searchQuery} setSearchQuery={setSearchQuery} showOnlyLowStock={showOnlyLowStock} setShowOnlyLowStock={setShowOnlyLowStock} selectedRacks={selectedRacks} setSelectedRacks={setSelectedRacks} uniqueRacksData={uniqueRacksData} onCopySuccess={showToast} onEdit={(item) => { setFormData({...item}); setEditingItem(item); setActiveTab('add'); }} onDelete={(item) => setDeleteModal({ show: true, item: item })} onDeleteRack={(rackName) => setDeleteRackModal({ show: true, rackName })} />)}
                        {activeTab === 'add' && (<FormView formData={formData} setFormData={setFormData} onSubmit={handleSubmit} isEditing={!!editingItem} submitting={submitting} onCancel={() => { setEditingItem(null); setFormData({name:'', qty:'', unit:'Pcs', exp:'', rack:'', price:''}); setActiveTab('list'); }} />)}
                        {activeTab === 'import' && (<BulkImportView user={user} onImportComplete={(count) => { showToast(`${count} Barang berhasil diimport`); setActiveTab('list'); }} />)}
                    </main>

                    <ConfirmModal isOpen={deleteModal.show} title="Hapus Barang?" message={`Yakin ingin menghapus permanen "${deleteModal.item?.name}"?`} onConfirm={handleDelete} onCancel={() => setDeleteModal({ show: false, item: null })} />
                    <ConfirmModal isOpen={deleteRackModal.show} title="Hapus Rak?" message={`Yakin ingin menghapus rak "${deleteRackModal.rackName}"? Semua barang di rak ini akan menjadi 'No Rack' (-).`} onConfirm={handleConfirmDeleteRack} onCancel={() => setDeleteRackModal({ show: false, rackName: null })} confirmText="Ya, Hapus Rak" />
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
